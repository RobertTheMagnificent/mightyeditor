function UTF8ArrToStr(t){return String.fromCharCode.apply(null,new Uint8Array(t))}function strToUTF8Arr(t){for(var e,i,s=t.length,o=0,a=0;s>a;a++)i=t.charCodeAt(a),o+=128>i?1:2048>i?2:65536>i?3:2097152>i?4:67108864>i?5:6;e=new Uint8Array(o);for(var n=0,h=0;o>n;h++)i=t.charCodeAt(h),128>i?e[n++]=i:2048>i?(e[n++]=192+(i>>>6),e[n++]=128+(63&i)):65536>i?(e[n++]=224+(i>>>12),e[n++]=128+(i>>>6&63),e[n++]=128+(63&i)):2097152>i?(e[n++]=240+(i>>>18),e[n++]=128+(i>>>12&63),e[n++]=128+(i>>>6&63),e[n++]=128+(63&i)):67108864>i?(e[n++]=248+(i>>>24),e[n++]=128+(i>>>18&63),e[n++]=128+(i>>>12&63),e[n++]=128+(i>>>6&63),e[n++]=128+(63&i)):(e[n++]=252+(i>>>30),e[n++]=128+(i>>>24&63),e[n++]=128+(i>>>18&63),e[n++]=128+(i>>>12&63),e[n++]=128+(i>>>6&63),e[n++]=128+(63&i));return e}window.MT=createClass("MT"),MT.namespace("ui"),MT.extend("core.Emitter").extend("ui.DomElement")(MT.ui.ColorPalette=function(t){MT.ui.DomElement.call(this);var e=this;this.addClass("ui-colorpalette"),this.nodes=[],this.createPalette(),this.el.onclick=function(i){t&&i.target.color&&(t(i.target.color),e.emit("change",i.target.color))}},{createPalette:function(){for(var t=this.el,e=null,i=[16711680,16776960,65280,65535,255,16711935,16711680],s="",o=2,a=3,n=-a;a>n;n++)for(var h=0,n=(i.length-1)*o;n>h;h++)e=document.createElement("span"),e.className="ui-colorpalette-node",t.appendChild(e),s=this.mkColor(0,16777215,h/(n-1),0),e.color=s,e.style.backgroundColor=s;e=document.createElement("div"),t.appendChild(e),e.className="seperator";for(var h=0;h<i.length-1;h++)for(var r=0;o>r;r++)e=document.createElement("span"),e.className="ui-colorpalette-node",t.appendChild(e),s=this.mkColor(i[h],i[h+1],r/o,0),e.color=s,e.style.backgroundColor=s;e=document.createElement("div"),t.appendChild(e),e.className="seperator";for(var n=-a;a+1>n;n++)if(0!=n){for(var h=0;h<i.length-1;h++)for(var r=0;o>r;r++)e=document.createElement("span"),e.className="ui-colorpalette-node",t.appendChild(e),s=this.mkColor(i[h],i[h+1],r/(o+1),n/(1.8*a)),e.color=s,e.style.backgroundColor=s;e=document.createElement("div"),t.appendChild(e)}},mutate:function(t,e,i,s){var o=255,a=(t>>16)+o*s,n=(t>>8&255)+o*s,h=(255&t)+o*s,r=(e>>16)+o*s,l=(e>>8&255)+o*s,c=(255&e)+o*s,d=i*r+(1-i)*a|0,u=i*l+(1-i)*n|0,p=i*c+(1-i)*h|0,m=0;d>o&&(m=(d-o)/o,p=p+p*m|0,u=u+u*m|0,d=o),p>o&&(m=(p-o)/o,d=d+d*m|0,u=u+u*m|0,p=o),u>o&&(m=(u-o)/o,d=d+d*m|0,p=p+p*m|0,u=o),u>o&&(u=o),p>o&&(p=o),d>o&&(d=o),0>d&&(m=-d/o,p=p-p*m|0,u=u-u*m|0,d=0),0>p&&(m=-p/o,d=d-d*m|0,u=u-u*m|0,p=0),0>u&&(m=-u/o,d=d-d*m|0,p=p-p*m|0,u=0);var f=d.toString(16);f.length<2&&(f="0"+f);var v=u.toString(16);v.length<2&&(v="0"+v);var g=p.toString(16);return g.length<2&&(g="0"+g),"#"+f+v+g},mkColor:function(t,e,i,s){var o=this.mutate(t,e,i,s);return o}}),MT.namespace("core"),MT(MT.core.Color=function(t){this.setColor(t)},{_r:0,set r(t){this._r=r,this.calcHSL()},get r(){return this._r},_g:0,set g(t){this._g=t,this.calcHSL()},get g(){return this._g},_b:0,set b(t){this._b=t,this.calcHSL()},get b(){return this._b},_h:0,set h(t){this._h=t,this.calcRGB()},get h(){return this._h},_s:0,set s(t){this._s=t,this.calcRGB()},get s(){return this._s},_l:0,set l(t){this._l=t,this.calcRGB()},get l(){return this._l},a:0,hsl:function(){return"hsl("+this.h+","+this.s+","+this.l+")"},inherit:function(t){this._r=t.r,this._g=t.g,this._b=t.b,this.calcHSL()},setColor:function(t){t=t.trim();var e;"string"==typeof t&&("#"==t.substring(0,1)?4==t.length?(e=t.substring(1,2),this._r=parseInt(e+e,16),e=t.substring(2,3),this._g=parseInt(e+e,16),e=t.substring(3,4),this._b=parseInt(e+e,16),this.a=1):t.length>6&&(this._r=parseInt(t.substring(1,3),16),this._g=parseInt(t.substring(3,5),16),this._b=parseInt(t.substring(5,7),16),this.a=9===t.length?parseInt(t.substring(7,2),16):1):"rgba"==t.substring(0,4)?(e=t.substring(t.indexOf("(")+1,t.indexOf(")")).split(","),this._r=parseInt(e[0]),this._g=parseInt(e[1]),this._b=parseInt(e[2]),this.a=parseInt(e[3])):"rgb"==t.substring(0,3)&&(e=t.substring(t.indexOf("(")+1,t.indexOf(")")).split(","),this._r=parseInt(e[0]),this._g=parseInt(e[1]),this._b=parseInt(e[2]),this.a=1)),this.calcHSL()},setRGB:function(t,e,i){this._r=t,this._g=e,this._b=i,this.calcHSL()},setHSL:function(t,e,i){this._h=t,this._s=i,this._l=i,this.calcHSL()},_hue2rgb:function(t,e,i){return 0>i&&(i+=1),i>1&&(i-=1),1/6>i?t+6*(e-t)*i:.5>i?e:2/3>i?t+(e-t)*(2/3-i)*6:t},valueOf:function(){return this.a<1?this.rgba():this.hex()},hex:function(){var t=this.r.toString(16),e=this.g.toString(16),i=this.b.toString(16);return t.length<2&&(t="0"+t),e.length<2&&(e="0"+e),i.length<2&&(i="0"+i),"#"+t+e+i},rgba:function(){return"rgba("+this._r+","+this._g+","+this._b+","+this.a+")"},rgb:function(){return"rgb("+this._r+","+this._g+","+this._b+")"},calcRGB:function(){var t,e,i,s=this._h,o=this._s,a=this._l;if(0==this.s)t=e=i=a;else{var n=.5>a?a*(1+o):a+o-a*o,h=2*a-n;t=this._hue2rgb(h,n,s+1/3),e=this._hue2rgb(h,n,s),i=this._hue2rgb(h,n,s-1/3)}this._r=Math.floor(255*t),this._g=Math.floor(255*e),this._b=Math.floor(255*i)},calcHSL:function(){var t,e,i=this.r/255,s=this.g/255,o=this.b/255,a=Math.max(i,s,o),n=Math.min(i,s,o),h=(a+n)/2;if(a==n)t=e=0;else{var r=a-n;switch(e=h>.5?r/(2-a-n):r/(a+n),a){case i:t=(s-o)/r+(o>s?6:0);break;case s:t=(o-i)/r+2;break;case o:t=(i-s)/r+4}t/=6}this._h=t,this._s=e,this._l=h}}),MT.namespace("ui"),MT(MT.ui.SliderHelper=function(t,e,i){this.min=e||0,this.max=i||100,this.value=t,this._value=0},{change:function(t){this._value+=t,this._value>=this.min&&this._value<=this.max?this.value=this._value:this._value>this.max?this.value=this.max:this._value<this.min&&(this.value=this.min)},changeTo:function(t){this.change(t-this._value)},valueOf:function(){return this.value},reset:function(t){void 0!=t?(this._value=t,this.value=t):this._value=this.value}}),MT.namespace("core"),MT(MT.core.BasicTool=function(t){this.tools=t,this.project=t.project},{initUI:function(t){var e=this;this.ui=t,this.tooltip=this.getTooltip(),this.button=this.tools.panel.addButton("","tool."+this.name,function(){e.tools.setTool(e)},this.tooltip)},showInfoToolTip:function(t,e){t=t||0;var i=this.tools.project.plugins;i.notification.showToolTips(this,t,e)},getTooltip:function(t){var e=(this.name||t)+"Tool";return e},init:function(){console.log("TODO: init"),this.activate()},activate:function(){},select:function(t){console.log("TODO: select",t)},mouseDown:function(){console.log("TODO: mousedown")},mouseUp:function(){console.log("TODO: mouseup")},mouseMove:function(){console.log("TODO: mouse move")},deactivate:function(){console.log("TODO: deactivate"),this.deinit()},deinit:function(){}}),MT.namespace("ui"),MT.require("ui.Button"),MT.require("ui.Input"),MT.require("ui.ColorPalette"),MT.extend("core.Emitter").extend("ui.Panel")(MT.ui.TextColorPicker=function(t){var e=this;this.data={stroke:"#000000",fill:"#000000",shadow:"#000000"},MT.ui.Panel.call(this,"",t.events),this.ui=t,this.removeHeader(),this.fill=new MT.ui.Button("Fill","ui-text-colorpicker-fill",null,function(){e.select("fill")}),this.fill.width="auto",this.stroke=new MT.ui.Button("Stroke","ui-text-colorpicker-stroke",null,function(){e.select("stroke")}),this.stroke.width="auto",this.shadow=new MT.ui.Button("Shadow","ui-text-colorpicker-shadow",null,function(){e.select("shadow")}),this.shadow.width="auto",this.addButton(this.fill),this.addButton(this.stroke),this.addButton(this.shadow),this.addClass("ui-text-colorpicker"),this.width=252,this.height=280,this.colorPalette=new MT.ui.ColorPalette(function(t){e.change(t)}),this.colorPalette.show(),this.colorPalette.on("hover",function(t){e.colorInput.setValue(t,!0)}),this.content.addChild(this.colorPalette),this.colorPalette.y=25,this.colorPalette.height=190,this.color="#000000",this.colorInput=new MT.ui.Input(t,{key:"color",type:"color"},this),this.colorInput.style.top="auto",this.colorInput.style.bottom="70px",this.colorInput.on("change",function(t){e.change(t)}),this.addChild(this.colorInput).show(),this.strokeThickness=0,this.strokeThicknessInput=new MT.ui.Input(t,{key:"strokeThickness",min:0,step:1},this),this.strokeThicknessInput.style.top="auto",this.strokeThicknessInput.style.bottom="50px",this.strokeThicknessInput.on("change",function(){e.change()}),this.shadowX=0,this.shadowXInput=new MT.ui.Input(t,{key:"shadowX",step:1},this),this.shadowXInput.style.top="auto",this.shadowXInput.style.bottom="50px",this.shadowXInput.on("change",function(){e.change()}),this.shadowY=0,this.shadowYInput=new MT.ui.Input(t,{key:"shadowY",step:1},this),this.shadowYInput.style.top="auto",this.shadowYInput.style.bottom="30px",this.shadowYInput.on("change",function(){e.change()}),this.shadowBlur=0,this.shadowBlurInput=new MT.ui.Input(t,{key:"shadowBlur",min:0,step:1},this),this.shadowBlurInput.style.top="auto",this.shadowBlurInput.style.bottom="10px",this.shadowBlurInput.on("change",function(){e.change()}),this.select("fill")},{setColors:function(t){this.colorInput.setValue(t[this.active],!0),this.data=t},change:function(t){t&&(this.colorInput.setValue(t),this.data[this.active]=t),this.color=this.data[this.active],this[this.active+"_change"]()},select:function(t){this.active&&(this[this.active].removeClass("active"),this[this.active+"_deselect"]()),this.active=t,this[t].addClass("active"),this[t+"_select"]()},fill_select:function(){this.colorInput.setValue(this.data.fill,!0)},fill_deselect:function(){},fill_change:function(){this.emit("fill",this.color)},stroke_select:function(){this.colorInput.setValue(this.data.stroke,!0),this.addChild(this.strokeThicknessInput).show()},stroke_deselect:function(){this.removeChild(this.strokeThicknessInput)},stroke_change:function(){this.emit("stroke",{color:this.color,strokeThickness:this.strokeThickness})},shadow_select:function(){this.colorInput.setValue(this.data.shadow,!0),this.addChild(this.shadowXInput).show(),this.addChild(this.shadowYInput).show(),this.addChild(this.shadowBlurInput).show()},shadow_deselect:function(){this.removeChild(this.shadowXInput),this.removeChild(this.shadowYInput),this.removeChild(this.shadowBlurInput)},shadow_change:function(){this.emit("shadow",{color:this.color,shadowBlur:this.shadowBlur,x:this.shadowX,y:this.shadowY})}}),MT.namespace("ui"),MT.require("ui.List"),MT.require("ui.Button"),MT.extend("core.Emitter")(MT.ui.Dropdown=function(t,e){this.options=t||{};var i=this,s=this.input=document.createElement("input");s.setAttribute("type","text"),s.className="ui-input ui-input-helper",s.onkeyup=function(e){if(e.which==MT.keys.ENTER){n.text=""!=this.value?this.value:this.oldValue;try{this.parentNode&&this.parentNode.removeChild(this)}catch(e){window.getSelection().removeAllRanges()}i.emit("change",n.text),t.onchange&&(i.hide(),t.onchange(n.text))}};var o=function(t){t.stopPropagation()};s.onmouseup=o,s.onmousedown=o,s.onclick=o;var a=null;t.list?(this.listSource="object"!=typeof t.list[0]?this.mkList(t.list):t.list,a=this.list=new MT.ui.List(this.listSource,e,!0),a.addClass("ui-dropdown-list"),a.panel.content.style.position="relative",a.on("show",function(){var e=n.el.getBoundingClientRect();a.style.top=e.top+e.height+"px",a.style.left=e.left+"px",a.el.offsetTop+a.panel.content.el.offsetHeight>window.innerHeight&&(a.style.top=e.top-a.panel.content.el.offsetHeight+"px"),t.listStyle&&(a.width=t.listStyle.width)}),a.on("hide",function(){i.hide()})):s.onblur=function(){i.hide()};var n=this.button=new MT.ui.Button(null,t.button["class"],e.events,function(){document.body.appendChild(s),a&&a.show(document.body);var t=n.el.getBoundingClientRect();s.style.top=t.top+"px",s.style.left=t.left+"px",s.style.width=t.width+"px",s.oldValue=n.text,s.value=n.text,n.text="",s.focus(),i.emit("show")});t.button.width&&(n.width=t.button.width),t.value&&(n.text=t.value)},{mkList:function(t){for(var e=[],i=0;i<t.length;i++)e.push(this.mkListItem(t[i]));return e},mkListItem:function(t){var e=this;return{label:t,cb:function(){e.value=t,e.emit("change",t)}}},set value(t){this.list.isVisible||(this.button.text=t),this.input.value=t},get value(){return this.button.text},addItem:function(t){this.list.addItem(t)},show:function(){this.emit("show")},hide:function(){this.emit("hide"),this.list&&this.list.hide(),this.input.parentNode&&this.input.parentNode.removeChild(this.input),this.button.text=this.input.value||this.input.oldValue}}),MT.namespace("ui"),MT.require("ui.SliderHelper"),MT.require("core.Color"),MT.extend("core.Emitter")(MT.ui.ColorPicker=function(t){this.ui=t,this.canvas=document.createElement("canvas"),this.canvas.width=230,this.canvas.height=200,this.canvas.style.margin="5px",this.ctx=this.canvas.getContext("2d"),this.cache=document.createElement("canvas"),this.cache.width=1,this.cacheCtx=this.cache.getContext("2d"),this.updateCache(),this.pickOffset=30,this.isBase=!1;var e=this,i=!1;this.panel=t.createPanel("color"),this.panel.setFree(),this.panel.content.el.appendChild(this.canvas),this.preview=document.createElement("div"),this.preview.style.width="20%",this.preview.style.height="20px",this.preview.style.marginLeft="5px",this.preview.style["float"]="left",this.preview.style.border="solid 1px rgba(0,0,0,0.5)",this.panel.content.el.appendChild(this.preview),this.text=document.createElement("span"),this.text.style.width="20%",this.text.style.height="20px",this.text.style.lineHeight="19px",this.text.style.marginLeft="5px",this.text.style["float"]="left",this.panel.content.el.appendChild(this.text),this.color=new MT.core.Color("#f00"),this.baseColor=new MT.core.Color("#f00"),this.drawSide(),this.drawBase("#F00"),this.input=document.createElement("input"),this.panel.el.appendChild(this.input),this.panel.width=this.canvas.width+2+10,this.panel.on("resize",function(){e.resize()}),this.baseHandle=new MT.ui.SliderHelper(0,0,this.canvas.height-1),this.handleX=new MT.ui.SliderHelper(0,0,this.canvas.width-this.pickOffset-1),this.handleY=new MT.ui.SliderHelper(0,0,this.canvas.height-1),t.events.on(t.events.MOUSEDOWN,function(t){return e.panel.vsPoint(t)?void(t.target===e.canvas&&(t.offsetX>e.canvas.width-e.pickOffset?(e.isBase=!0,e.baseHandle.reset(t.offsetY)):(e.handleX.reset(t.offsetX),e.handleY.reset(t.offsetY)),i=!0,t.preventDefault(),t.stopPropagation(),e.input.focus(),e.getColor(t.offsetX,t.offsetY))):(e.emit("change",e.color.valueOf()),void e.hide())});t.events.on(t.events.MOUSEMOVE,function(s){i&&(s.preventDefault(),s.stopPropagation(),e.isBase?(e.baseHandle.change(t.events.mouse.my),e.getColor(e.canvas.width-.5*e.pickOffset,e.baseHandle.value)):(e.handleX.change(t.events.mouse.mx),e.handleY.change(t.events.mouse.my),e.getColor(e.handleX.value,e.handleY.value)),e.input.focus())}),t.events.on(t.events.MOUSEUP,function(t){i&&(t.stopPropagation(),i=!1,e.isBase=!1,e.baseHandle.reset(),e.handleX.reset(),e.handleY.reset(),e.input.focus())},!0),e.input.onkeyup=function(t){return t.stopPropagation(),t.preventDefault(),t.which==MT.keys.ESC?(e.emit("change",e.startColor),e.setColor(e.startColor),void e.hide()):void(t.which==MT.keys.ENTER&&(e.emit("change",e.color.valueOf()),e.hide()))},this.panel.width=300,this.panel.height=200},{resize:function(){this.canvas.width=this.panel.width-12,this.canvas.height=this.panel.height-40-20,this.baseHandle.max=this.canvas.height-1,this.handleX.max=this.canvas.width-this.pickOffset-1,this.handleY.max=this.canvas.height-1,this._gradients.white=null,this._gradients.black=null,this.updateCache(),this.update()},getColor:function(){var t=null;this.isBase&&(t=this.cacheCtx.getImageData(0,this.baseHandle.value,1,1).data,this.baseColor.setRGB(t[0],t[1],t[2])),this.redraw(),t=this.ctx.getImageData(this.handleX.value,this.handleY.value,1,1).data,this.color.setRGB(t[0],t[1],t[2]),this.drawHandles(),this.preview.style.backgroundColor=this.color.valueOf(),this.text.innerHTML=this.color.valueOf(),this.emit("change",this.color.valueOf())},startColor:null,setColor:function(t){t=t||"#333",this.startColor=t,this.preview.style.backgroundColor=t,this.color.setColor(t),this.baseColor.inherit(this.color),this.baseColor.s=1,this.baseColor.l=.5,this.update()},update:function(){this.redraw(),this.baseHandle.reset(Math.floor((1-this.baseColor.h)*this.canvas.height));for(var t=2,e=this.ctx.getImageData(0,0,this.canvas.width-this.pickOffset,this.canvas.height).data,i=0;i<e.length;i+=4)if(Math.abs(e[i]-this.color.r)<t&&Math.abs(e[i+1]-this.color.g)<t&&Math.abs(e[i+2]-this.color.b)<t){if(Math.abs(e[i+4]-this.color.r)<t-1&&Math.abs(e[i+1+4]-this.color.g)<t-1&&Math.abs(e[i+2+4]-this.color.b)<t-1&&(t--,t>0))continue;this.handleX.reset(i/4%(this.canvas.width-this.pickOffset)),this.handleY.reset(Math.floor(i/4/(this.canvas.width-this.pickOffset)));break}this.drawHandles(),this.preview.style.backgroundColor=this.color.valueOf(),this.text.innerHTML=this.color.valueOf()},updateCache:function(){this.cache.height=this.canvas.height,this.drawSide(this.cacheCtx)},redraw:function(){this.drawSide(),this.drawBase(),this.drawGradient()},drawBase:function(){var t=this.canvas,e=this.ctx;e.fillStyle=this.baseColor.valueOf(),e.fillRect(0,0,t.width-this.pickOffset,t.height)},drawSide:function(t){t=t||this.ctx;var e=t.canvas;t.clearRect(0,0,e.width,e.height);var i=t.createLinearGradient(0,0,0,e.height);i.addColorStop(.01,"#F00"),i.addColorStop(.166,"#F0F"),i.addColorStop(.3333,"#00F"),i.addColorStop(.5,"#0FF"),i.addColorStop(.666,"#0F0"),i.addColorStop(.833,"#FF0"),i.addColorStop(1,"#F00"),t.fillStyle=i,t==this.ctx?t.fillRect(e.width-27,0,26,e.height):t.fillRect(0,0,e.width,e.height)},_gradients:{white:null,black:null},drawGradient:function(){var t=this.canvas,e=this.ctx;this._gradients.white||(this._gradients.white=e.createLinearGradient(0,0,t.width-30,0),this._gradients.white.addColorStop(.01,"rgba(255,255,255,1)"),this._gradients.white.addColorStop(.99,"rgba(255,255,255,0)"),this._gradients.black=e.createLinearGradient(0,0,0,t.height),this._gradients.black.addColorStop(.01,"rgba(0,0,0,0)"),this._gradients.black.addColorStop(.99,"rgba(0,0,0,1)")),e.fillStyle=this._gradients.white,e.fillRect(0,0,t.width-this.pickOffset,t.height),e.fillStyle=this._gradients.black,e.fillRect(0,0,t.width-this.pickOffset,t.height)},drawHandles:function(){this.ctx.strokeStyle="#000",this.ctx.strokeRect(this.canvas.width-29.5,this.baseHandle-2.5,29,4),this.ctx.beginPath(),this.ctx.arc(this.handleX+.5,this.handleY+.5,3,0,2*Math.PI),this.ctx.stroke(),this.ctx.strokeStyle="rgba(255, 255, 255, 0.5)",this.ctx.strokeWidth=.5,this.ctx.beginPath(),this.ctx.arc(this.handleX+.5,this.handleY+.5,2,0,2*Math.PI),this.ctx.stroke()},show:function(){this.panel.style.zIndex=10*this.ui.zIndex+9999,this.panel.show(),this.input.focus()},hide:function(){this.panel.hide(),this.input.blur(),this.off()}}),MT.namespace("ui"),MT.require("core.keys"),MT.extend("core.Emitter")(MT.ui.InputHelper=function(){var t=document.createElement("input");t.style.position="absolute",t.type="text",t.className="ui-input",t.isVisible=!1,t.style.textAlign="right",t.style.paddingRight="10px";var e=this;t.onblur=function(){e.emit("blur",t.value);var i=t.parentElement;i&&i.removeChild(t),e.el.style.visibility=""},t.onkeyup=function(i){var s=i.which;return console.log(s),s==MT.keys.ESC?void t.blur():(s==MT.keys.ENTER&&(t.blur(),e.emit("enter",i)),e.emit("change",t.value),void e.inheritStyle())},t.onkeydown=function(t){var i=t.which;i==MT.keys.TAB&&(t.preventDefault(),t.stopPropagation(),e.emit("tab",t))},this.input=t},{show:function(t,e){this.el&&(this.el.style.visibility="",this.el=null),void 0==e&&(e=t.innerHTML),this.el=t,this.inheritStyle(),this.input.value=e,t.style.visibility="hidden",document.body.appendChild(this.input),this.input.focus(),this.input.setSelectionRange(0,this.input.value.length)},blur:function(){this.input.blur()},inheritStyle:function(){var t=this.el.getBoundingClientRect();console.log(t);var e=window.getComputedStyle(this.el);for(var i in e)this.input.style[i]=e[i];this.input.style.zIndex=1e4,this.input.style.position="absolute",this.input.style.visibility="visible",this.input.style.top=t.top+"px",this.input.style.left=t.left+"px",this.input.style.width=t.width+1+"px",this.input.style.height=t.height+1+"px",this.input.style.paddingBottom="1px",this.input.style.paddingRight="1px"}}),MT.namespace("plugins.tools"),MT.extend("core.BasicTool")(MT.plugins.tools.Physics=function(t){this.tools=t,this.enabled=!1,this.name="physics"},{initUI:function(){var t=this;this.button=this.tools.panel.addButton("","tool.physics",function(){t.enabled?(t.enabled=!1,t.button.removeClass("active"),t.tools.project.plugins.mapeditor.disablePhysics()):(t.button.addClass("active"),t.enabled=!0,t.tools.project.plugins.mapeditor.enablePhysics())},this.getTooltip())}}),MT.namespace("plugins.tools"),MT.extend("core.BasicTool").extend("core.Emitter")(MT.plugins.tools.TileTool=function(t){MT.core.BasicTool.call(this,t),this.name="tileTools",this.active=null,this.activePanel=null,window.tileTool=this,this.panels={}},{initUI:function(t){MT.core.BasicTool.initUI.call(this,t),this.panel=this.tools.project.plugins.assetmanager.preview,this.selection=new MT.core.Selector,this.start=0,this.stop=0;var e=this;this.tools.on(MT.OBJECT_SELECTED,function(t){t&&t.type==MT.objectTypes.TILE_LAYER&&e._select(t)}),this.tools.on(MT.OBJECT_UNSELECTED,function(){e.tools.activeTool==e&&e.unselect()}),this.tools.on(MT.ASSET_FRAME_CHANGED,function(t){e.tools.activeTool==e&&(e.panels[t.id]||e.update(),e.activePanel=e.panels[t.id],e.activePanel.show())}),this.tools.map.on(MT.MAP_OBECTS_ADDED,function(t){e.tools.activeTool==e&&t.activeObject&&(e.select(t.activeObject),e.update())})},getImageFn:function(t){return function(){return t}},createPanels:function(t){var e,i,s=(this.active.data,null);for(var o in t)if(this.panels[o]){if(!map)continue;s=t[o],e=this.panels[o]}else e=this.addPanel(t[o],o),i&&e.addJoint(i),i=e;i&&(this.activePanel=i,i.show(this.panel.content.el))},addPanel:function(t,e){var i=new MT.ui.Panel(t.name);i.fitIn(),i.addClass("borderless"),this.createImage(i,t),this.panels[e]=i;var s=this;return i.on("show",function(){s.stop=s.getTile(0,0,i.data.image,i.data.data),s.activePanel=i}),i},createImage:function(t,e){var i=this,s=new Image;s.onload=function(){i.addCanvas(t,this),i.drawImage(t,this)},s.src=this.tools.project.path+"/"+e.__image,t.data={data:e,id:e.id,image:s,canvas:null,ctx:null}},addImage:function(t){for(var e=this.active.tilemap,i=0;i<e.tilesets.length;i++)if(e.tilesets[i].name==t.id)return e.tilesets[i].firstgid;for(var s=0,i=0;i<e.tilesets.length;i++)s+=e.tilesets[i].total+1;{var o=""+t.data.id;e.addTilesetImage(o,o,t.data.frameWidth,t.data.frameHeight,0,0,s)}return this.active.data.images||(this.active.data.images=[]),this.active.data.images.push(t.id),s},addCanvas:function(t,e){{var i=document.createElement("canvas"),s=i.getContext("2d");this.active.tilemap}i.width=e.width,i.height=e.height,t.data.canvas=i,t.data.ctx=s;var o=t.data.data;t.data.widthInTiles=e.width/o.frameWidth|0,t.data.heightInTiles=e.height/o.frameHeight|0;var a=!1,n=this;i.onmousedown=function(e){a=!0;var i=n.getTile(e.offsetX,e.offsetY,t.data.image,t.data.data);n.start=i,n.stop=i,n.drawImage(t)},i.onmousemove=function(e){if(a){var i=n.getTile(e.offsetX,e.offsetY,t.data.image,t.data.data);n.stop=i,n.drawImage(t)}},i.onmouseup=function(e){a=!1,n.stop=n.getTile(e.offsetX,e.offsetY,t.data.image,t.data.data),n.activePanel=t},t.content.el.appendChild(i)},addSelection:function(t){this.selection.add(t)},selectAdditionalTiles:function(){this.selection.min,this.selection.max},drawImage:function(t){var e=this,i=t.data.image,s=t.data.ctx;if(null!=s){var o,a,n=t.data.data,h=t.data.widthInTiles;s.clearRect(0,0,i.width,i.height),s.drawImage(i,0,0,i.width,i.height);{this.active.tilemap}s.beginPath();for(var r=n.frameWidth+n.margin;r<i.width;r+=n.frameWidth+n.spacing)s.moveTo(r+.5,n.margin),s.lineTo(r+.5,i.height);for(var r=n.frameHeight+n.margin;r<i.height;r+=n.frameHeight+n.spacing)s.moveTo(n.margin,r+.5),s.lineTo(i.width,r+.5);if(s.stroke(),s.fillStyle="rgba(0,0,0,0.5)",o=e.getTileX(this.start,h),a=e.getTileY(this.start,h),this.selection.clear(),this.start==this.stop)s.fillRect(n.margin+n.frameWidth*o+o*n.spacing+.5,n.margin+n.frameHeight*a+a*n.spacing+.5,n.frameWidth+.5,n.frameHeight+.5),this.selection.add({x:o,y:a,dx:0,dy:0});else{var l=e.getTileX(this.stop,h),c=e.getTileY(this.stop,h),d=Math.min(o,l),u=Math.min(a,c);l=Math.max(o,l),c=Math.max(a,c);for(var r=d;l>=r;r++)for(var p=u;c>=p;p++)s.fillRect(n.margin+n.frameWidth*r+r*n.spacing+.5,n.margin+n.frameHeight*p+p*n.spacing+.5,n.frameWidth+.5,n.frameHeight+.5),this.selection.add({x:r,y:p,dx:r-d,dy:p-u})}}},updatePreview:function(t){console.log("update"),console.log(this.panels),this.drawImage(this.panels[t.id])},getTileX:function(t,e){return t%e},getTileY:function(t,e){return t/e|0},getSelection:function(t,e){var i=t.data.image;return this.getTile(e.offsetX,e.offsetY,i,t.data.data)},getTile2:function(t,e,i,s){var o=(t+s.margin-s.spacing)/(s.frameWidth+s.spacing)|0,a=(e+s.margin-s.spacing)/(s.frameHeight+s.spacing)|0;return this.getId(o,a,i,s)},getTile:function(t,e,i,s){var o=t-s.margin,a=e-s.margin;0>o&&(o=0),0>a&&(a=0);var n=Math.floor(o/(s.frameWidth+s.spacing)),h=Math.floor(a/(s.frameHeight+s.spacing)),r=Math.floor(s.width/s.frameWidth),l=n+r*h;return console.log(l,"frame"),l},getId:function(t,e,i,s){var o=e*((i.width+s.spacing)/(s.frameWidth+s.spacing)),a=t+o|0;return a},mouseUp:function(t){t.target==this.tools.map.game.canvas&&(this.mDown=!1)},mouseDown:function(t){this.mDown=!0,this.putTileFromMouse(t)},mouseMove:function(t){this.mDown&&this.putTileFromMouse(t)},putTileFromMouse:function(t){if(t.target==this.tools.map.game.canvas){var e=this,i=this.active;if(i.isVisible){var s=(this.active.tilemap,this.tools.map.game.camera.scale.x),o=0,a=0;if(this.active&&this.active.game){var n=this.active.getBounds();if(n.contains(t.x-this.tools.map.ox,t.y-this.tools.map.oy)){this.active.fixedToCamera?(o=(t.x-this.active.x+this.tools.map.game.camera.x-this.tools.map.ox)/s,a=(t.y-this.active.y+this.tools.map.game.camera.y-this.tools.map.oy)/s):(o=(t.x-this.active.x-this.tools.map.offsetX)/s,a=(t.y-this.active.y-this.tools.map.offsetY)/s);var h=this.active.getTileXY(o,a,{});if(t.ctrlKey)return void e.putTile(null,h.x,h.y,i);if(this.activePanel){var r=this.addImage(this.activePanel.data),l=0;this.selection.forEach(function(t){l=e.getId(t.x,t.y,e.activePanel.data.image,e.activePanel.data.data),e.putTile(r+l,h.x+t.dx,h.y+t.dy,i)})}}}}}},putTile:function(t,e,i,s){s.data.tiles||(s.data.tiles={}),s.data.tiles[i]||(s.data.tiles[i]={}),s.data.tiles[i][e]=t,s.putTile(t,e,i),this.active&&(this.active.data.lastImage=this.activePanel.data.id),this.tools.project.plugins.objectmanager.sync()},oldSettings:{},init:function(){return this.active=this.tools.map.activeObject,this.active?(this.adjustSettings(this.active.data),this.panel.content.clear(),this.update(),this.panel.show(),void(this.activePanel&&(this.activePanel.hide(),this.activePanel.show()))):(this.tools.setTool(this.tools.tools.select,!0),this.showInfoToolTip(0,!0),void console.warn("not tilelayer selected!!!"))},restore:function(){this.oldSettings.gridX&&(this.tools.map.settings.gridX=this.oldSettings.gridX,this.tools.map.settings.gridY=this.oldSettings.gridY,this.tools.map.settings.gridOffsetX=0,this.tools.map.settings.gridOffsetY=0)},adjustSettings:function(t){this.restore(),this.tools.activeTool!=this&&(this.oldSettings.activeTool=this.tools.activeTool),this.oldSettings.gridX=this.tools.map.settings.gridX,this.oldSettings.gridY=this.tools.map.settings.gridY,this.tools.map.settings.gridX=t.tileWidth,this.tools.map.settings.gridY=t.tileHeight,this.tools.map.settings.gridOffsetX=t.x,this.tools.map.settings.gridOffsetY=t.y},unselect:function(){this.panel.content.clear(),this.restore(),this.tools.activeTool==this&&this.oldSettings.activeTool&&this.tools.activeTool!=this.oldSettings.activeTool?this.tools.setTool(this.oldSettings.activeTool,!0):this.tools.setTool(this.tools.tools.select,!0)},deactivate:function(){this.restore()},select:function(t){this._select(t)},_select:function(t){return t.type!=MT.objectTypes.TILE_LAYER?void this.restore():(this.active=this.tools.map.getById(t.id),this.tools.map.activeObject!=this.active?void this.restore():(this.tools.setTool(this),void(this.active&&(this.panel.show(),this.update()))))},activeImage:null,update:function(){var t=this.tools.project.plugins.assetmanager.list;if(this.active&&(this.createPanels(t),this.active.data.lastImage||this.active.data.images&&this.active.data.images.length&&(this.active.data.lastImage=this.active.data.images[0]),this.active.data.lastImage&&this.active.data.images&&this.active.data.images.length)){var e=this.panels[this.active.data.lastImage];e&&(this.activePanel=e,this.activePanel.show())}this.activePanel&&this.drawImage(this.activePanel)},updateLayer:function(t){var e=t.object,i=t.data;if(i.images&&0!=i.images.length){for(var s=e.map,o=0,a=null,n=this.tools.project.plugins.assetmanager.list,h=null,r=0;r<i.images.length;r++)h=n[i.images[r]],h?(a=s.addTilesetImage(h.id,h.id,h.frameWidth,h.frameHeight,h.margin,h.spacing,o),o+=a.total):(i.images.splice(r,1),r--);var l=i.tiles;for(var c in l)for(var d in l[c])l[c][d]>=s.tiles.length?(delete l[c][d],console.warn("tile out of range: ",l[c][d])):e.map.putTile(l[c][d],d,c,e);void 0!=i.alpha&&(e.alpha=i.alpha)}}}),MT.namespace("plugins.tools"),MT.require("ui.Dropdown"),MT.require("ui.TextColorPicker"),MT.extend("core.BasicTool").extend("core.Emitter")(MT.plugins.tools.Text=function(t){MT.core.BasicTool.call(this,t),this.name="text",this.isInitialized=!1;{var e=this;t.ui}this.tools=t,this.tester=document.createElement("span"),this.fonts=["Arial","Comic Sans MS","Courier New","Georgia","Impact","Times New Roman","Trebuchet MS","Verdana"],this.tools.on(MT.OBJECT_SELECTED,function(i){return t.map.selector.count>1?void e.panel.hide():void e.select(i)}),this.tools.on(MT.OBJECT_UNSELECTED,function(){e.panel.hide()});var i=this.tools.ui.events;i.on(i.KEYUP,function(t){var i=t.which;i==MT.keys.ESC&&e.textPopup.hide(!0)}),this.manager=this.tools.project.plugins.fontmanager;var s=function(){e.checkFonts(),e.tools.map.off(s)};this.tools.map.on(MT.MAP_OBECTS_ADDED,s),this.createPanel()},{createPanel:function(){var t=this,e=this.tools.ui;this.panel=e.createPanel("Text"),this.panel.style.height=this.project.panel.height+"px",this.panel.style.top=this.tools.map.panel.content.bounds.top+"px",this.panel.style.left=this.project.panel.width+"px",this.panel.addClass("text-tools"),this.panel.removeHeader(),this.panel.hide();for(var i=this.fonts,s=[],o=0;o<i.length;o++)s.push(this._mk_setFontSelect(i[o]));this.fontFace=new MT.ui.Dropdown({list:s,button:{"class":"text-font",width:"auto"},listStyle:{width:200},onchange:function(e){t.setFontFamily(e)}},e);for(var a=[10,11,12,14,18,24,26,28,30,32,36,48,60,72,96],n=[],o=0;o<a.length;o++)n.push(this._mk_setFontSizeSelect(a[o]));this.fontSize=new MT.ui.Dropdown({list:n,button:{"class":"text-size",width:"auto"},listStyle:{width:50},onchange:function(e){t.setFontSize(e)}},e),this.panel.addButton(this.fontFace.button),this.panel.addButton(this.fontSize.button),e.on(e.events.RESIZE,function(){t.panel.width=t.tools.map.panel.content.width,t.panel.height=30,t.panel.style.top=t.tools.map.panel.content.bounds.top+"px"}),this.bold=this.panel.addButton("B","text-bold",function(){t.toggleBold()}),this.bold.width="auto",this.italic=this.panel.addButton("I","text-italic",function(){t.toggleItalic()}),this.italic.width="auto",this.wordWrap=this.panel.addButton("Wx","text-wrap",function(){t.toggleWordWrap()}),this.wordWrap.width="auto",this.wordWrapWidth=new MT.ui.Dropdown({button:{"class":"word-wrap-width-size",width:"auto"},onchange:function(e){t.setWordWrapWidth(e)}},e),this.wordWrapWidth.on("show",function(){t.wordWrapWidth.button.el.removeAttribute("px")}),this.wordWrapWidth.on("hide",function(){t.wordWrapWidth.button.el.setAttribute("px","px")}),this.panel.addButton(this.wordWrapWidth.button),this.left=this.panel.addButton("L","text-left",function(){t.setAlign("left")}),this.left.width="auto",this.center=this.panel.addButton("C","text-center",function(){t.setAlign("center")
}),this.center.width="auto",this.right=this.panel.addButton("R","text-right",function(){t.setAlign("right")}),this.right.width="auto",this.colorButton=this.panel.addButton("C","text-color",function(){t.showColorPicker()}),this.colorButton.width="auto",this.colorPicker=new MT.ui.TextColorPicker(this.tools.ui),this.colorPicker.el.style.zIndex=3,this.panel.on("hide",function(){t.colorPicker.hide()}),this.colorPicker.on("fill",function(e){t.setFill(e)}),this.colorPicker.on("stroke",function(e){t.setStroke(e)}),this.colorPicker.on("shadow",function(e){t.setShadow(e)}),this.textButton=this.panel.addButton("txt","text-edit",function(){t.showTextEdit()}),this.textButton.width="auto",this.textPopup=new MT.ui.Popup("Edit Text",""),this.textPopup.hide(),this.textPopup.showClose(),this.textArea=document.createElement("textarea"),this.textPopup.content.appendChild(this.textArea),this.textArea.style.width="100%",this.textArea.style.height="200px";var h=function(t){t.stopPropagation()};this.textArea.onkeydown=h,this.textArea.onkeyup=h,this.textArea.onfocus=h,this.textArea.onmousedown=h,this.textArea.onmouseup=h,this.textPopup.addButton("Done",function(){t.setText(t.textArea.value),t.textPopup.hide()})},showColorPicker:function(){if(this.colorPicker.isVisible)return void this.colorPicker.hide();this.colorPicker.show(document.body);var t=this.colorButton.el.getBoundingClientRect();this.colorPicker.y=t.top+t.height,this.colorPicker.x=t.left,this.colorPicker.style.zIndex=10*this.ui.zIndex+1},_mk_setFontSelect:function(t){var e=this;return{label:t,cb:function(){e.setFontFamily(t)},create:function(e){e.style.fontFamily=t}}},_mk_setFontSizeSelect:function(t){var e=this;return{label:t,cb:function(){e.setFontSize(t)}}},showTextEdit:function(t){if(this.map=this.tools.map,this.map.activeObject){var e=this.tools.map.activeObject;if(this.textArea.value=e.text,this.textPopup.show(),t){var i=this.textPopup,s=this,o=function(t){i.off("close",o),t&&s.tools.om.deleteObj(e.id)};this.textPopup.on("close",o)}}},setText:function(t){this.map=this.tools.map,this.map.activeObject&&(this.map.activeObject.text=t)},change:function(){},setFill:function(t){this.map=this.tools.map,this.map.activeObject&&(this.map.activeObject.fill=t,this.tools.om.sync())},setStroke:function(t){this.map=this.tools.map,this.map.activeObject&&(this.map.activeObject.stroke=t.color,this.map.activeObject.strokeThickness=t.strokeThickness)},setShadow:function(t){this.map=this.tools.map,this.map.activeObject&&this.map.activeObject.setShadow(t.x,t.y,t.color,t.shadowBlur)},setAlign:function(t){this.map=this.tools.map,this.map.activeObject&&(this.map.activeObject.align=t,this.select(this.map.activeObject))},isUnknownFont:function(t){for(var e=0;e<this.fonts.length;e++)if(this.fonts[e]==t)return!1;return!0},addFont:function(t){this.isUnknownFont(t)&&(this.fonts.push(t),this.fontFace&&this.fontFace.addItem(this._mk_setFontSelect(t)))},checkFonts:function(){for(var t,e=this.tools.map.loadedObjects,i=null,s=this,o=0,a=0;a<e.length;a++)if(i=e[a],i.data.type==MT.objectTypes.TEXT){if(t=i.data.style.fontFamily,!t)continue;this.isUnknownFont(t)&&(this.addFont(t),o++,this.manager.loadFont(t,function(){o--,0==o&&window.setTimeout(function(){s.updateTextObjects()},500)}))}},updateTextObjects:function(t){var e=this.tools.map.loadedObjects;PIXI.Text.heightCache={};for(var i,s=0;s<e.length;s++)e[s].data.type==MT.objectTypes.TEXT&&(i=e[s].data.style.fontFamily,(void 0==t||i==t||i.indexOf(t)>-1)&&(e[s].object.dirty=!0))},setFontFamily:function(t){if(this.map=this.tools.map,this.map.activeObject){var e=this.map.activeObject;if(this.isUnknownFont(t)){var i=this;return this.addFont(t),void this.manager.loadFont(t,function(){i.setFontFamily(t),window.setTimeout(function(){i.updateTextObjects(t)},1e3)})}if(this.map=this.tools.map,e){return this._setFontFamily(e,t),e.object.dirty=!0,void this.select(e)}}},setFontSize:function(t){if(this.map=this.tools.map,this.map.activeObject){var e=this.map.activeObject;this.tester.style.font=e.font||e.style.font,this.tester.style.fontSize=t,e.fontSize=this.tester.style.fontSize,this.select(this.map.activeObject)}},toggleBold:function(){if(this.map=this.tools.map,this.map.activeObject){var t=this.map.activeObject,e=t.style.font,i=this.getFontAttribs(e),s="";i.bold||(s="bold"),i.italic&&(s+=" italic"),s=s.trim(),t.fontWeight=s,this.select(t)}},toggleItalic:function(){if(this.map=this.tools.map,this.map.activeObject){var t=this.map.activeObject,e=t.style.font,i=this.getFontAttribs(e),s="";i.bold&&(s+="bold"),i.italic||(s+=" italic"),s=s.trim(),t.fontWeight=s,this.select(t)}},toggleWordWrap:function(){if(this.map=this.tools.map,this.map.activeObject){var t=this.map.activeObject;t.wordWrap=!t.wordWrap;var e=t.object.getBounds();t.wordWrapWidth<e.width-10&&(t.wordWrapWidth=parseInt(e.width,10)),this.select(t)}},setWordWrapWidth:function(t){this.map=this.tools.map,this.map.activeObject&&(this.map.activeObject.wordWrapWidth=parseInt(t,10),this.select(this.map.activeObject))},_setFontFamily:function(t,e){t=t||this.map.activeObject,this.tester.style.font=t.style.font,this.tester.style.fontFamily=e,t.fontFamily=this.tester.style.fontFamily.replace(/'/gi,""),t.fontWeight=this.tester.style.fontWeight.replace(/normal/gi,""),"italic"==this.tester.style.fontStyle&&(t.fontWeight+=" "+this.tester.style.fontStyle.replace(/normal/gi,"")),t.fontSize=parseInt(this.tester.style.fontSize)},init:function(){if(this.map=this.tools.map,!this.isInitialized){var t=this;this.tools.ui.events.on("keypress",function(e){t.change(e)}),this.isInitialized=!0}},showTools:function(){},select:function(t){var e=t;if(!e||!e.data||e.data.type!=MT.objectTypes.TEXT)return void this.panel.hide();e.data.style=e.style,this.tools.om.sync(),this.tester.style.font=e.font?e.font:e.object.style.font,this.fontFace.value=this.tester.style.fontFamily.replace(/'/gi,""),this.fontFace.button.style.fontFamily=this.tester.style.fontFamily,this.fontSize.value=e.fontSize;var i=this.getFontAttribs(e.style.font);i.bold?(this.bold.style.fontWeight="bold",this.bold.addClass("active")):(this.bold.style.fontWeight="normal",this.bold.removeClass("active")),i.italic?(this.italic.style.fontStyle="italic",this.italic.addClass("active")):(this.italic.style.fontStyle="normal",this.italic.removeClass("active")),e.wordWrap?this.enableWordWrap(e):this.disableWordWrap(e),this.checkAlign(e),this.colorPicker.setColors({stroke:e.stroke,fill:e.fill,shadow:e.shadowColor}),this.colorPicker.shadowXInput.setValue(e.shadowOffsetX,!0),this.colorPicker.shadowYInput.setValue(e.shadowOffsetY,!0),this.colorPicker.shadowBlurInput.setValue(e.shadowBlur,!0),this.colorPicker.strokeThicknessInput.setValue(e.strokeThickness,!0),this.panel.hide(),this.panel.show(document.body),e.object.dirty=!0,this.tools.project.plugins.settings.update()},enableWordWrap:function(t){this.wordWrap.addClass("active"),this.wordWrapWidth.button.removeClass("hidden"),this.wordWrapWidth.button.text=t.wordWrapWidth,this.wordWrapWidth.button.el.setAttribute("px","px")},disableWordWrap:function(){this.wordWrap.removeClass("active"),this.wordWrapWidth.button.addClass("hidden")},checkAlign:function(t){var e=t;e.wordWrap||e.object.text.split("\n").length>1?(this.left.removeClass("hidden active"),this.center.removeClass("hidden active"),this.right.removeClass("hidden active"),"left"==e.align&&this.left.addClass("active"),"right"==e.align&&this.right.addClass("active"),"center"==e.align&&this.center.addClass("active")):(this.left.addClass("hidden"),this.center.addClass("hidden"),this.right.addClass("hidden"))},getFontAttribs:function(t){var e={bold:!1,italic:!1};if(!t)return e;for(var i=t.split(" "),s=0;s<i.length;s++)"bold"==i[s].trim()&&(e.bold=!0),"italic"==i[s].trim()&&(e.italic=!0);return e},mouseDown:function(){this.mDown=!0},mouseUp:function(t){if(this.mDown&&(this.mDown=!1,t.target==this.map.game.canvas)){var e=t.offsetX+this.map.offsetXCam-this.map.ox,i=t.offsetY+this.map.offsetYCam-this.map.oy,s=this.map.pickObject(t.x-this.map.offsetXCam,t.y-this.map.offsetYCam);if(s&&s.data.type==MT.objectTypes.TEXT)this.tools.tools.select.select(s),this.tools.select(s),this.tools.tools.text.showTextEdit();else{var o=this.tools.om.createTextObject(e,i);o.text=o.tmpName,this.tools.om.insertObject(o),s=this.map.getById(o.id),this.tools.select(s),this.tools.tools.text.showTextEdit(!0)}}},mouseMove:function(){}}),MT.namespace("plugins.tools"),MT.extend("core.BasicTool").extend("core.Emitter")(MT.plugins.tools.Brush=function(t){MT.core.BasicTool.call(this,t),this.name="brush"},{initUI:function(t){MT.core.BasicTool.initUI.call(this,t);var e=this;this.tools.on(MT.ASSET_SELECTED,function(t){e.tools.activeTool==e&&e.init(t)}),this.tools.on(MT.ASSET_FRAME_CHANGED,function(t){e.tools.activeTool==e&&(e.init(t),e.tools.tmpObject.frame=e.tools.activeFrame)}),this.tools.on(MT.OBJECT_SELECTED,function(){e.tools.activeTool==e&&e.tools.tmpObject&&e.tools.initTmpObject()})},lastX:0,lastY:0,init:function(t){this.map=this.tools.map,this.tools.unselectObjects(),t=t||this.tools.activeAsset;var e=this;this.tools.map.handleMouseMove=function(t){e.mouseMove(t)},t&&!t.contents&&(this.tools.initTmpObject(t),this.tools.tmpObject.frame=this.tools.activeFrame)},mouseDown:function(){if(!this.tools.tmpObject){if(!this.tools.map.activeObject)return;return this.tools.lastAsset||(this.tools.lastAsset=this.project.plugins.assetmanager.getById(this.tools.map.activeObject.data.assetId)),void this.init(this.tools.lastAsset)}this.insertObject()},mouseMove:function(t){if(t.target==this.tools.map.game.canvas&&this.tools.tmpObject){{this.tools.tmpObject.x,this.tools.tmpObject.y}this.tools.map._followMouse(t,!0),this.ui.events.mouse.down&&(this.tools.tmpObject.x!=this.lastX||this.tools.tmpObject.y!=this.lastY)&&this.insertObject()}},insertObject:function(){var t=this.project.plugins.objectmanager;this.tools.map.sync(this.tools.tmpObject,this.tools.tmpObject.data),this.tools.tmpObject.data.frame=this.tools.activeFrame,t.insertObject(JSON.parse(JSON.stringify(this.tools.tmpObject.data))),this.lastX=this.tools.tmpObject.x,this.lastY=this.tools.tmpObject.y,this.tools.initTmpObject(),this.tools.tmpObject.frame=this.tools.activeFrame,this.tools.tmpObject.x=this.lastX,this.tools.tmpObject.y=this.lastY,this.tools.tmpObject.object.bringToTop()},mouseUp:function(){},deactivate:function(){this.tools.removeTmpObject(),this.tools.map.handleMouseMove=this.tools.map.emptyFn,this.project.plugins.objectmanager.update()}}),MT.namespace("plugins.tools"),MT.extend("core.BasicTool").extend("core.Emitter")(MT.plugins.tools.Stamp=function(t){MT.core.BasicTool.call(this,t),this.name="stamp"},{initUI:function(t){MT.core.BasicTool.initUI.call(this,t);var e=this;this.tools.on(MT.ASSET_SELECTED,function(t){e.tools.activeTool==e&&(e.init(t),e.tools.tmpObject.frame=0)}),this.tools.on(MT.ASSET_FRAME_CHANGED,function(t,i){e.tools.activeTool==e&&(e.init(t),e.tools.tmpObject.frame=i)}),this.tools.on(MT.TOOL_SELECTED,function(){e.tools.activeTool!=e}),this.tools.on(MT.OBJECT_SELECTED,function(){e.tools.activeTool==e&&e.tools.tmpObject&&e.tools.initTmpObject()})},init:function(t){this.map=this.tools.map,this.tools.unselectObjects(),t=t||this.tools.activeAsset;var e=this;this.tools.map.handleMouseMove=function(t){e.mouseMove(t)},t&&!t.contents&&(this.tools.initTmpObject(t),this.tools.tmpObject.frame=this.tools.activeFrame)},mouseMove:function(t){t.target==this.tools.map.game.canvas&&this.tools.tmpObject&&this.tools.map._followMouse(t,!1)},mouseDown:function(){if(!this.tools.tmpObject)return this.map.activeObject?(this.tools.lastAsset||(this.tools.lastAsset=this.project.plugins.assetmanager.getById(this.map.activeObject.data.assetId)),void this.init(this.tools.lastAsset)):void(this.project.plugins.assetmanager.active&&(this.tools.lastAsset=this.project.plugins.assetmanager.active.data));var t=this.project.plugins.objectmanager;this.map.sync(this.tools.tmpObject),this.tools.tmpObject.data.frame=this.tools.activeFrame;var e=t.insertObject(JSON.parse(JSON.stringify(this.tools.tmpObject.data)));this.tools.initTmpObject(),this.tools.tmpObject.frame=this.tools.activeFrame,this.tools.tmpObject.x=e.x,this.tools.tmpObject.y=e.y,this.tools.tmpObject.object.bringToTop()},mouseUp:function(){},deactivate:function(){this.tools.removeTmpObject(),this.map.handleMouseMove=this.map.emptyFn,this.project.plugins.objectmanager.update()}}),MT.namespace("plugins.tools"),MT.extend("core.BasicTool").extend("core.Emitter")(MT.plugins.tools.Select=function(t){MT.core.BasicTool.call(this,t),this.name="select",this.activeState=this.states.NONE,this.startMove={x:0,y:0}},{states:{NONE:0,RW:1,RE:2,RN:3,RS:4,RNW:5,RNE:6,RSW:7,RSE:8},initUI:function(t){MT.core.BasicTool.initUI.call(this,t),this.map=this.tools.map},init:function(t){this.mDown=!1,this.map.handleMouseMove=this.mouseMoveFree,t||this.showInfoToolTip()},deactivate:function(){this.mDown=!1,this.map.handleMouseMove=this.mouseMoveFree,map.selection.width=0,map.selection.height=0},select:function(t){if(t!=map.activeObject){var e=this.ui.events.mouse.lastEvent&&this.ui.events.mouse.lastEvent.shiftKey?!0:!1;return e?this.map.selector.is(t)?void this.map.selector.remove(t):void this.map.selector.add(t):void this.tools.selectObject(t,!0)}},mouseMoveFree:function(t){if(this.activeObject){var e=this.project.plugins.tools.tools.select,i=this.activeObject,s=t.x-this.ox,o=t.y-this.oy;e.checkAltKey(t)||i.mouseMove(s,o,t)}},altKeyReady:!1,checkAltKey:function(t){if(this.altKeyReady){this.altKeyReady=!1;var e=[],i=this.map.selector;i.forEach(function(t){e.push(t.data)});var s=(this.map.game.camera.x,this.map.game.camera.y,this.tools.om.multiCopy(e));i.clear();for(var o,a=0;a<s.length;a++)o=this.map.getById(s[a].id),o?(o.object.updateTransform(),i.add(o)):console.log("Failed to find a sprite");s.length>0&&(this.map.activeObject=null,this.map.emit("select",this.map.settings),this.initMove(t))}},mouseMove:function(t){if(this.mDown){var e=t.x-this.map.offsetX,i=t.y-this.map.offsetY;e>this.map.selection.sx?this.map.selection.width=e-this.map.selection.x:(this.map.selection.width=this.map.selection.sx-e,this.map.selection.x=e),i>this.map.selection.sy?this.map.selection.height=i-this.map.selection.y:(this.map.selection.height=this.map.selection.sy-i,this.map.selection.y=i),this.map.selectRect(this.map.selection,!t.shiftKey),1!==this.map.selector.count?(this.map.emit("select",this.map.settings),this.map.activeObject=null):this.map.activeObject=this.map.selector.get(0)}},initMove:function(t){if(this.tools.activeTool==this){console.log("INIT MOVE"),this.checkAltKey(t);var e=this;this.map.updateMouseInfo(t),this.map.handleMouseMove=function(){e.map.handleMouseMove=e.map._objectMove}}},_lastMD:0,doubleClick:function(){if(!this.map.activeObject)return!1;for(var t,e=this.map.activeObject.data,i=0;i<this.map.loadedObjects.length;i++)t=this.map.loadedObjects[i],t.data.assetId==e.assetId&&t.data.type==e.type&&t.isVisible&&!t.isLocked&&this.map.selector.add(t);return!0},mDown:!1,mouseUp:function(t){console.log("UPP"),this.map.activeObject&&this.map.activeObject.mouseUp(t.x-this.map.ox,t.y-this.map.oy,t),this.mDown=!1;var e=(t.x-this.map.offsetXCam,t.y-this.map.offsetYCam,this.tools.map);e.selectRect(e.selection),e.selection.width=0,e.selection.height=0,this.map.activeObject&&this.map.activeObject.mouseUp(t.x-this.map.ox,t.y-this.map.oy,t),this.checkAltKey(t),e.handleMouseMove=this.mouseMoveFree},mouseDown:function(t){if(this.mDown=!0,!(Date.now()-this._lastMD<300&&this.doubleClick())){this._lastMD=Date.now();var e=t.x-this.map.ox,i=t.y-this.map.oy,s=t.x-this.map.offsetXCam,o=t.y-this.map.offsetYCam;if(t.altKey&&(this.altKeyReady=!0),this.map.activeObject&&-1!=this.map.activeObject.activeHandle)return void this.map.activeObject.mouseDown(e,i,t);var a=t.shiftKey?!0:!1,n=this.map.pickObject(s,o);if(!n){var h=this;return this.map.handleMouseMove=function(t){h.mouseMove(t)},this.map.selection.x=t.x-this.map.offsetX,this.map.selection.y=t.y-this.map.offsetY,this.map.selection.sx=t.x-this.map.offsetX,this.map.selection.sy=t.y-this.map.offsetY,this.map.selection.width=0,this.map.selection.height=0,void(a||(this.map.selector.clear(),this.map.activeObject=null,this.map.emit("select",this.map.settings)))}if(a){if(this.map.selector.is(n))return void this.map.selector.remove(n)}else this.map.selector.is(n)||this.map.selector.clear();this.map.selector.add(n),1==this.map.selector.count?(this.map.activeObject=n,n.mouseDown(e,i,t)):(console.log(this.map.selector.count),this.map.activeObject=null,this.map.emit("select",this.map.settings),this.altKeyReady=t.altKey,this.initMove(t))}}}),MT.namespace("ui"),MT.require("ui.Panel"),MT.extend("core.Emitter").extend("ui.DomElement")(MT.ui.List=function(t,e,i){MT.ui.DomElement.call(this),this._items=[],this.setAbsolute(),this.addClass("ui-list"),this.panel=new MT.ui.Panel("",e.events),this.panel.removeHeader(),this.panel.content.style.overflow="initial",this.panel.style.position="relative",this.panel.show(this.el),this.panel.content.style.position="relative";var s=this;e.events.on("mouseup",function(t){for(var e=0;e<s.panel.buttons.length;e++)if(s.panel.buttons[e].el==t.target)return;i&&s.hide()}),this.isVisible=!1,this.list=t,this.update(),this.addChild(this.panel).show()},{update:function(){for(;this._items.length;)this._items.pop().remove();for(var t=0;t<this.list.length;t++)this.addItem(this.list[t])},addItem:function(t){if(!t.check||t.check()){var e=this.panel.addButton(t.label,t.className,t.cb);e.style.position="relative",e.addClass("ui-list-button"),t.create&&t.create(e),this._items.push(e)}},show:function(t){this.shown=Date.now(),this.update(),this.isVisible=!0,MT.ui.DomElement.show.call(this,t),this.emit("show"),this.x+this.width>window.innerWidth&&(this.x-=this.width),this.y+this.height>window.innerHeight&&(this.y-=this.height)},hide:function(){Date.now()-this.shown<100||this.isVisible&&(this.isVisible=!1,MT.ui.DomElement.hide.call(this),this.emit("hide"))}}),MT.namespace("ui"),MT.require("core.keys"),MT.require("ui.ColorPicker"),MT.extend("ui.DomElement").extend("core.Emitter")(MT.ui.Input=function(t,e,i){var s=t.events;if(MT.ui.DomElement.call(this),MT.core.Emitter.call(this),this.object=i,this.key="",this.step=1,this.min=-1/0,this.max=1/0,this.type="number",this.properties=e,"string"==typeof e?this.key=e:(this.key=e.key,this.step=e.step||this.step,void 0!=e.min&&(this.min=e.min),void 0!=e.max&&(this.max=e.max),void 0!=e.type&&(this.type=e.type)),"bool"==this.type&&(this.type="number",this.min=0,this.max=1,this.step=1),"number"==this.type&&this.addClass("ui-input-number"),this.label=new MT.ui.DomElement,this.label.addClass("ui-input-label"),this.addChild(this.label).show(),this.addClass("ui-input"),this.label.el.innerHTML=this.key,this.label.style.bottom="initial",this.label.style.right="50%",this.value=new MT.ui.DomElement("a"),this.value.style.bottom="initial",this.value.style.left="initial",this.value.style.right=0,this.value.addClass("ui-input-value"),this.node=document.createTextNode(""),this.value.el.appendChild(this.node),"select"==this.type){this.options=[];var o=document.createElement("div");this.selectInput=o;for(var a,n=e.options,h=0;h<n.length;h++)a=document.createElement("div"),a.innerHTML=n[h].label,o.appendChild(a),n[h].title&&(a.title=n[h].title),this.options.push(a);this.setValue(this.object[this.key],!0),o.className="ui-input-dropdown",this.selectInput.onmousedown=function(t){t.target!=o&&(l.selectedValue=t.target.innerHTML)}}var r=this.input=this.inputBox=document.createElement("input"),l=this;if("upload"==this.type)return this.input.type="file",this.addClass("upload"),e.accept&&this.input.setAttribute("accept",e.accept),this.input.onchange=function(t){l.emit("change",t,l.object)},this.label.style.right="0",this.label.el.onclick=function(){l.input.click()},void(void 0!==this.object[this.key]&&(this.setValue(this.object[this.key],!0),this.addChild(this.value).show()));if(this.addChild(this.value).show(),this.value.style.bottom="initial",this.value.style.left="initial",this.value.style.right=0,this.value.addClass("ui-input-value"),"color"==this.type){this.value.style["float"]="right",this.value.style.position="relative",this.span=document.createElement("span"),this.el.appendChild(this.span),this.span.className="ui-input-color-pick",this.span.style.backgroundColor=this.object[this.key];var l=this;this.span.onclick=function(){t.colorPicker.setColor(l.object[l.key]),t.colorPicker.show(),t.colorPicker.on("change",function(t){l.setValue(t)})}}this.setValue(this.object[this.key],!0),this.setTabIndex(),this.events=s,r.type="text","password"==this.type&&r.setAttribute("type","password"),r.className="ui-input",r.isVisible=!1,r.style.textAlign="right",r.style.paddingRight="10px";var c=0,d=function(){if(l.value.el.offsetParent){var t=.5*l.value.el.parentNode.parentNode.offsetWidth;r.style.width=t+"px",r.style.top=l.value.calcOffsetY(l.value.el.offsetParent)-9+"px",r.style.left=l.value.calcOffsetX(l.value.el.offsetParent)-t+l.value.el.offsetWidth-25+"px",r.value=l.object[l.key],r.isVisible=!0,r.width=l.value.offsetWidth+"px",c=l.value.el.getAttribute("tabindex"),l.value.el.setAttribute("tabindex",-1),l.value.style.visibility="hidden",l.value.el.offsetParent.appendChild(r),r.focus(),"color"!=r.type&&r.setSelectionRange(0,r.value.length),e.options&&l.showOptions()}};this.value.el.onkeydown=function(){d()},this.value.el.setAttribute("draggable","false"),this.enableInput=function(){d()};var u=!1;this.value.el.onmousedown=function(t){l.needEnalbe=!0,u=!0,t.preventDefault(),t.stopPropagation()},this.on("change",function(){l.needEnalbe=!1}),this.value.el.onmouseup=function(){1==l.needEnalbe&&d()},this.value.el.onfocus=function(){d()};var p;r.onfocus=function(){p=l.object[l.key]},r.onblur=function(){r.parentNode.removeChild(r),r.isVisible=!1,l.selectedValue&&(r.value=l.selectedValue);var t=l.evalValue(r.value);l.setValue(t),l.emit("change",t,t),e.options&&l.hideOptions(),l.value.el.setAttribute("tabindex",c)},r.onkeydown=function(t){t.which==MT.keys.DELETE&&t.stopPropagation(),t.which==MT.keys.ESC&&(r.value=p,r.blur(),t.stopPropagation())},r.onkeyup=function(t){if(r.isVisible){var i=t.which,s=!0;if(i==MT.keys.ESC&&(s=!1,r.value=l.object[l.key],r.blur()),i==MT.keys.ENTER?(""!=l.selectedValue&&(r.value=l.selectedValue,l.setValue(l.selectedValue)),s=!1,r.blur()):i==MT.keys.DOWN?l.showNextOption():i==MT.keys.UP&&l.showPrevOption(),l.object[l.key]!=r.value){var o=l.evalValue(r.value);l.setValue(o,!0),s&&(l.value.style.visibility="hidden")}e.options&&l.showOptions(!0),t.preventDefault(),t.stopPropagation()}},r.onmousedown=function(t){t.stopPropagation()},"number"==this.type&&(this.wheel=r.onwheel=s.on("wheel",function(t){if(t.target===l.value.el){t.preventDefault(),t.stopPropagation();var e=(t.wheelDelta||-t.deltaY)>0?1:-1,i=l.object[l.key]+e*l.step;l.setValue(i)}},!0),this.mouseup=s.on("mouseup",function(){u=!1,l.needEnalbe=!1}),this.el.onmouseup=this.mouseup,this.mousemove=s.on("mousemove",function(){if(u){var t=l.object[l.key]-s.mouse.my*l.step;l.setValue(t,!1)}}))},{selectedValue:"",showOptions:function(t){for(;this.selectInput.firstChild;)this.selectInput.removeChild(this.selectInput.firstChild);var e=this.inputBox.value;console.log("show");for(var i=0;i<this.options.length;i++)t?this.options[i].innerHTML.toLowerCase().indexOf(e.toLowerCase())>-1&&this.selectInput.appendChild(this.options[i]):this.selectInput.appendChild(this.options[i]);document.body.appendChild(this.selectInput);var s=this.inputBox.getBoundingClientRect();this.selectInput.style.top=s.top+s.height,this.selectInput.style.left=s.left;var o=this.selectInput.getBoundingClientRect();o.right>window.innerWidth&&(this.selectInput.style.left=window.innerWidth-o.width),o.bottom>window.innerHeight&&(this.selectInput.style.top=s.top-o.height)},hideOptions:function(){for(this.currOption=-1,this.activeOption&&(this.activeOption.className="");this.selectInput.firstChild;)this.selectInput.removeChild(this.selectInput.firstChild)},currOption:-1,activeOption:null,showNextOption:function(){this.selectInput&&(this.activeOption&&(this.activeOption.className=""),this.currOption++,this.currOption>this.selectInput.children.length-1&&(this.currOption=0),this.currOption<0&&(this.currOption=this.selectInput.children.length-1),this.selectInput.children.length&&(this.activeOption=this.selectInput.children[this.currOption],this.activeOption.className="active",this.selectedValue=this.activeOption.innerHTML,this.activeOption.scrollIntoView(!1)))},showPrevOption:function(){this.selectInput&&(this.activeOption&&(this.activeOption.className=""),this.currOption--,this.currOption<0&&(this.currOption=this.selectInput.children.length-1),this.currOption>this.selectInput.children.length-1&&(this.currOption=0),this.selectInput.children.length&&(this.activeOption=this.selectInput.children[this.currOption],this.activeOption.className="active",this.selectedValue=this.activeOption.innerHTML,this.activeOption.scrollIntoView(!0)))},remove:function(){this.events.off(this.mousemove),this.events.off(this.mouseup),this.events.off(this.keyup),this.events.off(this.onwheel),this.el.parentNode&&this.el.parentNode.removeChild(this.el)},update:function(){this.setValue(this.object[this.key],!0)},setObject:function(t,e){this.object=t,this.update(),e&&this.show()},getValue:function(){return this.object[this.key]},setValue:function(t,e){if("upload"!=this.type){this.needEnalbe=!1;var i=this.object[this.key];if(t<this.min&&(t=this.min),t>this.max&&(t=this.max),this.object[this.key]=t,"number"==typeof t)this.node.nodeValue=parseFloat(t.toFixed(4));else if("password"==this.type){for(var s="",o=0;o<t.length;o++)s+="&#9679;";this.value.el.innerHTML=s}else"color"==this.type?(this.span.style.backgroundColor=t,this.node.nodeValue=t):this.node.nodeValue=t;this.value.style.visibility="visible",e||i!=t&&this.emit("change",t,i)}},evalValue:function(val){if("number"!=this.type)return val;var ret=null;try{ret=eval(val)}catch(e){ret=val}return ret},setTabIndex:function(t){t=t||1,MT.ui.Input.tabindex+=t,this.value.el.setAttribute("tabindex",MT.ui.Input.tabindex),this.input.setAttribute("tabindex",MT.ui.Input.tabindex),this.value.el.setAttribute("href","javascript:;")}}),MT.ui.Input.tabindex=0,MT.namespace("core"),MT(MT.core.MagicObject=function(t,e,i){this.data=t,this.parent=e,this.map=i,this.settings=this.map.project.plugins.settings,this.manager=this.map.project.plugins.objectmanager,this.game=i.game,this.isRemoved=!1,this.activeHandle=-1,this.handles=[],this.mouseInfo={down:!1,x:0,y:0},this.rotator={x:0,y:0},this.create(),this.activeFrame=-1,this.activeMovie="",this.tmpData={x:0,y:0,alpha:1,angle:0,scaleX:1,scaleY:1,anchorX:0,anchorY:0},Object.seal(this)},{radius:3,activeRadius:5,changeMovieFrame:function(t,e,i){this.activeMovie=t,this.activeFrame=e,this.loadMovieFrame(),i||this.changeChildrenMovieFrame(t,e)},changeChildrenMovieFrame:function(t,e){for(var i=0;i<this.object.children.length;i++)this.object.children[i].magic.changeMovieFrame(t,e)},loadMovieFrame:function(){if(this.data.movies){var t=this.data.movies[this.activeMovie];if(t){var e=t.frames;if(e&&0!==e.length){var i,s,o=e[0];if(s=e[e.length-1],s.keyframe<this.activeFrame)return void this.update(s);for(var a=0;a<e.length;a++){if(i=e[a],i.keyframe<this.activeFrame&&(o=i),i.keyframe>this.activeFrame){s=i;break}if(i.keyframe==this.activeFrame)return void this.update(i)}return o==s?void this.update(s):void this.prepareInterpolate(o,s)}}}},prepareInterpolate:function(t,e){{var i=(this.activeFrame-t.keyframe)/(e.keyframe-t.keyframe);this.buildTmpVals(i,t,e)}this.update(this.tmpData)},buildTmpVals:function(t,e,i){var s=this.tmpData;void 0==i.easings?(s.x=this.getInt(t,e.x,i.x),s.y=this.getInt(t,e.y,i.y),s.angle=this.getInt(t,e.angle,i.angle),s.alpha=this.getInt(t,e.alpha,i.alpha),s.scaleX=this.getInt(t,e.scaleX,i.scaleX),s.scaleY=this.getInt(t,e.scaleY,i.scaleY),this.data.type!=MT.objectTypes.GROUP&&(s.anchorX=this.getInt(t,e.anchorX,i.anchorX),s.anchorY=this.getInt(t,e.anchorY,i.anchorY))):(s.x=this.getInt(t,e.x,i.x,i.easings.x),s.y=this.getInt(t,e.y,i.y,i.easings.y),s.angle=this.getInt(t,e.angle,i.angle,i.easings.angle),s.alpha=this.getInt(t,e.alpha,i.alpha,i.easings.alpha),s.scaleX=this.getInt(t,e.scaleX,i.scaleX,i.easings.scaleX),s.scaleY=this.getInt(t,e.scaleY,i.scaleY,i.easings.scaleY),this.data.type!=MT.objectTypes.GROUP&&(s.anchorX=this.getInt(t,e.anchorX,i.anchorX,i.easings.anchorX),s.anchorY=this.getInt(t,e.anchorY,i.anchorY,i.easings.anchorY)))},getInt:function(t,e,i,s){var o=t;return s&&(o=this.resolve(s,t)),isNaN(e)||isNaN(i)?void 0:(1-o)*e+o*i},resolve:function(t,e){if("NONE"==t)return 0;for(var i=t.split("."),s=Phaser.Easing,o=0;o<i.length&&s;o++)s=s[i[o]];return s?s(e):e},create:function(){void 0==this.data.type&&this.data.contents&&(this.data.type=MT.objectTypes.GROUP),this.data.type==MT.objectTypes.GROUP&&this.createGroup(),this.data.type==MT.objectTypes.SPRITE&&(this.createSprite(),this.width=this.object.width,this.height=this.object.height),this.data.type==MT.objectTypes.TEXT&&this.createText(),this.data.type==MT.objectTypes.TILE_LAYER&&this.createTileLayer(),this.object.magic=this},createTileLayer:function(){{var t=this.game.width;this.game.height}this.game.width=99999,this.game.height=99999,this.createTileMap(),this.object=this.tilemap.createBlankLayer(this.data.name,this.data.widthInTiles,this.data.heightInTiles,this.data.tileWidth,this.data.tileHeight),this.object.fixedToCamera=this.data.isFixedToCamera,this.map.project.plugins.tools.tools.tiletool.updateLayer(this),this.map.tileLayers.push(this.object),this.map.resort(),this.game.width=t,this.game.height=t,this.data.isVisible||this.hide()},createTileMap:function(){var t=this.data.tileWidth||64,e=this.data.tileHeight||64;this.tilemap=this.game.add.tilemap(null,t,e,this.data.widthInTiles,this.data.heightInTiles)},createGroup:function(){this.object=this.game.add.group(),this.appendToParent()},createSprite:function(){this.data.contents||(this.data.contents=[]),PIXI.BaseTextureCache[this.data.assetId]||(this.data.assetId="__missing"),this.parent.type==Phaser.GROUP?this.object=this.parent.create(this.data.x,this.data.y,this.data.assetId):(this.object=this.parent.game.add.sprite(this.data.x,this.data.y,this.data.assetId),this.game.world.removeChild(this.object),this.appendToParent()),this.object.inputEnabled=!0,this.object.input.pixelPerfectOver=!0,this.createBox(),this.update()},createText:function(){this.object=this.game.add.text(this.data.x,this.data.y,this.data.text,this.data.style),this.appendToParent(),this.object.inputEnabled=!0,this.object.input.pixelPerfectOver=!1,this.createBox(),this.update()},appendToParent:function(){this.parent.type==Phaser.GROUP?this.parent.add(this.object):this.parent.addChild(this.object)},updateText:function(){this.object.text=this.data.text,this.data.style?this.object.style=this.data.style:this.data.style={},this.wordWrap=this.data.wordWrap,this.wordWrapWidth=this.data.wordWrapWidth,this.object.fontSize=this.data.style.fontSize||32,this.object.font=this.data.style.fontFamily||"Arial",this.object.fontWeight=this.data.style.fontWeight||"",this.object.style.fill=this.fill,this.data.shadow||(this.data.shadow={}),this.object.anchor.x=this.data.anchorX,this.object.anchor.y=this.data.anchorY},updateSprite:function(){this.object.game&&(this.object.anchor.x=this.data.anchorX,this.object.anchor.y=this.data.anchorY,this.object.loadTexture(this.data.assetId),this.object.frame=this.data.frame)},hide:function(){this.object.visible=!1},show:function(){this.object.visible=!0},remove:function(){this.type==MT.objectTypes.TILE_LAYER?this.removeLayer():this.object.destroy(),this.isRemoved=!0},createBox:function(){this.handles[0]={x:0,y:0,opx:1,opy:3},this.handles[1]={x:0,y:0,opx:0,opy:2},this.handles[2]={x:0,y:0,opx:3,opy:1},this.handles[3]={x:0,y:0,opx:2,opy:0},this.handles[4]={x:0,y:0,opx:6,opy:0},this.handles[5]={x:0,y:0,opx:7,opy:7},this.handles[6]={x:0,y:0,opx:4,opy:0},this.handles[7]={x:0,y:0,opx:2,opy:5},this.updateBox()
},update:function(t,e){if(t)for(var i in t)this.data[i]=t[i];e&&(this.parent.type==Phaser.Sprite&&this.parent.removeChild(this.object),e.type==Phaser.GROUP?e.add(this.object,!0):e.addChild(this.object),this.parent=e),this.updateBox(),this.data.isVisible?this.show():this.hide(),this.data.type==MT.objectTypes.TEXT&&this.updateText(),this.data.type==MT.objectTypes.SPRITE&&this.updateSprite(),this.data.type==MT.objectTypes.TILE_LAYER&&(this.removeLayer(),this.createTileLayer(),this.object.visible=this.isVisible),this.object.x=this.data.x,this.object.y=this.data.y,this.object.alpha=this.data.alpha,this.object.angle=this.data.angle,this.data.scaleX&&(this.object.scale.x=this.scaleX,this.object.scale.y=this.scaleY),this.map.resort(),this.map.activeObject==this&&this.settings.update(),this.object.dirty=!0},updateBox:function(){if(this.data.type!=MT.objectTypes.TILE_LAYER&&this.map&&this.map.scale){var t=this.object;t.updateTransform();var e,i,s=t.worldTransform,o=s.tx,a=s.ty,n=this.getOffsetAngle(),h=o,r=a-60;if(this.data.type==MT.objectTypes.GROUP)return void(-3!=this.activeHandle&&(this.rotator.x=this.rpx(this.object.rotation,h,r,o,a),this.rotator.y=this.rpy(this.object.rotation,h,r,o,a)));h=o,r=a-this.object.height*this.map.scale.x*.6-20,0!=this.activeHandle&&(e=s.tx-t.width*t.anchor.x*this.map.scale.x,i=s.ty-t.height*t.anchor.y*this.map.scale.x,this.rp(n,e,i,o,a,this.handles[0])),1!=this.activeHandle&&(e=s.tx+t.width*(1-t.anchor.x)*this.map.scale.x,i=s.ty-t.height*t.anchor.y*this.map.scale.x,this.rp(n,e,i,o,a,this.handles[1])),2!=this.activeHandle&&(e=s.tx+t.width*(1-t.anchor.x)*this.map.scale.x,i=s.ty+t.height*(1-t.anchor.y)*this.map.scale.x,this.rp(n,e,i,o,a,this.handles[2])),3!=this.activeHandle&&(e=s.tx-t.width*t.anchor.x*this.map.scale.x,i=s.ty+t.height*(1-t.anchor.y)*this.map.scale.x,this.rp(n,e,i,o,a,this.handles[3])),e=s.tx-t.width*t.anchor.x*this.map.scale.x,i=s.ty-t.height*t.anchor.y*this.map.scale.x+.5*t.height*this.map.scale.x,this.rp(n,e,i,o,a,this.handles[4]),6!=this.activeHandle&&(e=s.tx+t.width*(1-t.anchor.x)*this.map.scale.x,i=s.ty-t.height*t.anchor.y*this.map.scale.x+.5*t.height*this.map.scale.x,this.rp(n,e,i,o,a,this.handles[6])),5!=this.activeHandle&&(e=s.tx-t.width*t.anchor.x*this.map.scale.x+.5*t.width*this.map.scale.x,i=s.ty-t.height*t.anchor.y*this.map.scale.x,this.rp(n,e,i,o,a,this.handles[5])),7!=this.activeHandle&&(e=s.tx-t.width*t.anchor.x*this.map.scale.x+.5*t.width*this.map.scale.x,i=s.ty+t.height*(1-t.anchor.y)*this.map.scale.x,this.rp(n,e,i,o,a,this.handles[7])),-3!=this.activeHandle&&(this.rotator.x=this.rpx(this.object.rotation,h,r,o,a),this.rotator.y=this.rpy(this.object.rotation,h,r,o,a))}},highlight:function(t){if(!this.isRemoved&&this.isVisible){var e=this.object.worldTransform,i=e.tx,s=e.ty;if(t.save(),t.translate(.5,.5),t.strokeStyle="#ffaa00",this.data.type==MT.objectTypes.GROUP){if(-3!=this.activeHandle){var o=i,a=s-60;this.rotator.x=this.rpx(this.object.rotation,o,a,i,s),this.rotator.y=this.rpy(this.object.rotation,o,a,i,s)}var n=this.object.getBounds();return t.strokeRect(n.left,n.top,n.width,n.height),this.drawGroupHandle(t,this.object),this.map.activeObject==this&&(t.strokeStyle="#ffee22",t.beginPath(),-3==this.activeHandle?t.arc(this.rotator.x,this.rotator.y,this.activeRadius,0,2*Math.PI):t.arc(this.rotator.x,this.rotator.y,this.radius,0,2*Math.PI),l=t.createRadialGradient(this.rotator.x,this.rotator.y,0,this.rotator.x,this.rotator.y,this.radius),l.addColorStop(0,"rgba(255, 255, 255, 0)"),l.addColorStop(1,"rgba(0, 70, 70, 1)"),t.fillStyle=l,t.fill(),t.stroke()),void t.restore()}if(this.data.type==MT.objectTypes.TILE_LAYER){var n=this.object.getBounds();return t.strokeRect(n.left,n.top,n.width,n.height),this.drawGroupHandle(t,this.parent),void t.restore()}this.drawGroupHandle(t,this.parent),this.updateBox();var h=this.handles[0];t.beginPath(),t.moveTo(h.x,h.y);for(var r,l,c=1;4>c;c++)r=this.handles[c],t.lineTo(r.x,r.y);if(t.lineTo(h.x,h.y),t.stroke(),this.map.activeObject==this){t.strokeStyle="#ff0000",t.fillStyle=l;for(var c=0;c<this.handles.length;c++)r=this.handles[c],t.beginPath(),this.activeHandle==c?t.arc(r.x,r.y,this.activeRadius,0,2*Math.PI):t.arc(r.x,r.y,this.radius,0,2*Math.PI),l=t.createRadialGradient(r.x,r.y,0,r.x,r.y,this.radius),l.addColorStop(0,"rgba(255, 255, 255, 0)"),l.addColorStop(1,"rgba(0, 70, 70, 1)"),t.fillStyle=l,t.fill(),t.stroke();t.strokeStyle="#ffee22",t.beginPath(),-3==this.activeHandle?t.arc(this.rotator.x,this.rotator.y,this.activeRadius,0,2*Math.PI):t.arc(this.rotator.x,this.rotator.y,this.radius,0,2*Math.PI),l=t.createRadialGradient(this.rotator.x,this.rotator.y,0,this.rotator.x,this.rotator.y,this.radius),l.addColorStop(0,"rgba(255, 255, 255, 0)"),l.addColorStop(1,"rgba(0, 70, 70, 1)"),t.fillStyle=l,t.fill(),t.stroke(),t.beginPath(),t.moveTo(this.rotator.x,this.rotator.y),t.lineTo(i,s),t.stroke(),t.strokeStyle="#000000",t.beginPath(),-2==this.activeHandle?t.arc(i,s,this.activeRadius,0,2*Math.PI):t.arc(i,s,this.radius,0,2*Math.PI),l=t.createRadialGradient(i,s,0,i,s,this.radius),l.addColorStop(0,"rgba(255, 255, 255, 0)"),l.addColorStop(1,"rgba(0, 70, 70, 1)"),t.fillStyle=l,t.fill(),t.stroke()}t.restore()}},drawGroupHandle:function(t,e){var i=e.worldTransform,s=i.tx,o=i.ty,a=0,n=3*-this.radius;t.save(),t.translate(s,o),t.rotate(e.rotation),t.strokeStyle="#ffffff",t.lineWidth=1.5,t.strokeRect(-this.radius+.5,-this.radius+.5,2*this.radius,2*this.radius),t.beginPath(),t.moveTo(.5,.5),t.lineTo(a+.5,n+.5),t.stroke(),t.strokeStyle="#000000",t.lineWidth=1,t.strokeRect(-this.radius,-this.radius,2*this.radius,2*this.radius),t.beginPath(),t.moveTo(0,0),t.lineTo(a,n),t.stroke(),t.restore()},mouseDown:function(t,e){this.mouseInfo.down=!0,this.mouseInfo.x=t,this.mouseInfo.y=e,-1!=this.activeHandle},mouseUp:function(){this.mouseInfo.down=!1},mouseMove:function(t,e,i){var s=this.mouseInfo;if(this.isVisible){if(this.type==MT.objectTypes.TILE_LAYER){var o=this.map.project.plugins.tools;if(o.activeTool==o.tools.tiletool)return void o.tools.tiletool.mouseMove(i)}if(this.mouseInfo.down)return void(-1!=this.activeHandle?this.moveHandle(t,e,i):this.moveObject(t,e,i));s.x=t,s.y=e,this.updateBox();var a,n,h,r=this.object.worldTransform,l=r.tx,c=r.ty;a=Math.abs(l-t),n=Math.abs(c-e);var d=this.radius;if(-2==this.activeHandle&&(d=this.activeRadius),d>a&&d>n)return void(this.activeHandle=-2);if(d=this.radius,a=Math.abs(this.rotator.x-t),n=Math.abs(this.rotator.y-e),-3==this.activeHandle&&(d=this.activeRadius),d>a&&d>n)return void(this.activeHandle=-3);for(var u=0;u<this.handles.length;u++)if(d=this.radius,h=this.handles[u],a=Math.abs(h.x-t),n=Math.abs(h.y-e),this.activeHandle==u&&(d=this.activeRadius),d>a&&d>n)return void(this.activeHandle=u);this.activeHandle=-1,this.updateBox()}},moveObject:function(t,e,i){var s=this.mouseInfo,o=(s.x-t)/this.map.scale.x,a=(s.y-e)/this.map.scale.y,n=this.getParentAngle(),h=this.offsetScaleX();0>h&&(o*=-1),this.offsetScaleY()<0&&(a*=-1);var r=this.rpx(-n,o,a,0,0),l=this.rpy(-n,o,a,0,0);if(this.x-=r,s.x=t,this.y-=l,s.y=e,i.ctrlKey&&0==n){var c=this.map.settings.gridX,d=this.map.settings.gridY,u=Math.round(this.x/c)*c,p=Math.round(this.y/d)*d;h>0?s.x+=(u-this.x)*this.map.scale.x:s.x-=(u-this.x)*this.map.scale.x,s.y+=(p-this.y)*this.map.scale.x,this.x=u,this.y=p}this.update()},moveHandle:function(t,e,i){var s,o,a,n=this.mouseInfo,h=this.object,r=h.worldTransform,l=r.tx,c=r.ty,d=this.getOffsetAngle();if(o=n.x-t,a=n.y-e,-3==this.activeHandle){this.rotator.x-=o,this.rotator.y-=a;var u=Math.atan2(r.ty-this.rotator.y,r.tx-this.rotator.x)-.5*Math.PI,p=u-Phaser.Math.degToRad(this.angle);for(n.x=t,n.y=e;p>Math.PI;)p-=2*Math.PI;for(;p<-Math.PI;)p=2*Math.PI+p;return this.angle+=Phaser.Math.radToDeg(p),i.ctrlKey&&(this.data.angle=15*Math.round(this.data.angle/15)),void this.update()}if(-2==this.activeHandle){if(this.data.type==MT.objectTypes.GROUP){o/=this.map.scale.x,a/=this.map.scale.x;var m=this.x,f=this.y;this.moveObject(t,e,i),o=m-this.x,a=f-this.y;for(var v,g=this.rpx(-this.object.rotation,o,a,0,0),b=this.rpy(-this.object.rotation,o,a,0,0),y=0;y<this.object.children.length;y++)v=this.object.children[y].magic,v.move(v.x+g,v.y+b);return}var m=this.anchorX,f=this.anchorY;if(this.translateAnchor(-o,-a),n.x=t,n.y=e,i.ctrlKey){this.moveAnchor(.1*Math.round(10*this.anchorX),.1*Math.round(10*this.anchorY));var d=this.getOffsetAngle(),T=this.width*(this.anchorX-m)*this.map.scale.x,w=this.height*(this.anchorY-f)*this.map.scale.y,M=this.rpx(d,T,w,0,0),j=this.rpy(d,T,w,0,0);n.x=t+o+M,n.y=e+a+j}return void this.update()}o=n.x-t,a=n.y-e,s=this.handles[this.activeHandle];var x,C,k=this.handles[s.opx],E=this.handles[s.opy],O=this.rpx(-d,s.x,s.y,l,c),P=this.rpy(-d,s.x,s.y,l,c),S=this.rpx(-d,k.x,k.y,l,c),_=(this.rpy(-d,k.x,k.y,l,c),this.rpx(-d,E.x,E.y,l,c),this.rpy(-d,E.x,E.y,l,c));if(x=S-O>0?1:-1,C=_-P>0?1:-1,this.activeHandle<4){s.x-=o,s.y-=a;var I=(this.width,this.height,Math.sqrt(Math.pow(k.x-s.x,2)+Math.pow(k.y-s.y,2))/this.map.scale.x),D=Math.sqrt(Math.pow(E.x-s.x,2)+Math.pow(E.y-s.y,2))/this.map.scale.y;(1==this.activeHandle||2==this.activeHandle)&&(x*=-1),(2==this.activeHandle||3==this.activeHandle)&&(C*=-1),this.width=I,this.scaleX=this.object.scale.x*x,this.scaleY=this.object.scale.y*C,this.height=D,this.updateBox(),i.ctrlKey&&(this.scaleX=.1*Math.round(this.scaleX/.1),this.scaleY=.1*Math.round(this.scaleY/.1)),i.shiftKey&&(this.scaleX=this.scaleY)}else{if(4==this.activeHandle&&0==this.anchorX)return;if(5==this.activeHandle&&0==this.anchorY)return;if(6==this.activeHandle&&1==this.anchorX)return;if(7==this.activeHandle&&1==this.anchorY)return;if(this.activeHandle%2==0){6==this.activeHandle&&(x*=-1),s.x-=o,s.y-=a;var A=x*Math.sqrt(Math.pow(k.x-s.x,2)+Math.pow(k.y-s.y,2))/this.map.scale.x;this.data.type==MT.objectTypes.TEXT&&this.data.wordWrap?this.wordWrapWidth=Math.round(A):this.width=A,this.scaleX=this.object.scale.x,this.updateBox(),i.ctrlKey&&(this.scaleX=.1*Math.round(this.scaleX/.1)),i.shiftKey&&(this.scaleY=this.scaleX),this.data.scaleX=this.object.scale.x,this.updateBox()}else s.y-=a,s.x-=o,7==this.activeHandle&&(C*=-1),this.height=C*Math.sqrt(Math.pow(E.x-s.x,2)+Math.pow(E.y-s.y,2))/this.map.scale.y,this.scaleY=this.object.scale.y,this.updateBox(),i.ctrlKey&&(this.scaleY=.1*Math.round(this.scaleY/.1)),i.shiftKey&&(this.scaleX=this.object.scale.x),this.data.scaleY=this.object.scale.y,this.updateBox()}n.x=t,n.y=e,this.update()},bringToTop:function(){this.parent.bringToTop(this.object)},moveAnchor:function(t,e){var i=this.width*this.anchorX,s=this.height*this.anchorY,o=this.getOffsetAngle()-this.getParentAngle();this.anchorX=t,this.anchorY=e;var a=this.width*t-i,n=this.height*e-s;this.x+=this.rpx(o,a,n,0,0),this.y+=this.rpy(o,a,n,0,0)},translateAnchor:function(t,e){var i=this.getOffsetAngle(),s=this.object.rotation,o=this.object.worldTransform,a=this.getParentAngle(),n=-t,h=-e;this.object.rotation-=i,this.updateBox();var r=this.handles[0],l=this.rpx(-a,n,h,0,0),c=this.rpy(-a,n,h,0,0),d=this.rpx(-s,l,c,0,0),u=this.rpy(-s,l,c,0,0),p=r.x,m=r.y,f=o.tx-d,v=(f-p)/(this.object.width*this.map.scale.x),g=o.ty-u,b=(g-m)/(this.object.height*this.map.scale.x),y=this.anchorX,T=this.anchorY;this.anchorX=v,this.anchorY=b;var w=(v-y)*this.object.width,M=(b-T)*this.object.height;this.x+=this.rpx(s,w,M,0,0),this.y+=this.rpy(s,w,M,0,0),this.object.rotation=s,this.update()},move:function(t,e){this.getParentAngle();this.x=t,this.y=e},rpx:function(t,e,i,s,o){var a=Math.sin(t),n=Math.cos(t);return(e-s)*n-(i-o)*a+s},rpy:function(t,e,i,s,o){var a=Math.sin(t),n=Math.cos(t);return(i-o)*n+(e-s)*a+o},rp:function(t,e,i,s,o,a){var n=Math.sin(t),h=Math.cos(t);a.x=(e-s)*h-(i-o)*n+s,a.y=(i-o)*h+(e-s)*n+o},getOffsetAngle:function(){return this.object.rotation+this.getParentAngle()},offsetScaleX:function(){for(var t=this.object.parent,e=1;t;)e*=t.scale.x,t=t.parent;return e},offsetScaleY:function(){for(var t=this.object.parent,e=1;t;)e*=t.scale.y,t=t.parent;return e},getParentAngle:function(){for(var t=this.object.parent,e=0;t;)e+=t.rotation,t=t.parent;return e},hasParent:function(t){for(var e=t.object,i=this.object.parent;i;){if(i==e)return!0;i=i.parent}return!1},putTile:function(t,e,i){this.object.map.putTile(t,e,i,this.object)},getTile:function(t,e){return this.object.map.getTileWorldXY(t,e,void 0,void 0,this.object)},get isHidden(){return this.object.visible},set x(t){isNaN(t)||this.data.x!=t&&(this.object.x=t,this.data.x=t,this.updateBox(),this.manager.emit(MT.OBJECT_UPDATED_LOCAL,this))},get x(){return this.data.x||0},set y(t){isNaN(t)||this.data.y!=t&&(this.object.y=t,this.data.y=t,this.updateBox(),this.manager.emit(MT.OBJECT_UPDATED_LOCAL,this))},get y(){return this.data.y},set angle(t){this.data.angle!=t&&(isNaN(t)||(this.object.angle=t,this.data.angle=t,this.updateBox(),this.manager.emit(MT.OBJECT_UPDATED_LOCAL,this)))},get angle(){return this.data.angle},set anchorX(t){this.data.anchorX!=t&&(this.object.anchor.x=t||0,this.data.anchorX=this.object.anchor.x,this.data.width=this.object.width,this.updateBox(),this.manager.emit(MT.OBJECT_UPDATED_LOCAL,this))},get anchorX(){return this.data.anchorX||0},set anchorY(t){this.data.anchorY!=t&&(this.object.anchor.y=t||0,this.data.anchorY=t,this.data.height=this.object.height,this.updateBox(),this.manager.emit(MT.OBJECT_UPDATED_LOCAL,this))},get anchorY(){return this.data.anchorY||0},set width(t){t=parseFloat(t),isNaN(t)||this.data.width!=t&&(this.object.width=t,this.data.width=t,this.data.scaleX=this.object.scale.x,this.updateBox(),this.manager.emit(MT.OBJECT_UPDATED_LOCAL,this))},get width(){return this.data.width},set height(t){t=parseFloat(t),isNaN(t)||this.data.height!=t&&(this.object.height=t,this.data.height=t,this.data.scaleY=this.object.scale.y,this.updateBox(),this.manager.emit(MT.OBJECT_UPDATED_LOCAL,this))},get height(){return this.data.height},set scaleX(t){t=parseFloat(t),isNaN(t)||this.data.scaleX!=t&&(this.object.scale.x=t,this.data.scaleX=t,this.updateBox(),this.data.width=this.object.width,this.manager.emit(MT.OBJECT_UPDATED_LOCAL,this))},get scaleX(){return this.data.scaleX},set scaleY(t){t=parseFloat(t),isNaN(t)||this.data.scaleY!=t&&(this.object.scale.y=t,this.data.scaleY=t,this.updateBox(),this.data.height=this.object.height,this.manager.emit(MT.OBJECT_UPDATED_LOCAL,this))},get scaleY(){return this.data.scaleY},get assetId(){return this.data.assetId},set assetId(t){if(isNaN(this.data.assetId))throw new Error("Err");this.data.assetId!=t&&(this.data.assetId=t,this.object.loadTexture(t),this.manager.emit(MT.OBJECT_UPDATED_LOCAL,this))},set alpha(t){this.data.alpha!=t&&(isNaN(t)||(this.object.alpha=t,this.data.alpha=t,this.manager.emit(MT.OBJECT_UPDATED_LOCAL,this)))},get alpha(){return void 0==this.data.alpha?1:this.data.alpha},set frame(t){this.data.frame!=t&&(this.data.frame=t,this.object.frame=t,this.manager.emit(MT.OBJECT_UPDATED_LOCAL,this))},get frame(){return this.data.frame},set isFixedToCamera(t){this.data.isFixedToCamera!=t&&(this.object.fixedToCamera=t,this.data.isFixedToCamera=t,this.updateBox(),this.manager.emit(MT.OBJECT_UPDATED_LOCAL,this))},get isFixedToCamera(){return this.data.isFixedToCamera},set wordWrapWidth(t){this.data.wordWrapWidth!=t&&(this.object.wordWrapWidth=t,this.data.wordWrapWidth=t,this.updateBox(),this.manager.emit(MT.OBJECT_UPDATED_LOCAL,this))},get wordWrapWidth(){return this.data.wordWrapWidth||100},set wordWrap(t){this.data.wordWrap!=t&&(this.data.wordWrap=t,this.object.wordWrap=t,this.manager.emit(MT.OBJECT_UPDATED_LOCAL,this))},get wordWrap(){return this.data.wordWrap},set style(t){},get style(){return this.data.style||{}},set font(t){this.data.style.font!=this.object.font&&(this.object.font=t,this.data.style.font=this.object.font,this.manager.emit(MT.OBJECT_UPDATED_LOCAL,this))},get font(){return this.object.style.font},set fontFamily(t){this.data.style.fontFamily!=t&&(this.object.font=t,this.data.style.fontFamily=t,this.manager.emit(MT.OBJECT_UPDATED_LOCAL,this))},get fontFamily(){return this.data.style.fontFamily},set fontWeight(t){this.data.style.fontWeight!=t&&(this.object.fontWeight=t,this.data.style.fontWeight=t,this.manager.emit(MT.OBJECT_UPDATED_LOCAL,this))},get fontWeight(){return this.data.style.fontWeight},set fontSize(t){if(this.data.style.fontSize!=t){var e=this.object.scale.x,i=this.object.scale.y;this.object.fontSize=parseInt(t),this.data.style.fontSize=this.object.fontSize,this.scaleX=e,this.scaleY=i,this.manager.emit(MT.OBJECT_UPDATED_LOCAL,this)}},get fontSize(){return this.data.style.fontSize||(this.data.style.fontSize=this.object.fontSize),this.data.style.fontSize},set align(t){this.data.align!=t&&(this.data.align=t,this.object.align=t,this.manager.emit(MT.OBJECT_UPDATED_LOCAL,this))},get align(){return this.data.align},set fill(t){this.data.fill!=t&&(this.object.fill=t,this.data.fill=t,this.manager.emit(MT.OBJECT_UPDATED_LOCAL,this))},get fill(){return this.data.fill||"#000000"},set stroke(t){this.data.stroke!=t&&(this.object.stroke=t,this.data.stroke=t,this.manager.emit(MT.OBJECT_UPDATED_LOCAL,this))},get stroke(){return this.data.stroke||"#000000"},set strokeThickness(t){this.data.strokeThickness!=t&&(this.object.strokeThickness=t,this.data.strokeThickness=t,this.manager.emit(MT.OBJECT_UPDATED_LOCAL,this))},get strokeThickness(){return this.data.strokeThickness||0},setShadow:function(t,e,i,s){if(this.data.shadow){if(this.data.shadow.x==t&&this.data.shadow.y==e&&this.data.shadow.color==i&&this.data.shadow.blur==s)return}else this.data.shadow={};this.data.shadow.x=t,this.data.shadow.y=e,this.data.shadow.color=i,this.data.shadow.blur=s,this.object.setShadow(t,e,i,s),this.manager.emit(MT.OBJECT_UPDATED_LOCAL,this)},get shadowColor(){return this.data.shadow.color||"#000000"},get shadowOffsetX(){return this.data.shadow.x||0},get shadowOffsetY(){return this.data.shadow.y||0},get shadowBlur(){return this.data.shadow.blur||0},set text(t){this.object.text!=t&&(this.object.text=t,this.data.text=t,this.manager.emit(MT.OBJECT_UPDATED_LOCAL,this))},get text(){return this.data.text},set widthInTiles(t){this.data.widthInTiles!=t&&(this.data.widthInTiles=t,this.removeLayer(),this.createTileLayer(),this.manager.emit(MT.OBJECT_UPDATED_LOCAL,this))},get widthInTiles(){return this.data.widthInTiles},set heightInTiles(t){this.data.heightInTiles!=t&&(this.data.heightInTiles=t,this.removeLayer(),this.createTileLayer(),this.manager.emit(MT.OBJECT_UPDATED_LOCAL,this))},get heightInTiles(){return this.data.heightInTiles},set tileWidth(t){this.data.tileWidth!=t&&(this.data.tileWidth=t,this.removeLayer(),this.createTileLayer(),this.manager.emit(MT.OBJECT_UPDATED_LOCAL,this))},get tileWidth(){return this.data.tileWidth},set tileHeight(t){this.data.tileHeight!=t&&(this.data.tileHeight=t,this.removeLayer(),this.createTileLayer(),this.manager.emit(MT.OBJECT_UPDATED_LOCAL,this))},get tileHeight(){return this.data.tileHeight},getTileXY:function(t,e,i){return this.object.getTileXY(t,e,i)},removeLayer:function(){this.object.destroy();var t=this.map.tileLayers.indexOf(this.object);this.map.tileLayers.splice(t,1)},get isVisible(){for(var t=this;t.parent.magic;){if(!t.data.isVisible)return!1;t=t.parent.magic}return t.data.isVisible},get isLocked(){if(this.data.isLocked)return!0;for(var t=this.parent.magic;t;){if(t.data.isLocked)return!0;t=t.parent.magic}return!1},get id(){return this.data.id},get type(){return this.data.type},getBounds:function(){return this.object.getBounds()},_mapSettings:{},get mapSettings(){return this.data.type!=MT.objectTypes.TILE_LAYER?null:(this._mapSettings.gridX=this.tileWidth,this._mapSettings.gridY=this.tileHeight,this._mapSettings.gridOffsetX=this.x,this._mapSettings.gridOffsetY=this.y,void 0)}}),MT.namespace("core"),MT.extend("core.Emitter")(MT.core.Selector=function(){this._selected=[]},{add:function(t,e){void 0!==t&&(this.is(t)||(this._selected.push(t),e||this.emit("select",t)))},get count(){return this._selected.length},remove:function(t){for(var e=0;e<this._selected.length;e++)if(this._selected[e]==t)return this.emit("unselect",t),void this._selected.splice(e,1)},is:function(t){for(var e=0;e<this._selected.length;e++)if(this._selected[e]==t)return!0;return!1},get min(){return Math.min.apply(Math,this._selected)},get max(){return Math.max.apply(Math,this._selected)},forEach:function(t,e){if(this._selected)for(var i=!1,s=0;s<this._selected.length;s++)s==this._selected.length-1&&(i=!0),e?t.call(e,this._selected[s],i):t(this._selected[s],i)},sortAsc:function(){this._selected.sort()},clear:function(){for(var t=0;t<this._selected.length;t++)this.emit("unselect",this._selected[t]);this._selected.length=0,this.emit("clear")},get:function(t){return this._selected[t]}}),MT.namespace("core"),MT.namespace("core"),MT(MT.core.Helper=function(){},{isImage:function(t){var e=this.getExt(t);return"png"==e||"jpg"==e||"gif"==e||"jpeg"==e},isSource:function(t){return!this.isImage(t)},htmlEntities:function(t){return String(t).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")},isAudio:function(t){var e=this.getExt(t);return"mp3"==e||"wav"==e||"ogg"==e||"aac"==e},getExt:function(t){return t.split(".").pop().toLowerCase()},strToBuff:function(t){for(var e=new ArrayBuffer(2*t.length),i=new Uint16Array(e),s=0;s<t.length;s++)i[s]=t.charCodeAt(s);return e},select:function(t){var e=document.createRange();e.selectNodeContents(t);var i=window.getSelection();i.removeAllRanges(),i.addRange(e)},clearSelection:function(){window.getSelection().removeAllRanges()},uuid:function(){var t=(new Date).getTime(),e="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var i=(t+16*Math.random())%16|0;return t=Math.floor(t/16),("x"==e?i:3&i|8).toString(16)});return e},setCookie:function(t,e,i){var s="";if(i){var o=new Date;o.setTime(o.getTime()+24*i*60*60*1e3);var s="expires="+o.toUTCString()}document.cookie=t+"="+e+"; "+s},getCookie:function(t){for(var e=t+"=",i=document.cookie.split(";"),s=0;s<i.length;s++){for(var o=i[s];" "==o.charAt(0);)o=o.substring(1);if(0==o.indexOf(e))return o.substring(e.length,o.length)}return""},updateObject:function(t,e){for(var i in e)"object"==typeof e[i]?void 0==t[i]?t[i]=e[i]:this.updateObject(t[i],e[i]):t[i]=e[i]}}),function(){function t(t,e){var i=(65535&t)+(65535&e),s=(t>>16)+(e>>16)+(i>>16);return s<<16|65535&i}function e(t,e){return t>>>e|t<<32-e}function i(t,e){return t>>>e}function s(t,e,i){return t&e^~t&i}function o(t,e,i){return t&e^t&i^e&i}function a(t){return e(t,2)^e(t,13)^e(t,22)}function n(t){return e(t,6)^e(t,11)^e(t,25)}function h(t){return e(t,7)^e(t,18)^i(t,3)}function r(t){return e(t,17)^e(t,19)^i(t,10)}function l(e,i){var l,c,d,u,p,m,f,v,g,b,y,T,w=new Array(1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298),M=new Array(1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225),j=new Array(64);e[i>>5]|=128<<24-i%32,e[(i+64>>9<<4)+15]=i;for(var g=0;g<e.length;g+=16){l=M[0],c=M[1],d=M[2],u=M[3],p=M[4],m=M[5],f=M[6],v=M[7];for(var b=0;64>b;b++)j[b]=16>b?e[b+g]:t(t(t(r(j[b-2]),j[b-7]),h(j[b-15])),j[b-16]),y=t(t(t(t(v,n(p)),s(p,m,f)),w[b]),j[b]),T=t(a(l),o(l,c,d)),v=f,f=m,m=p,p=t(u,y),u=d,d=c,c=l,l=t(y,T);M[0]=t(l,M[0]),M[1]=t(c,M[1]),M[2]=t(d,M[2]),M[3]=t(u,M[3]),M[4]=t(p,M[4]),M[5]=t(m,M[5]),M[6]=t(f,M[6]),M[7]=t(v,M[7])}return M}function c(t){for(var e=Array(),i=(1<<p)-1,s=0;s<t.length*p;s+=p)e[s>>5]|=(t.charCodeAt(s/p)&i)<<24-s%32;return e}function d(t){for(var e=0,i=e?"0123456789ABCDEF":"0123456789abcdef",s="",o=0;o<4*t.length;o++)s+=i.charAt(t[o>>2]>>8*(3-o%4)+4&15)+i.charAt(t[o>>2]>>8*(3-o%4)&15);return s}function u(t){return d(l(c(t),t.length*p))}var p=16;MT.core.Helper.sha256=u}(),MT.namespace("ui"),MT.require("ui.DomElement"),MT.extend("core.Emitter")(MT.ui.TreeView=function(t,e){MT.core.Emitter.call(this),this.options={};for(var i in e)this.options[i]=e[i];this.tree=null,this.items=[],this.rootPath=e.root,void 0!=t&&this.create(t),this._onDrop=[]},{onDrop:function(t){this._onDrop.push(t)},create:function(t){this.tree=new MT.ui.DomElement,this.tree.style.position="relative",this.tree.addClass("ui-treeView"),this.updateFullPath(t),this.createObject(t,this.tree)},createObject:function(t,e){for(var i,s=0;s<t.length;s++)if(i=t[s],void 0===i.contents)this.addItem(i,e,s);else{var o=this.addItem(i,e,s);this.createObject(i.contents,o)}},getData:function(t,e){t=t||this.tree;for(var i=null,e=[],s=0;s<t.children.length;s++)i=t.children[s],i.data.contents&&(i.data.contents=this.getData(i)),e.push(i.data);return e},update:function(t){return t?void this.merge(t,this.tree):void this.merge(this.getData())},_nextId:1,mkid:function(){return++this._nextId},addItem:function(t,e,i,s){var o=this.checkExistingItem(t,e,i,s);if(o)return o;var a=this,n=t.contents?"folder":"item",h=new MT.ui.DomElement;h.options={},h.index=i,h.style.position="relative",h.addClass("ui-treeview-"+n),h.visible=!0,h.data=t,h.fullPath=t.fullPath;var r=new MT.ui.DomElement,l=new MT.ui.DomElement;if(r.label=l,r.addChild(l).show(),l.el.innerHTML=t.name,r.style.position="relative",l.addClass("ui-treeview-label"),l.style.position="relative",l.style.paddingLeft="30px",l.style.paddingRight="23px",r.show(h.el),h.head=r,r.parent=h,r.addClass("ui-treeview-item-head"),s)return h.show(e.el),h;if(e.addChild(h,h.index),e.data?e.data.isClosed===!1&&h.show():h.show(),"folder"==n&&(r.addClass("ui-treeview-folder-head"),t.isClosed||void 0===t.isClosed?(h.addClass("close"),h.visible=!1):h.addClass("open"),r.el.onclick=function(t){if(!(t.target!=h.head.el&&t.target!=h.head.label.el||h.isFolder&&t.offsetX>30))if(t.stopPropagation(),h.visible=!h.visible,h.visible){h.addClass("open"),h.removeClass("close");for(var e=0;e<h.children.length;e++)h.children[e].show();h.data.isClosed=!1,a.emit("open",h)}else{h.data.isClosed=!0,h.addClass("close"),h.removeClass("open");for(var e=0;e<h.children.length;e++)h.children[e].hide();a.emit("close",h)}},h.show(),h.isFolder=!0),"item"==n&&(h.isFolder=!1,!t.type,"input"==t.type)){var c=new MT.ui.DomElement("span");c.el.innerHTML="88",c.x=50,r.addChild(c),h.head=c}if(t.__image&&this.addImage(h,t),this.options.showHide){h.addClass("show-hide-enabled");var d=this._mkShowHide(h);t.isVisible||d.addClass("hidden"),h.options.showHide=d}if(this.options.lock){h.addClass("lock-enabled");var d=this._mkLock(h);t.isLocked||d.addClass("locked"),h.options.lock=d}return l.el.ondblclick=function(t){h.isFolder&&t.offsetX<30||(a.emit("dblclick",t,h),a.enableRename(h,t),t.stopPropagation(),t.preventDefault())},h.el.onmouseover=function(t){a.emit("mouseover",t,h)},h.el.onmouseout=function(t){a.emit("mouseout",t,h)},this.items.push(h),h.needRemove=!1,h.tvItem=!0,e.hasClass("close")&&h.hide(),h},addImage:function(t,e){var i;t.head.addClass("has-image"),i=document.createElement("img"),i.src=this.rootPath+"/"+e.__image,t.head.el.appendChild(i),i.style.pointerEvents="none",t.img=i},removeImage:function(t){t.head.removeClass("has-image"),t.img&&(t.head.el.removeChild(t.img),t.img=null)},checkExistingItem:function(t,e,i){for(var s,o,a=0;a<this.items.length;a++)if(void 0==t.id&&(t.id=this.mkid()),this.items[a].data.id==t.id){this.items[a].needRemove=!1,s=this.items[a],o=s.parent,o&&(o.removeChild(s),o.addChild(s,i).show());for(var n in t)s.data[n]=t[n];return e.hasClass("close")&&s.hide(),s._parent!=e.el&&(s.el.parentNode&&s.el.parentNode.removeChild(s.el),s.parent.removeChild(s),e.addChild(s).show(),e.visible||s.hide()),s.options.showHide&&(t.isVisible?s.options.showHide.removeClass("hidden"):s.options.showHide.addClass("hidden")),s.options.lock&&(t.isLocked?s.options.lock.removeClass("locked"):s.options.lock.addClass("locked")),t.__image?s.img?s.img.src=this.rootPath+"/"+t.__image+"?"+Date.now():this.addImage(s,t):this.removeImage(s),s.head.label.el.innerHTML=t.name,s}},addShowHide:function(){for(var t=0;t<this.items.length;t++)this._mkShowHide(this.items[t])},_mkShowHide:function(t){var e=this,i=new MT.ui.Button("","show-hide",null,function(i){t.data.isVisible=!t.data.isVisible,t.data.isVisible?i.target.ctrl.removeClass("hidden"):i.target.ctrl.addClass("hidden"),e.emit("show",t),i.stopPropagation(),i.preventDefault()});return t.head.el.appendChild(i.el),i.parent=t,i},addLock:function(){for(var t=0;t<this.items.length;t++)this._mkLock(this.items[t])},_mkLock:function(t){var e=this,i=new MT.ui.Button("","lock",null,function(i){t.data.isLocked=!t.data.isLocked,t.data.isLocked?i.target.ctrl.removeClass("locked"):i.target.ctrl.addClass("locked"),e.emit("lock",t),i.stopPropagation()});return t.head.el.appendChild(i.el),i.parent=t,i},enableInput:function(t){var e=this,i=null;t.on("mousedown",function(t){t.target.parentNode&&(i=e.getOwnItem(t.target.parentNode.parentNode))}),t.on("mouseup",function(t){if(t.target.ctrl&&t.target.ctrl.hasParent(e.tree)&&!e.dragged){var s=e.getOwnItem(t.target.parentNode.parentNode);s&&s==i&&(0==t.button?e.emit("click",s.data,s):2==t.button&&e.emit("context",t,s))}})},sortable:function(t){var e=this.addItem({name:"&nbsp;",skip:!0},this.tree,0,!0);e.style.position="absolute",e.style.pointerEvents="none",e.style.bottom="auto",e.style.opacity=.8,e.style.border="solid 2px #000",e.style.zindex=9999,e.style.backgroundColor="#f00";var i=new MT.ui.DomElement("div");i.style.position="absolute",i.style.height="4px",i.style.pointerEvents="none",i.style.display="none",i.style.zIndex=9999;var s=e.el.parentNode;e.addClass("active ui-wrap"),s.appendChild(e.el),e.style.display="none",document.body.appendChild(i.el);var o=this,a=!1,n=0,h=null,r=0,l=!1,c=null,d=!1,u=!1,p=function(t,e){t.el.parentNode&&t.el.parentNode.removeChild(t.el),t.parent.removeChild(t),u?e.addChild(t,-1):(d?e.parent.addChild(t,e.index):e.parent.addChild(t,e.index-1),t.parent.hasClass("close")&&t.hide())};this.enableInput(t);var m={x:0,y:0};t.on("mousedown",function(i){if(i.target.parentNode&&(h=o.getOwnItem(i.target.parentNode.parentNode))){o.emit("dragstart",i,h),a=!0,r=o.tree.el.scrollTop;var s=h.calcOffsetY(o.tree.el);e.y=s,e.style.left="0",e.style.right="0",n=s-t.mouse.y,m.x=t.mouse.x,m.y=t.mouse.y}}),t.on("mouseup",function(t){if(e.style.display="none",i.style.display="none",e.y=0,a&&(a=!1,o.emit("dragend",t,h),l)){l=!1;for(var s=0;s<o._onDrop.length;s++)if(o._onDrop[s](t,h,c)===!1)return;if(!c||c==h||c.hasParent(h))return void(c=null);if(p(h,c),h.hasClass("selected"))for(var s=0;s<o.items.length;s++){var n=o.items[s];n.hasClass("selected")&&h!=n&&c!=n&&p(n,c)}o.updateFullPath(o.getData(),null,!0)}}),t.on("mousemove",function(s){if(a&&h&&!(Math.abs(m.x-t.mouse.x)<5&&Math.abs(m.y-t.mouse.y)<5)){if(l=!0,o.emit("dragmove",s,h),s.isPropagationStopped||!MT.ui.hasParent(s.target,o.tree.el))return e.style.display="none",i.style.display="none",e.y=0,void(l=!1);e.style.zIndex=9999,e.style.display="block",e.head.el.innerHTML="&nbsp;";var n=e.bounds,r=t.mouse.y;e.y=r-.5*n.height-o.tree.bounds.top+o.tree.el.scrollTop,e.style.height="auto",i.style.display="block",i.style.top=r-.5*n.height+"px",i.style.left=n.left+"px",i.style.width=n.width+"px",i.style.height=n.height+"px",n=i.bounds;var p,f,v=0;c=null;for(var g,b=0;b<o.items.length;b++)if(p=o.items[b],f=p.head,g=p.head.bounds,v<g.top+g.height&&(v=g.top+g.height),r>g.top&&r<g.top+g.height+5){if(c=p,c==h)return;return e.y=g.top-o.tree.bounds.top+o.tree.el.scrollTop,u=p.isFolder,d=!1,u?(r-g.top<10&&(u=!1,e.y=g.top-o.tree.bounds.top+o.tree.el.scrollTop,e.style.height=.5*e.height,e.y-=.5*e.height),void(g.top+g.height-r<5&&c.data.isClosed===!0&&(u=!1,d=!0,e.y=g.top-o.tree.bounds.top+g.height+o.tree.el.scrollTop,e.style.height=.5*e.height,e.y-=.5*e.height))):void(r-g.top<g.top+g.height-r?(u=!1,e.y=g.top-o.tree.bounds.top+o.tree.el.scrollTop,e.style.height=.5*e.height,e.y-=.5*e.height):(u=!1,d=!0,e.y=g.top-o.tree.bounds.top+g.height+o.tree.el.scrollTop,e.style.height=.5*e.height,e.y-=.5*e.height))
}var y=o.tree.children;o.items.length&&(r>v?(e.y=v-o.tree.bounds.top+5+o.tree.el.scrollTop,e.style.height=.5*e.height,d=!0,u=!1,c=y[y.length-1]):r-o.tree.bounds.top<20&&(e.y=.25*-e.height,e.style.height=.5*e.height,c=y[0]))}})},disableRename:function(){this.renameEnabled=!1},renameEnabled:!0,enableRename:function(t){if(this.renameEnabled){var e=this;this.emit("renameStart"),this.input||(this.input=document.createElement("input"),this.input.className="ui-input");var i=t.head.calcOffsetX(document.body);t.img&&(i+=20),this.input.style.left=i+"px",this.input.style.top=t.calcOffsetY(document.body)-2+"px",this.input.value=t.data.name;var s=t.data.name;this.input.type="text",t.head.label.el.innerHTML="&nbsp;",document.body.appendChild(this.input);var o=!0;this.input.onblur=function(){try{this.parentNode&&this.parentNode.removeChild(this)}catch(i){}if(o&&""!=this.value){var a="";t.parent.data&&(a=t.parent.data.fullPath);var n=t.data.name;t.data.fullPath=a+"/"+this.value,t.data.name=this.value,t.head.label.el.innerHTML=this.value;var h=a+"/"+n,r=a+"/"+this.value;h!==r&&(e.emit("change",a+"/"+n,a+"/"+this.value),e.emit("rename",t,n))}else t.head.label.el.innerHTML=s},this.input.onkeyup=function(t){t.which==MT.keys.ESC&&(o=!1,this.blur()),t.which==MT.keys.ENTER&&this.blur(),t.preventDefault(),t.stopPropagation()},this.input.focus();var a=t.data.name.split("."),n=0;n=1==a.length?a[0].length:-1;for(var h=0;h<a.length-1;h++)n+=a[h].length+1;this.input.setSelectionRange(0,n),this.inputEnabled=!0}},remove:function(){this.tree.hide()},merge:function(t){this.data=t;var e=this.tree.el.scrollTop;this.tree.hide();this.tree.el.parentNode;this.updateFullPath(t);for(var i=0;i<this.items.length;i++)this.items[i].needRemove=!0;this.createObject(t,this.tree);for(var i=0;i<this.items.length;i++)this.items[i].needRemove&&(this.items[i].parent.removeChild(this.items[i]),this.items[i].hide(),this.items.splice(i,1),i--,this.emit("deleted",this.items[i]));0!==t.length&&this.tree.show(),this.tree.el.scrollTop=e},getOwnItem:function(t){for(var e=t;e&&(!e.ctrl||!e.ctrl.tvItem);)e=e.parentElement;if(!e)return null;for(var i=0;i<this.items.length;i++)if(e==this.items[i].el)return this.items[i];return null},updateFullPath:function(t,e,i){e=e||"";for(var s=0;s<t.length;s++){var o=e+"/"+t[s].name,a=t[s].fullPath;t[s].fullPath=o,a!=o&&i&&this.emit("change",a,o),t[s].contents&&this.updateFullPath(t[s].contents,t[s].fullPath,i)}i&&this.emit("change",null,null)},select:function(t,e){for(var i=0;i<this.items.length;i++)if(t==this.items[i].data.id)return e?this.items[i]:void this.emit("select",this.items[i].data,this.items[i])},getById:function(t){for(var e=0;e<this.items.length;e++)if(t==this.items[e].data.id)return this.items[e]},show:function(t){this.tree.show(t)}}),MT.namespace("ui"),MT(MT.ui.DomElement=function(t){t=t||"div",this.el=document.createElement(t),this.style=this.el.style,this.el.ctrl=this,this.index=0,this.isVisible=!1,this.children=[]},{_parent:null,appendChild:function(t){return t.parent=this,t.show(this.el),t},hasParent:function(t){for(var e=this.parent;e;){if(e==t)return!0;e=e.parent}},isParentTo:function(t){for(var e=t;e;){if(e==this.el)return!0;e=e.parentNode}return!1},remove:function(){this.el.parentNode&&this.el.parentNode.removeChild(this.el)},show:function(t){void 0==t?(this.parent&&(this._parent=this.parent.el),this._parent||(this._parent=document.body)):this._parent=t,this._parent.appendChild(this.el),this.isVisible=!0},hide:function(){return this.el.parentNode?(this.el.parentNode.removeChild(this.el),this.isVisible=!1,this):this},hideToTop:function(){this.y=-this.height},addClass:function(t){var e=t.split(".");if(e.length>1)for(var i=0;i<e.length;i++)this.addClass(e[i]);else{if(e=t.split(" "),!(e.length>1))return this.hasClass(t)||(this.el.className=(this.el.className+" "+t).trim()),this;for(var i=0;i<e.length;i++)this.addClass(e[i])}},removeClass:function(t){var e=t.split(".");if(e.length>1)for(var i=0;i<e.length;i++)this.removeClass(e[i]);else{if(e=t.split(" "),!(e.length>1)){for(var s=this.el.className.split(" "),i=0;i<s.length;i++)t==s[i]&&(s[i]=s[s.length-1],s.length=s.length-1);return this.el.className=s.join(" "),this}for(var i=0;i<e.length;i++)this.removeClass(e[i])}},hasClass:function(t){for(var e=this.el.className.split(" "),i=0;i<e.length;i++)if(t==e[i])return!0;return!1},_x:0,set x(t){this.setX(t)},setX:function(t){this._x=t,this.style.left=t+"px"},get x(){return this.isFitted?this.calcOffsetX():this._x},_y:0,set y(t){this.setY(t)},setY:function(t){this._y=t,this.style.top=t},get y(){return this.isFitted?this.calcOffsetY():this._y},_height:0,get height(){return this.isFitted?this.el.offsetHeight:this._height?this._height:this.el.offsetHeight},set height(t){this.setHeight(t)},setHeight:function(t){this._height=t,this.style.height=0==t?"auto":t+"px"},_width:0,get width(){return this.isFitted?this.el.offsetWidth:this._width?this._width:this.el.offsetWidth},set width(t){this.setWidth(t)},setWidth:function(t){t&&(this._width=t,this.style.width=t+"px")},resize:function(t,e){this.width=t||this._width,this.height=e||this._height},calcOffsetY:function(t){t=t||document.body;var e=this.el.offsetTop;for(p=this.el.offsetParent;p&&p!=t;)e+=p.offsetTop-p.scrollTop,p=p.offsetParent;return e},calcOffsetX:function(t){t=t||document.body;var e=this.el.offsetLeft;for(p=this.el.offsetParent;p&&p!=t;)e+=p.offsetLeft-p.scrollLeft,p=p.offsetParent;return e},ox:0,oy:0,setAbsolute:function(t,e){this.style.position="absolute",t?this.style.bottom=0:this.style.top=0,e?this.style.right=0:this.style.left=0},isFitted:!1,fitIn:function(){this.style.position="absolute",this.style.top=0,this.style.right=0,this.style.bottom=0,this.style.left=0,this.style.height="auto",this.style.width="auto",this.isFitted=!0},unfit:function(){this.isFitted=!1},inheritSize:function(t){this.x=t.x,this.y=t.y,this.width=t.width,this.height=t.height},getStyle:function(){return window.getComputedStyle(this.el)},sort:function(t,e){return t.index-e.index},addChild:function(t,e){if(t.index=e,this.children.push(t),this.children.sort(this.sort),void 0!==e)for(var i=null,s=0;s<this.children.length;s++)i=this.children[s],i.index=s,i.el.parentNode&&i.el.parentNode.removeChild(i.el),i.isVisible&&this.el.appendChild(i.el);else t.isVisible&&(t.el.parentNode&&t.el.parentNode!=this.el&&t.el.parentNode.removeChild(t.el),t.el.parentNode!==this.el&&this.el.appendChild(t.el));return t.parent=this,t},removeChild:function(t){t.el.parentNode==this.el&&this.el.removeChild(t.el);for(var e=0;e<this.children.length;e++)if(this.children[e]==t)return void this.children.splice(e,1)},_index:0,get index(){return this._index},set index(t){this._index=t},clear:function(){for(;this.el.children.length;)this.el.children[0].ctrl?this.el.children[0].ctrl.hide():this.el.removeChild(this.el.children[0])},get bounds(){return this.el.getBoundingClientRect()}}),MT.namespace("ui"),MT.extend("ui.DomElement")(MT.ui.PanelHead=function(t){MT.ui.DomElement.call(this),this.addClass("ui-panel-header"),this.panel=t,this.el.panel=t,this.tabs=[]},{addTab:function(t){var e=new MT.ui.DomElement("span");e.addClass("panel-head-tab"),e.title=document.createElement("span"),e.title.innerHTML=t,e.el.setAttribute("title",t),e.el.appendChild(e.title),e.panel=e.el.panel=this.panel;return e.el.data={panel:this.panel},0==this.tabs.length&&e.addClass("active"),this.tabs.push(e),this.appendChild(e),e},allowRename:function(){},removeTab:function(t){for(var e=0;e<this.tabs.length;e++)if(this.tabs[e]==t)return void this.tabs.splice(e,1)},setTabs:function(t){for(var e=0;e<this.tabs.length;e++)this.tabs[e].remove();this.tabs=t;100/this.tabs.length;this.showTabs()},showTabs:function(){this.tabs.length||console.error("TABELEES");for(var t=100/this.tabs.length,e=0;e<this.tabs.length;e++)this.appendChild(this.tabs[e]),this.tabs[e].style.width=t+"%",this.tabs[e].panel==this.panel&&this.setActiveTab(this.tabs[e])},updateTabs:function(){for(var t=0;t<this.tabs.length;t++)this.tabs[t].remove(),this.appendChild(this.tabs[t])},setActiveTab:function(t){t=t||this.panel.mainTab;for(var e=null,i=0;i<this.tabs.length;i++)e=this.tabs[i],e!=t?e.removeClass("active"):e.addClass("active")},setActiveIndex:function(t){for(var e=null,i=0;i<this.tabs.length;i++)e=this.tabs[i],i!=t?e.removeClass("active"):e.addClass("active")}}),MT.namespace("ui"),MT.extend("ui.DomElement")(MT.ui.Button=function(t,e,i,s,o){MT.ui.DomElement.call(this),o&&this.el.setAttribute("data-tooltip",o),this.addClass("ui-button"),e&&this.addClass(e),void 0!=t&&(this.text=t),s&&(this.el.onclick=s)},{set text(t){this.el.innerHTML=t},get text(){return this.el.innerHTML}}),MT.namespace("core"),MT(MT.core.Emitter=function(){this.callbacks={}},{on:function(t,e,i){if(void 0==t)return void console.error("undefined action");if("function"!=typeof e)return void console.error("event",t,"not a function:",e);{if(!Array.isArray(t))return this.callbacks||(this.callbacks={}),this.callbacks[t]||(this.callbacks[t]=[]),this.callbacks[t].push(e),e.priority=i||this.callbacks[t].length,this.callbacks[t].sort(function(t,e){return t.priority-e.priority}),e;for(var s=0;s<t.length;s++)this.on(t[s],e)}},once:function(t,e){if("function"!=typeof e)return void console.error("event",t,"not a function:",e);if(Array.isArray(t))for(var i=0;i<t.length;i++)this.once(t[i],e);else{var s=this,o=function(i){e(i,e),s.off(t,o)};this.on(t,o)}},off:function(t,e){if(void 0===e&&(e=t,t=void 0),!t||this.callbacks[t]){if(t)return void this._off(e,t);for(var i in this.callbacks)void 0!=e?this._off(e,i):this.callbacks[i].length=0}},_off:function(t,e){var i=0,s=this.callbacks[e];for(i=0;i<s.length;i++)s[i]===t&&s.splice(i,1);return t},emit:function(t,e,i){if(this.callbacks&&this.callbacks[t])for(var s=this.callbacks[t],o=0;o<s.length;o++)s[o](e,i)},debug:function(t){try{throw new Error}catch(e){var i=e.stack.split("\n");i.splice(0,3),console.log("EMIT: ",t),console.log(i.join("\n"))}}}),MT.namespace("core"),MT(MT.core.BasicPlugin=function(t){this.channel=t,this.dealys={}},{initUI:function(t){this.ui=t},initSocket:function(t){if(void 0!=this.channel&&this.socket!=t){var e=this;this.socket=t,this.socket.on(this.channel,function(t,i){var s="a_"+t;e[s]?e[s](i):console.warn("unknown action",e.channel+"["+s+"]",i)})}},send:function(t,e,i){this.socket.send(this.channel,t,e,i)},sendDelayed:function(t,e,i){var s=this;this.dealys[t]&&window.clearTimeout(this.dealys[t]),this.dealys[t]=window.setTimeout(function(){s.send(t,e),s.dealys[t]=0},i)}}),MT.namespace("ui"),MT(MT.ui.InputCollection=function(t,e,i){this.object=i||{},this.inputs={};for(var s in e)e[s].key||(e[s].key=s),this.inputs[s]=new MT.ui.Input(t,e[s],this.object)},{show:function(t){for(var e in this.inputs)this.inputs[e].show(t)},hide:function(){for(var t in this.inputs)this.inputs[t].hide()}}),MT.namespace("ui"),MT.extend("core.Emitter")(MT.ui.FrameControl=function(t){this.mm=t,this.el=new MT.ui.DomElement("div"),this.el.addClass("ui-frame-control"),this.sepHolder=document.createElement("div"),this.sepHolder.className="ui-frame-sep-holder",this.el.el.appendChild(this.sepHolder),this.el.style.position="absolute",this.handle=document.createElement("div"),this.handle.className="ui-frame-handle",this.background=document.createElement("div"),this.background.className="ui-frame-background",this.el.el.appendChild(this.background),this.sliderContainer=document.createElement("div"),this.sliderContainer.className="ui-frame-control-slider-container",this.slh=new MT.ui.SliderHelper(0,0,1/0),this.slider=document.createElement("div"),this.slider.className="ui-frame-control-slider",this.sliderContainer.appendChild(this.slider),this.showSlider();var e=!1,i=this,s=150,o=150;this.slider.style.width=o+"px",this.slider.onmousedown=function(){e=!0,s=o+50};var a=this.mm.ui.events,n=1,h=0;a.on(a.MOUSEMOVE,function(){if(e){i.slh.change(a.mouse.mx);var t=i.sliderContainer.offsetWidth-s;i.slh<t?i.slider.style.left=i.slh+"px":(h=.01*(i.slh-t),console.log("impact:",h),w=o),i.emit("change",i.slh.value*(1+h),n);{i.slider.offsetLeft+i.slider.offsetWidth}i.mm.changeFrame()}}),a.on(a.MOUSEUP,function(){e=!1,i.slh.reset()}),this.builtSpans=[],this.builtDivs=[],this.labels=[]},{build:function(){this.clear();var t,e=this.mm.keyframes,i=(e.getLastFrame(),this.mm.frameSize),s=Math.floor(this.mm.frameOffset+.5*i),o=this.mm.rightPanel.width,a=Math.ceil(o/i),n=e.getFps(),h=Math.ceil(a/n),r=Math.floor(this.mm.startFrame/n),l=Math.floor(1.5/this.mm.scale);1>l&&(l=1);for(var c,d=0,u=5,p=0;a>p;p+=l){if(t=this.builtSpans[p],t?(t.parentNode&&t.parentNode.removeChild(t),t.removeAttribute("data-seconds")):(t=document.createElement("span"),this.builtSpans.push(t)),t.className="ui-frame-sep",t.style.left=p*i+s,this.sepHolder.appendChild(t),c=p+this.mm.startFrame,u=(c+"").length>2?10:5,d%u==0)if(t.className="ui-frame-sep ui-frame-sep-long",p+this.mm.startFrame>180){var m=Math.round(10*(p+this.mm.startFrame)/n)/10;if(m>60){var e=Math.round(m/60);m=e+"m "+Math.round(m%60)+"s"}else m+="s";t.setAttribute("data-seconds",m)}else t.setAttribute("data-seconds",p+this.mm.startFrame);d++}for(var f=0,v=0,p=0;h+r+5>p;p++)p%2?f+=i*n:(v=i*n+(-this.mm.startFrame*i+f),-40>v?f+=i*n:(t=this.builtDivs[p],t||(t=document.createElement("div"),this.builtDivs.push(t),t.parentNode&&t.parentNode.removeChild(t)),t.className="ui-frame-seconds",t.style.width=i*n+"px",t.style.left=-this.mm.startFrame*i+f+s+"px",this.background.appendChild(t),f+=i*n));this.sepHolder.appendChild(this.handle),this.adjustHandle(),this.showSlider()},adjustHandle:function(){this.handle.style.left=this.mm.slider.x-.5*this.handle.offsetWidth+.5*this.mm.slider.width+"px",this.mm.activeFrame>180,this.handle.innerHTML=this.mm.activeFrame},hide:function(){this.el.el.parentNode&&this.el.el.parentNode.removeChild(this.el.el),this.clear()},clear:function(){this.sepHolder.innerHTML="",this.background.innerHTML="",this.handle.parentNode&&this.handle.parentNode.removeChild(this.handle),this.hideSlider()},showSlider:function(){this.mm.rightPanel.el.appendChild(this.sliderContainer)},hideSlider:function(){this.sliderContainer.parentNode&&this.sliderContainer.parentNode.removeChild(this.sliderContainer)}}),MT.namespace("ui"),MT.extend("ui.Keyframes")(MT.ui.MovieLayer=function(t){MT.ui.Keyframes.call(this,t)},{setData:function(t){this.hide(),this.data=t,this.activeMovie="__main",this.buildData(),this.tv.merge(t.contents),this.updateFrames()},sortFrames:function(){var t,e;for(var i in this.mm.items){t=this.mm.items[i];for(var s in t.movies)e=t.movies[s],e.frames.sort(function(t,e){return t.keyframe-e.keyframe});return}},drawFrame:function(t,e,i,s,o){if(!o.submovie)return void MT.ui.Keyframes.drawFrame.call(this,t,e,i,s);var o=t[e],a=this.mm.startFrame,n=this.mm.frameSize;if(!(t[e].keyframe<this.mm.startFrame-o.length)){var h=this.getFrameElement();h.style.width=o.length*n+"px",h.style.left=o.keyframe*n+this.mm.frameOffset-a*n+"px",h.frameInfo={frames:t,index:e},h.className=this.mm.selectedFrame==o?"ui-kf-frame active ui-kf-frame-main":"ui-kf-frame ui-kf-frame-main",i.appendChild(h)}},changeFrame:function(t){for(var e,i,s,o,a,n,h,r,l=0;l<this.data.contents.length;l++){if(i=this.data.contents[l],e=this.mm.map.getById(i.objectId),!e){var c=this;return void window.setTimeout(function(){c.changeFrame(t)},100)}e.changeMovieFrame(this.activeMovie,t,!0),n=i.contents;for(var d=0;d<n.length;d++)if(s=n[d],o=s.name,a=s.movies[this.activeMovie]){var u=a.frames;if(0!==u.length){r=t;for(var p=0;p<u.length;p++)if(h=u[p],h.keyframe<=t&&h.keyframe+h.length>t){r=t-h.keyframe,e.changeChildrenMovieFrame(s.name,r);break}}}}},saveActiveFrame:function(t){if(this.active){var e=this.active.data;if(!e.submovie)return void MT.ui.Keyframes.saveActiveFrame.call(this,t);for(var i,s=this.active.data.movies[this.activeMovie],o=s.frames,a=0;a<o.length;a++)if(i=o[a],i.keyframe<this.mm.activeFrame&&i.length>this.mm.activeFrame)return;o.push({keyframe:this.mm.activeFrame,length:e.info.lastFrame}),this.mm.sortFrames(o),this.mm.redrawAll(),this.mm.om.sync()}}}),MT.namespace("ui"),MT.extend("core.Emitter")(MT.ui.Keyframes=function(t){this.panelCollections={};var e=t.ui,i=t.leftPanel.content,s=t.rightPanel.content;this.createdFrames=[],this.autoAddButtons=[],this.frameHolderWrapper=document.createElement("div"),this.frameHolderWrapper.className="ui-frameHolderWrapper",this.mm=t,this.om=this.mm.project.plugins.objectmanager;var o=this;this.data={},this.tv=new MT.ui.TreeView([],{root:pp.path}),this.tv.tree.addClass("ui-keyframes-tree"),this.scrollTop=0,this.tv.tree.el.onscroll=function(){o.scrollTop=o.tv.tree.el.scrollTop,o.hideFrames(),o.showFrames()};var a=function(t,e){return t.isMovie?(o.unselect(),o.active=e,void e.addClass("active")):t.isMovie&&o.activeMovie!=t.name?(o.activeMovie=t.name,o.markFirstFrame(),o.hideFrames(),o.showFrames(),void o.updateTree(t)):(o.hideFrames(),o.emit("select",t),void o.showFrames())};this.tv.on("click",function(t,e){a(t,e)}),this.tv.on("open",function(t){a(t.data,t)}),this.tv.on("close",function(){o.hideFrames(),o.showFrames()}),this.tv.enableInput(e.events),this.tv.disableRename(),this.ui=e,this.el=document.createElement("div"),this.el.className="ui-kf-container",this.label=document.createElement("div"),this.label.innerHTML=this.name,this.label.className="ui-kf-label",this.framesHolders=[],this.buildFrames(),this.frames=frames,this.frameElements=[],this.d1=i,this.d2=s,this.addControls(),this.show()},{activeMovie:"",getMovie:function(){return this.data&&this.data.movies?this.data.movies[this.activeMovie]:null},get panels(){return this.panelCollections[this.data.id]||(this.panelCollections[this.data.id]={}),this.panelCollections[this.data.id]},setData:function(t){this.hide(),this.data=t,this.activeMovie="",this.buildData(),this.tv.merge([t]),this.updateFrames()},buildData:function(){var t,e=this.data.movies;for(var i in e)i!=this.mm.mainName&&(""==this.activeMovie&&(this.activeMovie=i),t?this.createPanel(i,t):t=this.createPanel(i,t));""!=this.activeMovie&&this.fpsInput.setObject(this.data.movies[this.activeMovie].info)},rebuildData:function(){var t,e;for(var i in this.dataIn.movies)this.panels[i]?t||(t=this.panels[i]):(e=this.createPanel(i,t),e.show());this.show(),this.panels[this.activeMovie].show()},updateTree:function(t){this.data=t,this.buildData(),this.tv.merge(this.data),this.hideFrames(),this.showFrames()},createPanel:function(t,e){var i=this.panels[t];if(i)return i.hide(),i;i=new MT.ui.Panel(t),i.name=t,this.panels[t]=i,i.fitIn(),i.hide(),e?e.addJoint(i):(i.show(this.mm.panel.content.el),i.fitIn()),i.el.style.height="18px";var s=this;return i.on("show",function(){s.activeMovie=i.name,s.mm.changeFrame(0),s.fpsInput.setObject(s.data.movies[s.activeMovie].info),s.updateFrames()}),i.on("rename",function(t,e){s.rename(t,e)}),i.isRenamable=!0,i.removeBorder(),i},rename:function(t,e){var i,s;"__main"==t&&(t+="1");for(var o in this.mm.items)i=this.mm.items[o],i.movies[t]||(s=i.movies[e],delete i.movies[e],i.movies[t]=s);var a=this.panels[e];delete this.panels[e],this.panels[t]=a,a.name=t,this.activeMovie==e&&(this.activeMovie=t),this.updateFrames()},removeConf:function(t){var e=new MT.ui.Popup("Delete movie?","Are you sure you want to delete movie: "+MT.core.Helper.htmlEntities(t)+"?"),i=this;e.addButton("no",function(){e.hide()}),e.addButton("yes",function(){i.remove(t),e.hide()}),e.showClose()},remove:function(t){var e,i;for(var s in this.mm.items)e=this.mm.items[s],i=e.movies[t],delete e.movies[t];this.panels[t].close();var o=Object.keys(this.data.movies);return o.length?(this.activeMovie=o[0],this.mm.redrawAll(),void this.om.sync()):(this.mm.clear(),this.activeMovie=null,this.mm.activeMovie=null,this.om.sync(),void this.mm.setActive(this.mm.data))},isVisible:!1,hide:function(){if(this.isVisible){this.isVisible=!1,this.tv.tree.hide(),this.hideFrames(),this.controlsHolder.parentNode&&this.controlsHolder.parentNode.removeChild(this.controlsHolder);for(var t in this.panels)this.panels[t].hide();this.mm.leftPanel.style.borderRightStyle="none"}},hideFrames:function(){this.frameHolderWrapper.parentNode&&this.frameHolderWrapper.parentNode.removeChild(this.frameHolderWrapper);for(var t=0;t<this.framesHolders.length;t++)this.framesHolders[t].hide()},show:function(){this.isVisible||(this.isVisible=!0,this.tv.tree.show(this.d1.el),this.panels[this.activeMovie]&&this.panels[this.activeMovie].show(),this.mm.leftPanel.style.borderRightStyle="solid",this.mm.leftPanel.content.el.appendChild(this.controlsHolder),this.showFrames())},showFrames:function(){this.d2.el.appendChild(this.frameHolderWrapper);for(var t,e,i,s,o=this.frameHolderWrapper,a=this.d2.bounds,n=0;n<this.tv.items.length;n++){e=this.framesHolders[n],e||(e=this.addFrameHolder());var h=this.tv.items[n].data;if(t=this.tv.items[n].head,this.active==this.tv.items[n]?e.addClass("active"):e.removeClass("active"),!t.isVisible)return;i=t.bounds,h.unselectable&&e.addClass("unselectable"),0==n?(e.addClass("top"),e.style.height=i.height+2+"px",s=i.top-a.top+this.d2.el.scrollTop-1-o.offsetTop):(e.removeClass("top"),e.style.height=i.height+"px",s=i.top-a.top+this.d2.el.scrollTop+1-o.offsetTop),e.style.top=s+"px",e.el.data=h,i.height>0?o.appendChild(e.el):e.hide()}this.tv.tree.el.scrollTop=this.scrollTop},active:null,setActiveObject:function(t){this.unselect();var e=this.tv.getById(t);e&&(e.addClass("active"),this.active=e)},unselect:function(){this.active&&(this.active.removeClass("active"),this.active=null)},buildFrames:function(){for(var t,e=this.tv.items,i=0;i<e.length;i++)t=this.addFrameHolder(),this.markFrames(e[i],t.el);this.firstFrame=this.framesHolders[0],this.makeControls()},addFrameHolder:function(){var t=new MT.ui.DomElement("div");return t.addClass("ui-kf-frames"),t.style.position="absolute",this.framesHolders.push(t),t.el.innerHTML="",t},updateFrames:function(){this.lastFrameAccessed=0,this.autoAddInc=0;for(var t,e=this.tv.items,i=0;i<e.length;i++){for(t=this.framesHolders[i],t||(t=this.addFrameHolder());t.el.firstChild;)t.el.removeChild(t.el.firstChild);this.markFrames(e[i],t.el)}this.firstFrame=this.framesHolders[0]},makeControls:function(){},markFrames:function(t,e){if(this.activeMovie){var i=t.data;i.movies&&i.movies[this.activeMovie]||this.mm.addMovie(i,this.activeMovie);var s=i.movies[this.activeMovie],o=s.frames;o||(this.mm.addMovie(i,this.activeMovie),s=i.movies[this.activeMovie],o=s.frames),this.addAutoFrame(t.data,s,e);for(var a=0;a<o.length;a++)this.drawFrame(o,a,e,s,t.data)}},lastFrameAccessed:0,getFrameElement:function(){var t=this.createdFrames[this.lastFrameAccessed];return this.lastFrameAccessed++,t?t.parentNode&&t.parentNode.removeChild(t):(t=document.createElement("span"),this.createdFrames.push(t)),t},drawFrame:function(t,e,i,s){if(!(t[e].keyframe<this.mm.startFrame-1)){var o=this.getFrameElement(),s=t[e],a=this.mm.startFrame;o.className=this.mm.selectedFrame==s?"ui-kf-frame active":"ui-kf-frame",i.appendChild(o);var n=this.mm.frameSize;o.style.width=n+"px",o.style.left=s.keyframe*n+this.mm.frameOffset-a*n+"px",o.frameInfo={frames:t,index:e}}},autoAddInc:0,addAutoFrame:function(t,e,i){if(!t.unselectable){var s=this.autoAddButtons[this.autoAddInc];this.autoAddInc++,s?s.el.parentNode&&s.el.parentNode.removeChild(s.el):(s=new MT.ui.DomElement("span"),this.autoAddButtons.push(s)),s.addClass("ui-autoFrame ui-button style2"),s.el.autoframe=t,t.autoframe&&s.addClass("active"),i.appendChild(s.el)}},controlsHolder:null,addControls:function(){this.controlsHolder=document.createElement("div"),this.controlsHolder.className="ui-keyframes-controls";var t={};t.play=document.createElement("div"),t.play.className="ui-keyframes-play",t.stop=document.createElement("div"),t.stop.className="ui-keyframes-stop",this.d1.el.appendChild(this.controlsHolder),t["delete"]=document.createElement("div"),t["delete"].className="ui-keyframes-delete";var e={fps:60};this.fpsInput=new MT.ui.Input(this.ui,{key:"fps",min:1},e),this.fpsInput.el.className+=" keyframes-fps",this.controlsHolder.appendChild(this.fpsInput.el);var i=this;this.fpsInput.on("change",function(t){var e=i.getMovie();e&&(e.info.fps=t,i.mm.redrawAll())});for(var s in t)this.controlsHolder.appendChild(t[s]);var o,a=!1,i=(this.mm.activeFrame,this),n=0,h=Date.now(),r=function(){if(h=Date.now(),a){o=i.mm.activeFrame+1,o>i.getLastFrame()&&(o=0),i.mm.changeFrame(o);for(var t=1e3/i.getFps()-(Date.now()-h);0>t;)t+=1e3/i.getFps(),i.mm.activeFrame++;window.setTimeout(r,t)}},l=function(){a?(a=!1,t.play.className="ui-keyframes-play"):(t.play.className="ui-keyframes-pause",a=!0,n=i.mm.activeFrame,r())},c=function(){a||(n=0),a=!1,i.mm.changeFrame(n),t.play.className="ui-keyframes-play"};this.controlsHolder.onmousedown=function(t){t.preventDefault(),t.stopPropagation()},this.controlsHolder.onclick=function(e){e.target==t.play&&(l(),e.preventDefault(),e.stopPropagation()),e.target==t.stop&&(c(),e.preventDefault(),e.stopPropagation()),e.target==t["delete"]&&i.removeConf(i.activeMovie)},this.controls=t},getLastFrame:function(){var t=this.getMovie();if(!t)return 60;if(t.info.lastFrame)return t.info.lastFrame;var e,i,s,o=0,a=this.mm.items;for(var n in a)e=a[n].movies,e&&e[this.activeMovie]&&(s=e[this.activeMovie].frames,s.length&&(i=s[s.length-1],o<i.keyframe&&(o=i.keyframe)));return t.info.lastFrame=o||60,o},getFps:function(){return""!=this.activeMovie&&this.data&&this.data.movies&&this.data.movies[this.activeMovie]?this.data.movies[this.activeMovie].info.fps:60},markFirstFrame:function(){this.mm.changeFrame(0);var t,e;for(var i in this.mm.items)t=this.mm.items[i],t.movies||this.mm.addMovie(t,this.activeMovie),e=t.movies[this.activeMovie].frames[0],e?(void 0==e.keyframe&&(e.keyframe=0),this.mm.loadState(i,e,0)):(e=this.mm.collect(t),e.keyframe=0,t.movies[this.activeMovie]=[e]);this.updateFrames()},saveActiveFrame:function(t,e){if(this.activeMovie){var i,s,o,a=!1,n=!1;for(var h in this.mm.items)if(i=this.mm.items[h],this.parent==i,e||!this.active||!this.active.data.id||this.active.data.id==i.id){if(i.movies||this.mm.addMovie(i,this.activeMovie),o=i.movies[this.activeMovie],!o)return void this.mm.clear();a=!1;for(var r=0;r<o.frames.length;r++)if(s=o.frames[r],s.keyframe==this.mm.activeFrame){o.frames[r]=this.mm.collect(i,this.mm.activeFrame,o.frames[r]),n=!0,a=!0;break}a||t||(s=this.mm.collect(i,this.mm.activeFrame),o.frames.push(s),n=!0)}this.sortFrames(),this.updateFrames(),n&&this.om.sync()}},sortFrames:function(){var t,e;for(var i in this.mm.items){t=this.mm.items[i];for(var s in t.movies)e=t.movies[s],e.frames.sort(function(t,e){return t.keyframe-e.keyframe})}},removeFrame:function(){if(0!==this.mm.activeFrame){var t,e,i,s=!1;for(var o in this.mm.items){t=this.mm.items[o],i=t.movies[this.activeMovie],s=!1;for(var a=0;a<i.length;a++)if(e=i[a],e.keyframe==this.mm.activeFrame){i.splice(a,1);break}}this.updateFrames()}},changeFrame:function(t){var e,i,s,o,a=!1,n=0,h=0;for(var r in this.mm.items)if(e=this.mm.items[r],e.movies&&(s=e.movies[this.activeMovie])){o=s.frames,a=!1,n=h=0;for(var l=0;l<o.length;l++){if(i=o[l],i.keyframe<t&&(n=l),i.keyframe==t){a=!0,this.mm.loadState(r,i,i.keyframe);break}if(i.keyframe>t){h=l;break}}a||(n!=h?n>h?this.mm.loadState(r,o[n],n):this.mm.interpolate(r,o[n],o[h],t):this.mm.loadState(r,o[n],n))}},markActive:function(t){console.log("mark active",t)},addEvents:function(){console.log("add Events")},setActiveFrame:function(t){this.active>-1&&this.frameElements[this.active].removeClass("active"),this.active=t,this.frameElements[this.active].addClass("active"),this.emit("frameChanged",this.active)}}),MT.namespace("plugins"),function(){var t="js/";t+=window.release?"phaser.min.js":"phaser.js",MT.requireFile(t,function(){MT.requireFile("js/phaserHacks.js")})}(),MT.require("core.Helper"),MT.require("core.Selector"),MT.require("core.MagicObject"),MT.MAP_OBECTS_ADDED="MAP_OBECTS_ADDED",MT.SYNC="SYNC",MT.plugins.MapEditor=MT.extend("core.Emitter").extend("core.BasicPlugin")(function(t){MT.core.BasicPlugin.call(this,"map"),this.project=t,this.assets=[],this.objects=[],this.tmpObjects=[],this.oldObjects=[],this.groups=[],this.oldGroups=[],this.loadedObjects=[],this.tileLayers=[],this.dist={},this.selection=new Phaser.Rectangle,this.selector=new MT.core.Selector,this.helperBoxSize=6,this.settings={cameraX:0,cameraY:0,worldWidth:800,worldHeight:480,viewportWidth:800,viewportHeight:480,scaleMode:"SHOW_ALL",gridX:32,gridY:32,gridOffsetX:0,gridOffsetY:0,showGrid:1,gridOpacity:.3,backgroundColor:"#111111",movieInfo:{fps:60,lastFrame:60}},this.zoom=1,window.map=this},{_mousedown:!1,setZoom:function(t){this.zoom=1/t,this.resize()},initUI:function(t){this.ui=t;var e=this;this.panel=t.createPanel("Map editor"),this.panel.on("show",function(){e.ui.refresh()}),t.setCenter(this.panel),this.ui.on(t.events.RESIZE,function(){e.resize()}),this.selector.on("unselect",function(t){e.emit(MT.OBJECT_UNSELECTED,t)}),this.createMap();var i=(this.project.plugins.tools,this.project.plugins.objectmanager),s=!1;t.events.on(t.events.MOUSEDOWN,function(t){t.target==game.canvas&&(s=!0,e.handleMouseDown(t))}),this.isCtrlDown=!1,t.events.on(t.events.MOUSEUP,function(t){e.handleMouseUp(t),s=!1});t.events.on(t.events.MOUSEMOVE,function(t){return t.target==game.canvas||2==t.button||s?void 0===e.handleMouseMove?void console.log("chrome bugging"):void e.handleMouseMove(t):void 0}),t.events.on(t.events.KEYDOWN,function(t){var i=t.which;return t.ctrlKey&&(e.isCtrlDown=!0),t.target==game.canvas||t.target==document.body?i==MT.keys.ESC?(e.activeObject=null,void e.selector.clear()):void e.selector.forEach(function(i){e.moveByKey(t,i)}):void 0}),t.events.on(t.events.KEYUP,function(){e.isCtrlDown=!1,i.sync()})},installUI:function(){var t=this;this.tools=this.project.plugins.tools,this.project.plugins.assetmanager.on(MT.ASSETS_UPDATED,function(e){t.addAssets(e)}),this.project.plugins.objectmanager.on(MT.OBJECTS_UPDATED,function(e){t.addObjects(e)}),this.project.plugins.objectmanager.on(MT.OBJECT_DELETED,function(e){for(var i,s=0;s<t.loadedObjects.length;s++)if(i=t.loadedObjects[s],i.id==e)return t.loadedObjects.splice(s,1),i.remove(),void(t.activeObject==i&&(t.activeObject=null))}),this.tools.on(MT.ASSET_FRAME_CHANGED,function(e,i){t.activeObject&&(t.activeObject.frame=i,t.sync())})},createMap:function(){this.game&&(this.game.canvas.parentNode.removeChild(this.game.canvas),this.game.destroy());var t=this;this.activeObject=null;var e=null,i=function(t){t.highlight(e)},s=this.game=window.game=new Phaser.Game(800,600,Phaser.CANVAS,"",{preload:function(){s.stage.disableVisibilityChange=!0;var e=s.canvas;e.parentNode.removeChild(e),t.panel.content.el.appendChild(e),e.style.position="relative",t.panel.content.style.overflow="hidden"},create:function(){t.resize(),t.scale=s.camera.scale,e||(e=s.canvas.getContext("2d")),t.setCameraBounds(),t.postUpdateSetting(),t.game.plugins.add({postUpdate:function(){for(var e=0;e<t.tileLayers.length;e++){var i=t.tileLayers[e];i.fixedToCamera||(i._mc.x||i._mc.y)&&(i._ox=i._mc.x,i._oy=i._mc.y,i.x+=i._mc.x,i.y+=i._mc.y)}},postRender:function(){for(var e=0;e<t.tileLayers.length;e++){var i=t.tileLayers[e];i.fixedToCamera||(void 0!==i._ox&&(i.x-=i._ox,i._ox=void 0),void 0!==i._oy&&(i.y-=i._oy,i._oy=void 0))}}});var i=window.graphics=new PIXI.Graphics;i.beginFill(16777215),i.drawRect(0,0,t.game.canvas.width,-t.game.camera.y),i.drawRect(t.settings.viewportWidth,-t.game.camera.y,t.game.canvas.width,t.settings.viewportHeight),i.drawRect(0,t.settings.viewportWidth,t.game.canvas.width,t.game.canvas.height),i.drawRect(0,-t.game.camera.y,-t.game.camera.x,t.settings.viewportHeight),i.endFill(),i.alpha=.05,i.postUpdate=i.preUpdate=function(){},i.update=function(){i.graphicsData[0].points[2]=t.game.canvas.width,i.graphicsData[0].points[3]=-t.game.camera.y,i.graphicsData[1].points[0]=t.settings.viewportWidth*t.game.camera.scale.x-t.game.camera.x,i.graphicsData[1].points[1]=-t.game.camera.y,i.graphicsData[1].points[2]=t.game.canvas.width+t.game.camera.x,i.graphicsData[1].points[3]=t.settings.viewportHeight*t.game.camera.scale.y,i.graphicsData[2].points[1]=t.settings.viewportHeight*t.game.camera.scale.y-t.game.camera.y,i.graphicsData[2].points[2]=t.game.canvas.width,i.graphicsData[2].points[3]=t.game.canvas.height+t.game.camera.y,i.graphicsData[3].points[1]=-t.game.camera.y,i.graphicsData[3].points[2]=-t.game.camera.x,i.graphicsData[3].points[3]=t.settings.viewportHeight*t.game.camera.scale.y
},map.game.stage.children.unshift(i),i.parent=map.game.stage},render:function(){e.globalAlpha=1,t.drawGrid(e),t.selector.forEach(i),t.drawSelection(e),t.highlightDublicates(e),t.drawPhysics(e)}})},update:function(){return},resize:function(){this.game&&this.game.world&&(this.game.width=this.panel.content.el.offsetWidth,this.game.height=this.panel.content.el.offsetHeight,this.game.renderer.resize(this.game.width,this.game.height),this.setCameraBounds(),this.reloadObjectsDelayed())},_reloadDelay:0,reloadObjectsDelayed:function(){this._reloadDelay&&window.clearTimeout(this._reloadDelay);var t=this;this._reloadDelay=window.setTimeout(function(){t._reloadDelay=0,t.reloadObjects()},500)},setCameraBounds:function(){this.game.camera.bounds.x=-1/0,this.game.camera.bounds.y=-1/0,this.game.camera.bounds.width=1/0,this.game.camera.bounds.height=1/0,this.game.camera.view.width=this.game.canvas.width/this.game.camera.scale.x,this.game.camera.view.height=this.game.canvas.height/this.game.camera.scale.y},updateSettings:function(t){if(t){for(var e in t)this.settings[e]=t[e];this.game.isBooted&&this.game.width&&(this.postUpdateSetting(),this.project.plugins.settings.update())}},postUpdateSetting:function(){this.game.width=this.settings.worldWidth,this.game.height=this.settings.worldHeight,this.setCameraBounds(),this.game.camera.x=this.settings.cameraX,this.game.camera.y=this.settings.cameraY;var t=this.settings.backgroundColor.substring(1),e=parseInt(t,16);this.game.stage.backgroundColor!=e&&this.game.stage.setBackgroundColor(e),this.update()},drawGrid:function(t){if(this.settings.showGrid&&0!=this.settings.gridOpacity){var e=t.globalAlpha,i=0,s=this.game;t.globalAlpha=this.settings.gridOpacity,t.save(),t.scale(this.game.camera.scale.x,this.game.camera.scale.y),t.beginPath();for(var o=s.stage.backgroundColor,a=parseInt("FFFFFF",16),n=(a-o).toString(16);n.length<6;)n="0"+n;parseInt(n,16)-o<10&&(n="#000000"),t.strokeStyle="#"+n;var h=this.settings.gridOffsetX%this.settings.gridX-this.settings.gridX,r=this.settings.gridOffsetY%this.settings.gridY-this.settings.gridY,l=s.camera.x/this.scale.x%this.settings.gridX-h,c=s.camera.y/this.scale.y%this.settings.gridY-r,d=s.canvas.width/s.camera.scale.x-h,u=s.canvas.height/s.camera.scale.y-r;i=this.settings.gridX,t.lineWidth=.2,t.shadowColor="#000",t.shadowBlur=0,t.shadowOffsetX=.5,t.shadowOffsetY=0,t.beginPath();for(var p=-l;d>p;p+=i)0>p||(t.moveTo(p+.5,.5),t.lineTo(p+.5,u+.5));t.stroke(),t.shadowOffsetX=0,t.shadowOffsetY=.5,t.beginPath(),i=this.settings.gridY;for(var m=-c;u>m;m+=i)0>m||(t.moveTo(.5,m+.5),t.lineTo(d+.5,m+.5));t.stroke(),t.lineWidth=.5,t.beginPath(),t.moveTo(0,-s.camera.y/this.scale.y),t.lineTo(d,-s.camera.y/this.scale.y),t.moveTo(-s.camera.x/this.scale.x,0),t.lineTo(-s.camera.x/this.scale.x,u),t.stroke(),t.restore(),t.globalAlpha=e}},highlightObject:function(t,e){if(e&&(e.game&&e.parent||(e=this.getById(e.id)))&&this.isVisible(e)){var i=t.globalAlpha,s=e.getBounds(),o=null;o=e.type==MT.objectTypes.GROUP?e:e.parent||game.world;var a=this.getObjectOffsetX(o),n=this.getObjectOffsetY(o);if(t.save(),t.translate(.5,.5),this.activeObject==e){t.strokeStyle="rgb(255,0,0)",t.lineWidth=1;var h=this.helperBoxSize,r=s.x-.5*h|0,l=r+s.width|0,c=s.y-.5*h|0,d=c+s.height|0;if(e.data.type==MT.objectTypes.TEXT){var u=s.width;e.wordWrap&&(u=e.wordWrapWidth*this.game.camera.scale.x|0,t.strokeRect(s.x-h|0,c+.5*s.height|0,h,h),t.strokeRect(s.x+u|0,c+.5*s.height|0,h,h)),t.strokeRect(0|s.x,0|s.y,0|u,0|s.height)}else{if(e.type==Phaser.SPRITE){e.updateTransform();for(var p=e.worldTransform,m=p.tx,f=p.ty,v=e.rotation,g=e.parent;g;)v+=g.rotation,g=g.parent;var a,n,l,d;return t.strokeStyle="#ffee22",t.beginPath(),t.arc(m,f,5,0,2*Math.PI),t.stroke(),t.strokeStyle="#ff0000",a=p.tx-e.width*e.anchor.x,n=p.ty-e.height*e.anchor.y,l=this.rpx(v,a,n,m,f),d=this.rpy(v,a,n,m,f),t.beginPath(),t.arc(l,d,5,0,2*Math.PI),t.stroke(),a=p.tx+e.width*(1-e.anchor.x),n=p.ty-e.height*e.anchor.y,l=this.rpx(v,a,n,m,f),d=this.rpy(v,a,n,m,f),t.beginPath(),t.arc(l,d,5,0,2*Math.PI),t.stroke(),a=p.tx-e.width*e.anchor.x,n=p.ty+e.height*(1-e.anchor.y),l=this.rpx(v,a,n,m,f),d=this.rpy(v,a,n,m,f),t.beginPath(),t.arc(l,d,5,0,2*Math.PI),t.stroke(),a=p.tx+e.width*(1-e.anchor.x),n=p.ty+e.height*(1-e.anchor.y),l=this.rpx(v,a,n,m,f),d=this.rpy(v,a,n,m,f),t.beginPath(),t.arc(l,d,5,0,2*Math.PI),void t.stroke()}t.strokeRect(0|s.x,0|s.y,0|s.width,0|s.height),e.type!=Phaser.TILE_LAYER}}else t.strokeStyle="rgb(255,100,0)",t.strokeRect(0|s.x,0|s.y,s.width,s.height);t.strokeStyle="#ffffff",t.lineWidth=1;for(var g=o.parent,b=[];g;)b.push({x:g.x,y:g.y,r:g.rotation}),g=g.parent;for(;b.length;){var y=b.pop();t.translate(y.x,y.y),t.rotate(y.r),t.translate(-y.x,-y.y)}t.translate(a,n),t.rotate(o.rotation),t.translate(-a,-n),t.beginPath(),t.moveTo(a,n),t.lineTo(a,n-16),t.stroke(),t.strokeRect(a-4,n-4,8,8),t.globalAlpha=i,t.restore()}},drawPhysics:function(t){if(this.enabledPhysics)for(var e=0;e<this.loadedObjects.length;e++)this.drawPhysicsBody(t,this.loadedObjects[e])},drawPhysicsBody:function(t,e){if(e&&(e.game&&e.parent||(e=this.getById(e.id)))&&e.isVisible&&e.type!=MT.objectTypes.GROUP){var i=e.data.physics;if(!i||!i.enable){var s=e.object.parent;if(s=e.parent==e.game.world?this.settings.physics:s.magic.data.physics,!s||!s.enable)return;i=s}{var o=(t.globalAlpha,e.object.worldTransform);o.tx,o.ty}t.save(),t.fillStyle="rgb(100,200,70)",t.globalAlpha=.2;var a=e.width,n=e.height;i.size.width>0&&(a=i.size.width),i.size.height>0&&(n=i.size.height),t.translate(o.tx,o.ty),t.rotate(e.object.rotation),t.scale(this.scale.x,this.scale.y),t.fillRect(-a*e.object.anchor.x+i.size.offsetX,-n*e.object.anchor.y+i.size.offsetY,a,n),t.restore()}},drawSelection:function(t){this.selection.empty||(t.save(),t.strokeStyle="rgba(0,70, 150, 0.8)",t.fillStyle="rgba(0,70, 150, 0.2)",t.strokeRect(this.selection.x-this.game.camera.x,this.selection.y-this.game.camera.y,this.selection.width,this.selection.height),t.fillRect(this.selection.x-this.game.camera.x,this.selection.y-this.game.camera.y,this.selection.width,this.selection.height),t.restore())},highlightDublicates:function(t){if(this.isCtrlDown){var e=null,i=null,s=null;t.save(),t.fillStyle="rgba(150, 70, 20, 0.3)";for(var o=0;o<this.loadedObjects.length;o++)if(e=this.loadedObjects[o],e.isVisible&&e.type!=MT.objectTypes.GROUP)for(var a=o;a<this.loadedObjects.length;a++)i=this.loadedObjects[a],e!=i&&e.x==i.x&&e.y==i.y&&e.assetId==i.assetId&&e.width==i.width&&e.data.type==i.data.type&&e.parent==i.parent&&(s=e.object.getBounds(),t.fillRect(0|s.x,0|s.y,0|s.width,0|s.height));t.restore()}},isAssetsAdded:!1,assetsTimeout:0,addAssets:function(t,e){if(!this.game.isBooted||!this.game.width){var i=this;return window.clearTimeout(this.assetsTimeout),void(this.assetsTimeout=window.setTimeout(function(){i.addAssets(t)},100))}window.clearTimeout(this.assetsTimeout);var i=(this.game,this);e||(this.isAssetsAdded=!t.length);for(var s=0;s<t.length;s++)this.addAsset(t[s],function(){i.assetsToLoad--,0==i.assetsToLoad&&(i.isAssetsAdded=!0,i.reloadObjects())})},assetsToLoad:0,addAsset:function(t,e){if(this.assetsToLoad++,t.contents)return this.addAssets(t.contents,!0),void("function"==typeof e&&window.setTimeout(e,0));var i=(this.game,this.project.path+"/"+t.__image);if(!MT.core.Helper.isImage(i))return void("function"==typeof e&&e());var s=this;if(t.atlas){var o=t.atlas.split(".").pop().toLowerCase();return void MT.loader.get(s.project.path+"/"+t.atlas+"?"+Date.now(),function(a){var n=null,h=Phaser.Loader.TEXTURE_ATLAS_XML_STARLING;"json"==o?(n=s.parseJSON(a),h=Array.isArray(n.frames)?Phaser.Loader.TEXTURE_ATLAS_JSON_ARRAY:Phaser.Loader.TEXTURE_ATLAS_JSON_HASH):n=s.parseXML(a),n?s.loadImage(i+"?"+Date.now(),function(){s.game.cache.addTextureAtlas(t.id,t.__image,this,n,h),s.findAtlasNames(t.id),t.type!=h&&(t.type=h,s.project.plugins.assetmanager.updateData()),e()}):console.error("failed to parse atlas")})}this.loadImage(i+"?"+Date.now(),function(){t.width!=t.frameWidth||t.width!=t.frameHeight?s.game.cache.addSpriteSheet(t.id,t.__image,this,t.frameWidth,t.frameHeight,t.frameMax,t.margin,t.spacing):s.game.cache.addImage(t.id,t.__image,this),e()})},parseXML:function(t){var e;try{if(window.DOMParser){var i=new DOMParser;e=i.parseFromString(t,"text/xml")}else e=new ActiveXObject("Microsoft.XMLDOM"),e.async="false",e.loadXML(t)}catch(s){e=void 0}if(!e||!e.documentElement||e.getElementsByTagName("parsererror").length)throw new Error("Phaser.Loader. Invalid Texture Atlas XML given");return e},parseJSON:function(t){var e=null;try{e=JSON.parse(t)}catch(i){console.error(i),e=null}return e},ajax:function(t,e){var i=new XMLHttpRequest;i.open("get",t),i.onreadystatechange=function(){4===i.readyState&&e(i.responseText)},i.onerror=function(){console.error("couldn't load asset",t),e()},i.setRequestHeader("X-Requested-With","XMLHttpRequest"),i.send(null)},loadImage:function(t,e){var i=new Image;i.onload=e,i.onerror=function(){console.error("couldn't load asset",t),e()},i.src=t},atlasNames:{},findAtlasNames:function(t){if(!this.game.cache._images[t]||!this.game.cache._images[t].frameData)return void console.error("Failed to parse atlas");for(var e=this.game.cache._images[t].frameData,i=Object.keys(e._frameNames),s="",o={},a="",n=0,h="",r=0;r<i.length;r++)s=i[r]||"unnamed",a=s.substring(0,s.indexOf(0)),a||(a=s),void 0===o[a]&&(o[a]={start:n,end:n}),h&&h!=a&&(o[h].end=n),h=a,n++;0==i.length?o.unnamed={start:0,end:0}:o[h].end=n,o.all_frames={start:0,end:e._frames.length},this.atlasNames[t]=o,this.project.plugins.assetmanager.selectActiveAsset(),this.atlasNames[t]=o,this.project.plugins.assetmanager.selectActiveAsset()},cleanImage:function(t){this.game.cache.removeImage(t)},checkId:function(){for(var t=null,e=0;e<this.objects.length;e++){t=this.objects[e];for(var i=0;i<this.objects.length;i++)t!=this.objects[i]&&t.id==this.objects[i].id&&console.error("dublicate id")}},_addTimeout:0,addObjects:function(t,e){if(!this.isAssetsAdded){var i=this;return this._addTimeout&&(window.clearTimeout(this._addTimeout),this._addTimeout=0),void(this._addTimeout=window.setTimeout(function(){i.addObjects(t,e),this._addTimeout=0},100))}for(var s,o=0;o<this.loadedObjects.length;o++)s=this.loadedObjects[o],s.isRemoved=!0;e=e||game.world,this._addObjects(t,e);for(var o=0;o<this.loadedObjects.length;o++)s=this.loadedObjects[o],s.isRemoved&&(this.loadedObjects.splice(o,1),s.remove(),o--);this.emit(this,MT.MAP_OBECTS_ADDED)},_destroyObject:function(t){t.destroy(!0)},_addObjects:function(t,e){for(var i,s=t.length-1;s>-1;s--)i=this.getById(t[s].id),i||(i=new MT.core.MagicObject(t[s],e,this),this.loadedObjects.push(i)),i.isRemoved=!1,i.update(t[s],e),i.object.z=0,t[s].contents&&this._addObjects(t[s].contents,i.object);for(var s=t.length-1;s>-1;s--)i=this.getById(t[s].id),i.bringToTop();this.tools.tmpObject&&this.tools.tmpObject.bringToTop()},resort:function(){this.tools.tmpObject&&this.tools.tmpObject.bringToTop()},addGroup:function(t){return void console.error("removed")},addObject:function(t,e){return void console.log("removed - addObject")},reloadObjects:function(){this.loadedObjects&&!this._addTimeout&&this.addObjects(this.loadedObjects)},_activeObject:null,_justSelected:null,get activeObject(){return this._activeObject?(this._activeObject.game||(this._activeObject=this.getById(this._activeObject.xxx.id)),this._activeObject):null},savedSettings:null,set activeObject(t){this._activeObject=t},get offsetX(){return this.panel.content.calcOffsetX()-this.game.camera.x},get offsetY(){return this.panel.content.calcOffsetY()-this.game.camera.y},get offsetXCam(){return this.panel.content.calcOffsetX()+this.game.camera.x},get offsetYCam(){return this.panel.content.calcOffsetY()+this.game.camera.y},get ox(){return this.panel.content.calcOffsetX()},get oy(){return this.panel.content.calcOffsetY()},handleMouseDown:function(t){if(0==t.button)for(var e in this.dist)this.dist[e].x=0,this.dist[e].y=0;this.tools.mouseDown(t)},handleMouseUp:function(t){this.tools.mouseUp(t)},emptyFn:function(){},_handleMouseMove:function(){},set handleMouseMove(t){this._handleMouseMove=t},get handleMouseMove(){return this._handleMouseMove},_cameraMove:function(){this.game.camera.x-=this.ui.events.mouse.mx,this.game.camera.y-=this.ui.events.mouse.my,this.settings.cameraX=this.game.camera.x,this.settings.cameraY=this.game.camera.y,this.project.plugins.settings.updateScene(this.settings),this.update()},dist:null,updateMouseInfo:function(t){this.selector.forEach(function(e){e.mouseInfo.x=t.x,e.mouseInfo.y=t.y})},_objectMove:function(t,e){if(!e){var i=this;return void this.selector.forEach(function(e){i._objectMove(t,e)})}var s=(this.ui.events.mouse.mx+this.ox,this.ui.events.mouse.my+this.oy,this.ui.events.mouse);e.moveObject(s.x+s.mx,s.y+s.my,t)},enabledPhysics:!1,enablePhysics:function(){this.enabledPhysics=!0},disablePhysics:function(){this.enabledPhysics=!1},moveByKey:function(t,e){var i=t.which,s=1;t.ctrlKey&&(s=37==i||39==i?this.settings.gridX:this.settings.gridY),i==MT.keys.LEFT&&(e.x-=s),i==MT.keys.UP&&(e.y-=s),i==MT.keys.RIGHT&&(e.x+=s),i==MT.keys.DOWN&&(e.y+=s)},_followMouse:function(t,e){this.activeObject&&(this.activeObject.x=(t.x-this.ox+this.game.camera.x)/this.scale.x,this.activeObject.y=(t.y-this.oy+this.game.camera.y)/this.scale.y,(t.ctrlKey||e)&&(this.activeObject.x=Math.round(this.activeObject.x/this.settings.gridX)*this.settings.gridX,this.activeObject.y=Math.round(this.activeObject.y/this.settings.gridY)*this.settings.gridY))},sync:function(){this.sendDelayed("updateData",this.settings,100)},createObject:function(t){var e=this.createSprite(t);return this.tmpObjects.push(e),e},removeObject:function(t){for(var e=0;e<this.tmpObjects.length;e++)this.tmpObjects[e]==t&&(this.tmpObjects.splice(e,1)[0].destroy(),e--)},updateScene:function(t){this.updateSettings(t),this.sendDelayed("updateData",this.settings,100)},received:!1,a_receive:function(t){this.received||(this.received=!0,this.updateSettings(t),this.emit("update"))},createActiveObject:function(t){return this.activeObject=this.addObject(t,this.game.world,!0),this.activeObject},pickObject:function(t,e){t+=this.game.camera.x,e+=this.game.camera.y;var i;if(this.activeObject){if(this.activeObject.type==MT.objectTypes.GROUP)return this.checkBounds(this.activeObject,t,e);if((this.activeObject.type==MT.objectTypes.SPRITE||this.activeObject.type==MT.objectTypes.TEXT)&&(i=this._pick(this.activeObject,t,e)))return i}for(var s=(new Phaser.Point(0,0),this.game.input.activePointer,this.loadedObjects.length-1);s>-1;s--){i=this.loadedObjects[s];var o=this._pick(i,t,e,!0);if(o)return o}return null},_pick:function(t,e,i,s){return t.isVisible?t.type==MT.objectTypes.GROUP?null:t.isLocked?null:t.object.input?t.object.input.checkPointerOver(this.game.input.activePointer)?this.ui.events.mouse.lastEvent.ctrlKey&&!this.activeObject&&s?(this.activeObject=t.parent&&t.parent.magic?t.parent.magic:t,this.activeObject):(this.activeObject=t,t):null:this.checkBounds(t,e,i):null},checkBounds:function(t,e,i){var s=t.object.getBounds();return s.contains(e,i)?t.data.type==MT.objectTypes.TILE_LAYER?t.getTile(e+this.game.camera.x,i+this.game.camera.y)?t:null:t:null},selectRect:function(t,e){t.x-=this.game.camera.x,t.y-=this.game.camera.y;for(var i=null,s=null,o=0;o<this.loadedObjects.length;o++)if(s=this.loadedObjects[o],s.data.type!=MT.objectTypes.GROUP){var a=s.object;s.type!=MT.objectTypes.GROUP&&s.isVisible&&(s.isLocked||(i=a.getBounds(),i.intersects(t)?this.selector.add(s):e&&this.selector.remove(s)))}t.x+=this.game.camera.x,t.y+=this.game.camera.y},isGroupHandle:function(t,e){return null},createSprite:function(t,e){var i=this.game;e=e||i.world;var s=null;return i.cache.getImage(t.assetId)||(t.assetId="__missing"),s=e.create(t.x,t.y,t.assetId)},isGroupSelected:function(){return!1},getById:function(t){for(var e=0;e<this.loadedObjects.length;e++)if(this.loadedObjects[e].data){if(this.loadedObjects[e].data.id==t)return this.loadedObjects[e]}else console.warn("smth wrong")}}),MT.namespace("misc"),MT.misc.tooltips={selectTool:{title:"Select tool",desc:"object selection, rectangle selection, object transformation",tips:["Hold down <i><b>ctrl</b></i> key - to snap objects to the grid while moving","You can easily clone object by holding <i>Alt</i> key before drag"]},stampTool:{title:"Stamp tool",desc:"put objects on the map one by one",tips:["Hold down <i><b>ctrl</b></i> key - to snap objects to the grid"]},brushTool:{title:"Brush tool",desc:"put multiple objects on the map like drawing tiles"},textTool:{title:"Text tool",desc:"create text object"},tileToolsTool:{title:"Tile tool",desc:"allows to put tiles on the tilemap",errors:["You must select <i><b>tileLayer</b></i> object - to use <b>Tile tool</b>"]},physicsTool:{title:"Physics tool",desc:"enable to highlight physics bodies"}},MT.namespace("ui"),MT.require("ui.InputHelper"),MT.extend("ui.DomElement").extend("core.Emitter")(MT.ui.TableView=function(t,e){MT.ui.DomElement.call(this),this.table=document.createElement("table"),this.el.appendChild(this.table);this.header=e,t&&this.setData(t,e);var i=this;this.input=new MT.ui.InputHelper,this.input.on("change",function(t){""==t&&console.log("should remove"),i.input.el.innerHTML=t}),this.input.on("blur",function(){i.updateData(i.input.el)}),this.input.on("tab",function(t){var e=i.input.el;i.input.blur(),i.jumpToNext(e,t.shiftKey)}),this.input.on("enter",function(t){var e=i.input.el;i.input.blur(),i.jumpToNext(e,t.shiftKey)}),this.table.onclick=function(t){t.preventDefault(),t.stopPropagation(),console.log(t.target.data),t.target.data&&i.input.show(t.target)}},{size:0,isKeyValue:!1,toKeyValue:function(){},setData:function(t,e){if(this.table.innerHTML="",this._created=!1,this._allowEmpty=!0,this.origData=t,this.data=JSON.parse(JSON.stringify(t)),this.header=this.header||e,!Array.isArray(this.data)){this.isKeyValue=!0,tmp=this.data,this.data=[];for(var i in tmp)this.data.push([i,tmp[i]])}this.createTable()},jumpToNext:function(t,e){e?t.previousSibling?this.input.show(t.previousSibling):t.parentNode.previousSibling&&t.parentNode.previousSibling.lastChild.data&&this.input.show(t.parentNode.previousSibling.lastChild):t.nextSibling?this.input.show(t.nextSibling):t.parentNode.nextSibling&&this.input.show(t.parentNode.nextSibling.firstChild)},updateData:function(t){var e=t.data.row,i=t.data.index,s=t.innerHTML;if(console.log(e,i,s),-1==e){if(this.isKeyValue&&(i>0||""==s))return void this.createTable();for(var o=[],a="",n=0;n<this.size;n++)o.push(n==i?s:a);e=this.data.length,this.data.push(o),this.allowEmpty=!0}if(this.data[e]){if(this.data[e][i]=s,this.isKeyValue){""==s&&0==i&&(this.data.splice(e,1),this.table.removeChild(this.header?this.table.children[e+1]:this.table.children[e]));for(var h in this.origData)delete this.origData[h];for(var n=0;n<this.data.length;n++)this.origData[this.data[n][0]]=this.data[n][1]}else{this.origData.length=0;for(var n=0;n<this.data.length;n++){this.origData[n]=[];for(var r=0;r<this.data[n].length;r++)this.origData[r]=this.data[n][r]}}this.createTable(),this.emit("change",this.origData)}},_allowEmpty:!0,set allowEmpty(t){this._allowEmpty=t},get allowEmpty(){return this._allowEmpty},_created:!1,createTable:function(){var t,e,i,s,o,a=this.table.firstChild;if(this.header){o=this.header.length,this._created?(t=a,a=t.nextSibling):(t=document.createElement("tr"),this.table.appendChild(t));for(var s=0;s<this.header.length;s++)e=t.children[s]||document.createElement("th"),e.innerHTML=this.header[s],e.parentNode||t.appendChild(e)}for(s=0;s<this.data.length;s++){if(this._created?(t=a,a=t.nextSibling):(t=document.createElement("tr"),this.table.appendChild(t)),!Array.isArray(this.data[s])){this.isKeyValue=!0,i=this.data[s],this.data[s]=[];for(var n in i)this.data[s].push(n),this.data[s].push(s)}for(i=this.data[s],o=0;o<i.length;o++)this.addCell(t,s,o,i[o])}if(this.size=o,this.allowEmpty){t=document.createElement("tr"),this.table.appendChild(t),i=this.data[s];for(var h=0;o>h;h++)this.addCell(t,-1,h,"")}this.allowEmpty=!1,this._created=!0},addCell:function(t,e,i,s){var o=t.children[i]||document.createElement("td");return o.parentNode||t.appendChild(o),o.data={row:e,index:i},o.innerHTML=s,o.setAttribute("width",100),o}}),MT.namespace("plugins"),MT.extend("core.BasicPlugin")(MT.plugins.Analytics=function(t){MT.core.BasicPlugin.call(this,"Analytics"),this.project=t},{installUI:function(){!function(t,e,i,s,o,a,n){t.GoogleAnalyticsObject=o,t[o]=t[o]||function(){(t[o].q=t[o].q||[]).push(arguments)},t[o].l=1*new Date,a=e.createElement(i),n=e.getElementsByTagName(i)[0],a.async=1,a.src=s,n.parentNode.insertBefore(a,n)}(window,document,"script","//www.google-analytics.com/analytics.js","ga"),ga("create","UA-23132569-11"),this.project.id&&(document.title+=" - "+this.project.id),ga("send","pageview"),this.lastUpdate=Date.now();var t=this;this.project.plugins.tools.on(MT.OBJECT_SELECTED,function(e){t.send("tool-selected",e)}),this.project.plugins.assetmanager.on(MT.ASSET_ADDED,function(e){t.send("image-added",e)}),this.project.plugins.objectmanager.on(MT.OBJECT_ADDED,function(e){t.send("object-added",e)}),this.project.plugins.objectmanager.on(MT.OBJECTS_SYNC,function(){lastUpdate=Date.now(),t.send("working-with-map","sync")}),this.minute=6e4,window.setInterval(function(){t.send("idle",t.project.id)},this.minute)},send:function(t,e){this.lastUpdate>Date.now()-this.minute||(this.lastUpdate=Date.now(),window.ga("send","event",t,e))}}),MT.namespace("plugins"),MT.extend("core.BasicPlugin")(MT.plugins.DataLink=function(t){MT.core.BasicPlugin.call(this,"DataLink"),this.project=t},{selectElementContents:function(t){var e=document.createRange();e.selectNodeContents(t);var i=window.getSelection();i.removeAllRanges(),i.addRange(e)},initUI:function(){var t=this,e=window.location.origin;e+="/"+this.project.path+"/phaser/js/lib/mt.data.js";var i=this.project.panel.addButton(e,"datalink",function(e){t.selectElementContents(i.el),e.preventDefault()});i.el.onmouseleave=function(){window.getSelection().removeAllRanges()},i.style.left="auto",i.style.right=0,i.style.position="absolute"}}),MT.namespace("plugins"),MT.extend("core.BasicPlugin")(MT.plugins.UndoRedo=function(t){this.project=t,this.buffer=[],this.name="UndoRedo",this._step=0,this.max=20,this.undos=0,window.ur=this,this.capacity=0,this.currentOffset=0;var e=this;this.onKeyDown=function(t){if(t.ctrlKey&&t.which==="Z".charCodeAt(0))if(t.shiftKey)if(e.step<e.buffer.length){var i=e.buffer[e.step];i?(e.om.a_receive(JSON.parse(i),!0),e.step++):console.log("nothing to redo - no data?")}else console.log("nothing to redo");else if(e.step>0){e.step--,console.log(e.step);var i=e.buffer[e.step-1];i?e.om.a_receive(JSON.parse(i),!0):e.step++}},this.checkLocalStorageCapacity()},{set step(t){this._step=t},get step(){return this._step},disable:function(){this.ui.events.off(this.ui.events.KEYDOWN,this.onKeyDown)},enable:function(){this.ui.events.on(this.ui.events.KEYDOWN,this.onKeyDown)},reset:function(){this.buffer=[],this.data={},this.step=0,this.currentOffset=0,localStorage.removeItem(this.name),this.save()},installUI:function(){var t=this,e=localStorage.getItem(this.name);this.data=e?JSON.parse(e):{},this.data[this.project.id]&&(this.buffer=this.data[this.project.id]),this.step=this.buffer.length,this.data[this.project.id]=this.buffer,this.om=this.project.plugins.objectmanager,this.om.on(MT.OBJECTS_SYNC,function(e){var i=JSON.stringify(e);t.buffer[t.step-1]!=i&&(t.step>t.max&&(t.buffer.shift(),t.step--),t.buffer[t.step]=i,t.step++,t.buffer.length=t.step,t.save())}),this.om.on(MT.OBJECTS_UPDATED,function(e){0==t.buffer.length&&(t.buffer.push(JSON.stringify(e)),t.step++)}),this.enable()},cleanUp:function(){for(var t in this.data)this.data[t].shift();this.checkLocalStorageCapacity(),this.currentOffset=0},save:function(){var t=JSON.stringify(this.buffer),e=this.currentOffset;for(this.step-e<=0&&(this.cleanUp(),e=this.currentOffset);t.length>this.capacity&&e<this.step;)e++,t=JSON.stringify(this.buffer.slice(e,this.step));this.currentOffset=e;try{localStorage.setItem(this.name,JSON.stringify(this.data))}catch(i){e++,this.buffer.slice(this.step-e,this.step),this.save()}},checkLocalStorageCapacity:function(){for(var t="x",e=0,i=1;;){t+=t.substring(0,t.length*i|0);try{localStorage.setItem("test",t),e=t.length}catch(s){if(i-=.1,.1>i)break;t=t.substring(0,e)}}localStorage.removeItem("test"),this.capacity=e}}),MT.namespace("plugins"),MT.require("ui.List"),MT.require("plugins.tools.Select"),MT.require("plugins.tools.Stamp"),MT.require("plugins.tools.Brush"),MT.require("plugins.tools.Text"),MT.require("plugins.tools.TileTool"),MT.require("plugins.tools.Physics"),MT.TOOL_SELECTED="TOOL_SELECTED",MT.extend("core.BasicPlugin").extend("core.Emitter")(MT.plugins.Tools=function(t){MT.core.Emitter.call(this),this.project=t,this.tools={},this.toolsAvailable={select:MT.plugins.tools.Select,Stamp:MT.plugins.tools.Stamp,Brush:MT.plugins.tools.Brush,Text:MT.plugins.tools.Text,TileTool:MT.plugins.tools.TileTool,Physics:MT.plugins.tools.Physics},this.tmpObject=null,this.activeAsset=null,this.activeFrame=0},{initUI:function(t){this.ui=t,this.panel=t.createPanel("toolbox",this.ui.left),this.panel.addClass("toolbox"),this.panel.removeHeader(),this.panel.width=40,this.panel.isResizeable=!1,this.panel.isDockable=!0,t.dockToLeft(this.panel)},installUI:function(){var t=this,e=this.project.plugins.assetmanager,i=this.map=this.project.plugins.mapeditor,s=this.om=this.project.plugins.objectmanager;for(var o in this.toolsAvailable)this.tools[o.toLowerCase()]=new this.toolsAvailable[o](this);e.on(MT.ASSET_SELECTED,function(i){t.activeAsset=i,t.activeFrame=e.activeFrame,t.emit(MT.ASSET_SELECTED,i)}),e.on(MT.ASSET_UNSELECTED,function(e){t.activeAsset=null,t.emit(MT.ASSET_UNSELECTED,e)}),e.on(MT.ASSET_FRAME_CHANGED,function(e,i){t.activeAsset=e,t.activeFrame=i,t.emit(MT.ASSET_FRAME_CHANGED,e,i)});var a=function(e){return e?void t.select(e):void console.error("Failed to select an object")};i.on(MT.TOOL_SELECTED,a),s.on(MT.OBJECT_SELECTED,function(t){a(i.getById(t.id))}),i.selector.on("select",function(e){t.emit(MT.OBJECT_SELECTED,e)}),i.selector.on("unselect",function(e){t.emit(MT.OBJECT_UNSELECTED,e),1!==i.selector.count&&window.setTimeout(function(){if(1==i.selector.count){var t=i.selector.get(0);this.map.activeObject=null,i.selector.emit("select",t),this.map.activeObject=t}},0)}),s.on(MT.OBJECTS_UPDATED,function(){t.emit(MT.OBJECTS_UPDATED)});var n=0,h=[];this.ui.events.on(this.ui.events.KEYUP,function(e){if(n==MT.keys.ESC)return t.setTool(t.tools.select),window.getSelection().removeAllRanges(),void(n=0);if(e.which==MT.keys.DELETE){var o=s.tv.getData();return t.map.selector.forEach(function(t){s.deleteObj(t.id,!0,o),s.selector.clear()}),s.tv.merge(o),s.sync(),void s.update()}n=e.which,window.setTimeout(function(){n=0},500),e.which===MT.keys.ESC&&t.activeTool.deactivate();if(e.ctrlKey){if(e.which===MT.keys.C)return h.length=0,void i.selector.forEach(function(t){h.push(t)});if(e.which===MT.keys.V&&e.target==document.body){var a=t.ui.events.mouse.lastEvent.x,r=t.ui.events.mouse.lastEvent.y;t.map.selector.clear();for(var l=null,c=0,d=0,u=0;u<h.length;u++)l=h[u].getBounds(),c+=l.x,d+=l.y;d/=h.length,c/=h.length;for(var p=null,u=0;u<h.length;u++)l=h[u].getBounds(),p=e.shiftKey?t.copy(h[u].data,h[u].data.x,h[u].data.y):t.copy(h[u].data,l.x-c+a-i.offsetX,l.y-d+r-i.offsetY),t.map.selector.add(p)}}else if("INPUT"!=e.target.tagName&&"TEXTAREA"!=e.target.tagName){var m=Object.keys(t.tools);e.which=="1".charCodeAt(0)&&t.setTool(t.tools[m[0]]),e.which=="2".charCodeAt(0)&&t.setTool(t.tools[m[1]]),e.which=="3".charCodeAt(0)&&t.setTool(t.tools[m[2]]),e.which=="4".charCodeAt(0)&&t.setTool(t.tools[m[3]]),e.which=="5".charCodeAt(0)&&t.setTool(t.tools[m[4]])}});for(var o in this.tools)this.tools[o].initUI(this.ui);this.setTool(this.tools.select)},lastAsset:null,select:function(t){this.tools.select.select(t),this.activeTool!=this.tools.select&&this.activeTool.select(t)},copy:function(t,e,i){if(!Array.isArray(t)){var s=this.om.copy(t,e,i),o=this.map.getById(s.id);return this.om.sync(),o}for(var a=0;a<t.length;a++)this.copy(t[a],e,i)},setTool:function(t,e){if(this.activeTool!=t){var i=null;this.activeTool&&(i=this.activeTool,this.activeTool=null,i.button.removeClass("active")),this.activeTool=t,this.activeTool.button.addClass("active"),i&&i.deactivate(),this.activeTool.init(e),this.emit(MT.TOOL_SELECTED,t)}},mouseDown:function(t){return 2===t.button?(this.previousMouseMove=this.map.handleMouseMove,void this.mouseDown_hand(t)):void this.activeTool.mouseDown(t)},mouseUp:function(t){return 2==t.button?void(this.map.handleMouseMove=this.previousMouseMove):void this.activeTool.mouseUp(t)},mouseMove:function(t){this.activeTool.mouseMove(t)},lastSelected:null,selectObject:function(t,e){e&&this.map.selector.clear(),this.map.activeObject=t,this.map.selector.add(t)},initTmpObject:function(t){t=t||this.lastAsset,this.lastAsset=t;var e=this.ui.events.mouse.x,i=this.ui.events.mouse.y,s=this.project.plugins.objectmanager,o=0,a=0;this.tmpObject&&(o=this.tmpObject.x,a=this.tmpObject.y),this.tmpObject?this.tmpObject.update(s.createObject(t)):this.tmpObject=new MT.core.MagicObject(s.createObject(t),this.map.game.world,this.map),this.map.activeObject=this.tmpObject,this.tmpObject.x=o||e,this.tmpObject.y=a||i,this.tmpObject.bringToTop()},removeTmpObject:function(){this.tmpObject&&this.tmpObject.hide(),this.tmpObject=null},mouseDown_hand:function(){this.map.handleMouseMove=this.map._cameraMove},unselectObjects:function(){var t=[];this.map.selector.forEach(function(e){e.data.contents||t.push(e)});for(var e=0;e<t.length;e++)this.map.selector.remove(t[e]);this.map.activeObject=null},hide:function(){this.object.visible=!1}}),MT.namespace("plugins"),MT.extend("core.Emitter").extend("core.BasicPlugin")(MT.plugins.Export=function(t){MT.core.BasicPlugin.call(this,"Export"),this.project=t},{initUI:function(t){var e=this;this.list=new MT.ui.List([{label:"Phaser.io (.js)",className:"",cb:function(){e["export"]("phaser",function(t){window.location=e.project.path+"/"+t.file})}},{label:"Phaser.io (data only) js",className:"",cb:function(){e["export"]("phaserDataOnly",function(t){e.openDataLink(t,"js")})}},{label:"Phaser.io (data only) json",className:"",cb:function(){e["export"]("phaserDataOnly",function(t){e.openDataLink(t,"json")})}}],t,!0);var i=(this.button=this.project.panel.addButton("Export",null,function(){e.showList()}),this.project.plugins.objectmanager);this.openGame=this.project.panel.addButton("Open Game",null,function(){i.sync(),e.openLink("_open_game")})},"export":function(t,e,i){"function"==typeof e&&(i=e,e=null),this.send(t,e),this.once("done",i)},showList:function(){this.list.width=250,this.list.y=this.button.el.offsetHeight,this.list.x=this.button.el.offsetLeft-5,this.list.el.style.bottom="initial",this.list.show(document.body)},openDataLink:function(t,e){"json"==e&&(t.file+="on");var i=.5*window.innerWidth,s=.8*window.innerHeight,o=.5*(window.innerWidth-i),a=.5*(window.innerHeight-s);window.open(this.project.path+"/"+t.file,"","width="+i+",height="+s+",left="+o+",top="+a)},openLink:function(t){var e=window.open("about::blank",t||Date.now());e.focus();var i=this.project.path;this["export"]("phaser",function(){e.location&&(e.location.href=i+"/phaser/index.html",e.focus())})},a_complete:function(t){this.emit("done",t)}}),MT.namespace("plugins"),MT.require("ui.Input"),MT(MT.plugins.Settings=function(t){this.project=t,this.inputs=[],this.objects={},this.activeId=0},{initUI:function(t){this.panel=t.createPanel("Settings"),this.panel.setFree();this.panel.header.addClass("ui-wrap")},installUI:function(){var t=this;this.project.plugins.assetmanager.on([MT.ASSET_FRAME_CHANGED,MT.ASSET_SELECTED],function(e){e?t.handleAssets(e):t.clear()}),this.project.plugins.tools.on(MT.OBJECT_SELECTED,function(e){t.handleObjects(t.project.plugins.mapeditor.getById(e.id)),t.active=e.id}),this.project.plugins.tools.on(MT.OBJECT_UNSELECTED,function(){t.clear()});var e=this.project.plugins.mapeditor;
e.on("select",function(){t.handleScene(e.settings)})},handleClick:function(){},clear:function(){var t=this.inputs[this.stack];for(var e in t)t[e].hide();return this.stack="",void(this.lastObj=null);var e},addInput:function(t,e,i,s){this.inputs[this.stack]||(this.inputs[this.stack]={});var o=this.inputs[this.stack],a=t;if("string"!=typeof t&&(a=t.key),o[a])return o[a].setObject(e),o[a].show(),o[a];var n=this.panel.content,h=new MT.ui.Input(this.project.ui,t,e);return h.show(n.el),h.style.position="relative",h.style.height="20px",o[a]=h,h.on("change",s),h},lastObj:null,handleAssets:function(t){if(this.ooo=t,void 0===t.contents&&this.lastObj!=t){this.lastObj=t,this.clear();var e=this,i=function(){e.project.am.updateData()};t.key||(t.key=t.fullPath),this.stack="assets",this.addInput({key:"key",type:"text"},t,!1,i),this.addInput({key:"frameWidth",step:1,min:1},t,!1,i),this.addInput({key:"frameHeight",step:1,min:1},t,!0,i),this.addInput("frameMax",t,!1,i),this.addInput({key:"margin",step:1,min:0},t,!0,i),this.addInput({key:"spacing",step:1,min:0},t,!1,i),this.addInput({key:"anchorX",step:.5},t,!0,i),this.addInput({key:"anchorY",step:.5},t,!0,i),this.addInput({key:"fps",step:1},t,!0,i),this.addInput({key:"atlas",value:t.atlas,accept:MT["const"].DATA,type:"upload"},t,!0,function(t,i){0!==t.target.files.length&&e.project.am.addAtlas(i,t)}),this.addInput({key:"update",type:"upload",accept:MT["const"].IMAGES},t,!0,function(t,i){e.project.am.updateImage(i,t)})}},addEasingOptions:function(t){var e=[],i=Phaser.Easing;return this.genEasings(i,"Phaser.Easing",e),t.easing=t.easing||e[0].label,void this.addInput({key:"easing",type:"select",options:e},t)},genEasings:function(t,e,i){i=i||[];for(var s in t)"object"!=typeof t[s]?i.push({label:e+"."+s,value:e+"."+s}):this.genEasings(t[s],e+"."+s,i);return i},handleObjects:function(t){if(this.lastObj!=t){this.lastObj=t,this.clear();var e=this,i=function(){e.project.om.update()};t.data.type==MT.objectTypes.GROUP?(this.stack="group",this.objects.x=this.addInput("x",t,!0,i),this.objects.y=this.addInput("y",t,!0,i),this.objects.angle=this.addInput("angle",t,!0,i),void 0===t.isFixedToCamera&&(t.isFixedToCamera=0),this.objects.isFixedToCamera=this.addInput({key:"isFixedToCamera",min:0,max:1,step:1},t,!0,i),this.objects.scaleX=this.addInput({key:"scaleX",step:.1},t,!0,i),this.objects.scaleY=this.addInput({key:"scaleY",step:.1},t,!0,i)):t.data.type==MT.objectTypes.TILE_LAYER?(this.stack="layer",this.objects.x=this.addInput("x",t,!0,i),this.objects.y=this.addInput("y",t,!0,i),this.addInput("widthInTiles",t,!0,i),this.addInput("heightInTiles",t,!0,i),this.addInput("tileWidth",t,!0,i),this.addInput("tileHeight",t,!0,i),this.addInput({key:"isFixedToCamera",min:0,max:1,step:1},t,!0,i),this.addInput({key:"anchorX",step:.1},t,!0,i),this.addInput({key:"anchorY",step:.1},t,!0,i)):t.data.type==MT.objectTypes.TEXT?(this.stack="sprite",this.objects.x=this.addInput("x",t,!0,i),this.objects.y=this.addInput("y",t,!0,i),t._framesCount&&(this.objects.frame=this.addInput("frame",t,!0,function(){t.frame>=t._framesCount&&(t.frame=0),t.frame<0&&(t.frame=t._framesCount-1),e.objects.frame.setValue(t.frame,!0),i()})),this.objects.angle=this.addInput("angle",t,!0,i),this.objects.anchorX=this.addInput({key:"anchorX",step:.1},t,!0,i),this.objects.anchorY=this.addInput({key:"anchorY",step:.1},t,!0,i),this.objects.width=this.addInput({key:"width",step:1},t,!0,function(s,o){var a=o/t.scaleX,n=s/a;e.objects.scaleX.setValue(n),i(),e.objects.width.setValue(parseInt(s,10),!0)}),this.objects.wordWrapWidth=this.addInput({key:"wordWrapWidth",step:1},t,!0,i),this.objects.height=this.addInput({key:"height",step:1},t,!0,function(s,o){var a=o/t.scaleY,n=s/a;e.objects.scaleY.setValue(n),i(),e.objects.height.setValue(parseInt(s,10),!0)}),this.objects.scaleX=this.addInput({key:"scaleX",step:.1},t,!0,i),this.objects.scaleY=this.addInput({key:"scaleY",step:.1},t,!0,i)):(this.stack="sprite",this.objects.x=this.addInput("x",t,!0,i),this.objects.y=this.addInput("y",t,!0,i),t._framesCount&&(this.objects.frame=this.addInput("frame",t,!0,function(){t.frame>=t._framesCount&&(t.frame=0),t.frame<0&&(t.frame=t._framesCount-1),e.objects.frame.setValue(t.frame,!0),i()})),this.objects.angle=this.addInput("angle",t,!0,i),this.objects.anchorX=this.addInput({key:"anchorX",step:.1},t,!0,i),this.objects.anchorY=this.addInput({key:"anchorY",step:.1},t,!0,i),this.objects.width=this.addInput({key:"width",step:1},t,!0,function(s,o){var a=o/t.scaleX,n=s/a;e.objects.scaleX.setValue(n),i(),e.objects.width.setValue(parseInt(s,10),!0)}),this.objects.height=this.addInput({key:"height",step:1},t,!0,function(s,o){var a=o/t.scaleY,n=s/a;e.objects.scaleY.setValue(n),i(),e.objects.height.setValue(parseInt(s,10),!0)}),this.objects.scaleX=this.addInput({key:"scaleX",step:.1},t,!0,i),this.objects.scaleY=this.addInput({key:"scaleY",step:.1},t,!0,i)),this.objects.alpha=this.addInput({key:"alpha",min:0,max:1,step:.1},t,!0,i)}},update:function(){for(var t in this.objects)this.objects[t].update()},updateObjects:function(t){t.id!=this.activeId;for(var e in this.objects)this.objects[e].obj=t,this.objects[e].setValue(t[e],!0)},handleScene:function(t){this.clear(),this.stack="scene";var e=this,i=function(){e.project.plugins.mapeditor.updateScene(t)};this.scene={},this.scene.cameraX=this.addInput({key:"cameraX"},t,!0,i),this.scene.cameraY=this.addInput({key:"cameraY"},t,!0,i),this.scene.worldWidth=this.addInput({key:"worldWidth"},t,!0,i),this.scene.worldHeight=this.addInput({key:"worldHeight"},t,!0,i),this.scene.viewportWidth=this.addInput({key:"viewportWidth"},t,!0,i),this.scene.viewportHeight=this.addInput({key:"viewportHeight"},t,!0,i);var s=[{label:"NO_SCALE",value:"NO_SCALE",title:"A scale mode that prevents any scaling"},{label:"SHOW_ALL",value:"SHOW_ALL",title:"A scale mode that shows the entire game while maintaining proportions"},{label:"EXACT_FIT",value:"EXACT_FIT",title:"A scale mode that stretches content to fill all available space"},{label:"RESIZE",value:"RESIZE",title:"A scale mode that causes the Game size to change"},{label:"USER_SCALE",value:"USER_SCALE",title:"A scale mode that allows a custom scale factor"}];this.scene.scaleMode=this.addInput({key:"scaleMode",options:s,type:"select"},t,!0,i),this.scene.gridX=this.addInput({key:"gridX",min:2},t,!0,i),this.scene.gridY=this.addInput({key:"gridY",min:2},t,!0,i),this.scene.showGrid=this.addInput({key:"showGrid",min:0,max:1},t,!0,i),this.scene.gridOpacity=this.addInput({key:"gridOpacity",min:0,max:1,step:.1},t,!0,i),this.scene.backgroundColor=this.addInput({key:"backgroundColor",type:"color"},t,!0,i)},updateScene:function(t){for(var e in this.scene)this.scene[e].obj=t,this.scene[e].setValue(t[e])}}),MT.namespace("plugins"),MT.require("ui.TreeView"),MT.require("ui.List"),MT.require("core.Selector"),MT.objectTypes={SPRITE:0,GROUP:1,TEXT:2,TILE_LAYER:3,MOVIE_CLIP:4},MT.OBJECT_ADDED="OBJECT_ADDED",MT.OBJECT_SELECTED="OBJECT_SELECTED",MT.OBJECT_UNSELECTED="OBJECT_UNSELECTED",MT.OBJECT_DELETED="OBJECT_DELETED",MT.OBJECT_UPDATED="OBJECT_UPDATED",MT.OBJECT_UPDATED_LOCAL="OBJECT_UPDATED_LOCAL",MT.OBJECTS_RECEIVED="OBJECTS_RECEIVED",MT.OBJECTS_UPDATED="OBJECTS_UPDATED",MT.OBJECTS_SYNC="OBJECTS_SYNC",MT.extend("core.BasicPlugin").extend("core.Emitter")(MT.plugins.ObjectManager=function(t){MT.core.Emitter.call(this),MT.core.BasicPlugin.call(this,"om"),this.project=t,this.selector=new MT.core.Selector,this.id=Date.now(),this._activeGroup=null},{set activeGroup(t){this._activeGroup=t},get activeGroup(){return this._activeGroup},initUI:function(t){this.ui=t,this.panel=t.createPanel("Objects"),this.panel.setFree(),this.panel.content.style.overflow="initial";var e=this;this.panel.addButtons([{label:"Add Group",className:"add-group",cb:function(){e.createGroup()}},{label:"Add TileLayer",className:"add-tilelayer",cb:function(){e.createTileLayer()}},{label:"Group Selected Objects",className:"Group-selected",cb:function(){e.groupSelected()}},{label:"Delete Selected Objects",className:"delete-selected",cb:function(){e.deleteSelected()}}],t,!0),this.tv=new MT.ui.TreeView([],{root:this.project.path,showHide:!0,lock:!0}),this.tv.on("change",function(){e.update(),e.sync()}),this.tv.sortable(this.ui.events),this.tv.tree.show(this.panel.content.el),this.tv.on(["lock","open","close","show"],function(){e.update(),e.sync()}),this.tv.on(["click","select"],function(t){e.emit(MT.OBJECT_SELECTED,t),console.log("SELECT")});var i={};this.on(MT.OBJECT_UPDATED_LOCAL,function(t){t.id&&(i[t.id]&&window.clearTimeout(i[t.id]),i[t.id]=window.setTimeout(function(){e.emit(MT.OBJECT_UPDATED,t)},500))}),this.on(MT.OBJECT_UPDATED,function(t){e.saveObject(t.data),e.update()})},installUI:function(){var t=this,e=this.project.plugins.tools;e.on(MT.OBJECT_SELECTED,function(e){var i=t.tv.getById(e.id);i&&(i.isFolder&&i.data.type==MT.objectTypes.GROUP&&(t.activeGroup=i.data),i.addClass("selected.active"),t.selector.add(i))}),e.on(MT.OBJECT_UNSELECTED,function(e){if(t.activeGroup=null,e){var i=t.tv.getById(e.id);i&&(t.activeGroup&&t.activeGroup.id==e.id&&(t.activeGroup=null),i.removeClass("selected.active"),t.selector.remove(i))}}),e.on(MT.ASSET_FRAME_CHANGED,function(){t.updateTree()}),this.tv.on("deleted",function(e){t.selector.remove(e),t.activeGroup=null})},received:!1,a_receive:function(t,e){return this.received&&!e?void this.update():(this.received=!0,this.tv.merge(t),e||this.emit(MT.OBJECTS_UPDATED,this.tv.getData()),void this.update())},getData:function(){return this.tv.getData()},initSocket:function(t){MT.core.BasicPlugin.initSocket.call(this,t)},addObject:function(t,e){if(e.type!=MT.GROUP){var i=this.createObject(e,t.offsetX,t.offsetY);this.insertObject(i)}},insertObject:function(t,e,i){i=i||this.tv.getData();{var s,o;this.project.plugins.mapeditor}return this.activeGroup?(o=this.activeGroup.contents,s=this.activeGroup):o=i,s&&(t.x-=s.x,t.y-=s.y),t.id="tmp"+this.mkid(),t.tmpName=t.tmpName||t.name,t.name=t.tmpName+this.getNewNameId(t.tmpName,o,0),o.unshift(t),t.index=-1,e||(this.tv.rootPath=this.project.path,this.tv.merge(i),this.update(),this.emit(MT.OBJECT_ADDED,t),this.sync()),t},updateTree:function(){this.tv.merge(this.tv.getData())},createObject:function(t,e,i){e=e||0,i=i||0;var s=(this.tv.getData(),t.name.split("."));return s.pop(),s=s.join(""),{assetId:t.id,__image:t.__image,x:e,y:i,type:MT.objectTypes.SPRITE,anchorX:t.anchorX,anchorY:t.anchorY,userData:JSON.parse(JSON.stringify(t.userData||{})),physics:JSON.parse(JSON.stringify(t.physics||{})),scaleX:1,scaleY:1,angle:0,alpha:1,tmpName:s,frame:0,isVisible:1,isLocked:0,contents:[]}},createTextObject:function(t,e){t=t||0,e=e||0;var i="Text";return{x:t,y:e,type:MT.objectTypes.TEXT,anchorX:0,anchorY:0,scaleX:1,scaleY:1,angle:0,alpha:1,tmpName:i,wordWrapWidth:100,style:{fontFamily:"Arial",fontSize:32},align:"left",wordWrap:0,isVisible:1,isLocked:0}},createGroup:function(t){var e,i=this.tv.getData(),s=this.project.plugins.mapeditor;e=s.activeObject&&s.activeObject.type==MT.objectTypes.GROUP?s.activeObject.data.contents:i;for(var o="Group",a=o,n=0;n<e.length;n++)e[n].name==a&&(a=o+" "+n);var h={id:"tmp"+this.mkid(),name:a,x:0,y:0,type:MT.objectTypes.GROUP,angle:0,contents:[],isVisible:1,isLocked:0,isFixedToCamera:0,isClosed:0,scaleX:1,scaleY:1,alpha:1};return e.unshift(h),this.tv.merge(i),t||(this.update(),this.sync()),h},createMovieClip:function(t){for(var e=this.tv.getData(),i="Movie",s=i,o=0;o<e.length;o++)e[o].name==s&&(s=i+" "+o);var a={id:"tmp"+this.mkid(),name:s,x:0,y:0,type:MT.objectTypes.MOVIE_CLIP,angle:0,contents:[],isVisible:1,isLocked:0,isFixedToCamera:0,alpha:1};return e.unshift(a),this.tv.merge(e),t||(this.update(),this.sync()),a},createTileLayer:function(t){for(var e=this.tv.getData(),i="Tile Layer",s=i,o=0;o<e.length;o++)e[o].name==s&&(s=i+" "+o);var a={id:"tmp"+this.mkid(),type:MT.objectTypes.TILE_LAYER,name:s,x:0,y:0,anchorX:0,anchorY:0,angle:0,data:[],isVisible:1,isLocked:0,isFixedToCamera:0,tileWidth:32,tileHeight:32,widthInTiles:10,heightInTiles:10,alpha:1};return e.unshift(a),this.tv.merge(e),t||(this.update(),this.sync()),a},copy:function(t,e,i,s,o){s=s||t.name+this.getNewNameId(t.name,this.tv.getData());var a=JSON.parse(JSON.stringify(t));return a.name=s,a.x=e,a.y=i,this.cleanUpClone(a),this.insertObject(a,o),a},multiCopy:function(t,e){for(var i,s,o,a=this.tv.getData(),n=[],h=!1,r=0;r<t.length;r++)s=t[r],i=s.name+this.getNewNameId(s.name,a),o=JSON.parse(JSON.stringify(s)),o.name=i,h=this.activeGroup?this.activeGroup.id!=o.id:!1,this.cleanUpClone(o),e&&e(o),n.push(o),this.insertObject(o,!0,a,h);return this.tv.rootPath=this.project.path,this.tv.merge(a),this.update(),this.sync(),n},cleanUpClone:function(t,e){if(e=e||0,e++,t.contents)for(var i=0;i<t.contents.length;i++)this.cleanUpClone(t.contents[i],e);t.id="tmp"+this.mkid()},deleteSelected:function(){var t=this.tv.getData();this.selector.forEach(function(e){this.deleteObj(e.data.id,!0,t)},this),this.selector.clear(),this.tv.merge(t),this.ui.events.simulateKey(MT.keys.ESC),this.sync()},deleteObj:function(t,e,i){var s=i||this.tv.getData();this._delete(t,s),i||this.tv.merge(s),e||(this.ui.events.simulateKey(MT.keys.ESC),this.sync(),this.update()),this.emit(MT.OBJECT_DELETED,t)},_delete:function(t,e){for(var i=0;i<e.length;i++){if(e[i].id==t){e.splice(i,1)[0];break}e[i].contents&&this._delete(t,e[i].contents)}},getNewNameId:function(t,e,i){i=i||0;var s=t;i>0&&(s+=i);for(var o=0;o<e.length;o++)e[o].name==s&&(i++,i=this.getNewNameId(t,e,i));return i>0?i:""},buildObjectsTree:function(t){this.tv.rootPath=this.project.path,this.tv.merge(t),this.tv.tree.show(this.panel.content.el)},moveFile:function(t,e){this.send("moveFile",{a:t,b:e})},update:function(){this.emit(MT.OBJECTS_UPDATED,this.tv.getData())},select:function(t){this.tv.select(t)},mkid:function(){return this.id++,this.id},groupSelected:function(){var t=this.createGroup(!0);t.isClosed=!1;var e=this.tv.getData();this.selector.forEach(function(i){var s=i.data;this._delete(s.id,e),t.contents.push(s)},this),this.tv.merge(e),this.update(),this.sync()},_syncTm:0,sync:function(t){this._syncTm&&(window.clearTimeout(this._syncTm),this._syncTm=0);var e=this;this._syncTm=window.setTimeout(function(){var i=e.tv.getData(),s=JSON.stringify(i);return this._lastData==s?void(this._syncTm=0):(this._lastData=s,t||e.emit(MT.OBJECTS_SYNC,i),console.log("sync"),e.send("updateData",i),e._syncTm=0,void e.updateTree())},100)},_saveTm:0,saveObject:function(t){this._saveTm&&(window.clearTimeout(this._saveTm),this._saveTm=0);var e=this;this._saveTm=window.setTimeout(function(){e.send("save",t),console.log("save"),e.emit(MT.OBJECTS_SYNC,e.tv.getData()),e.updateTree()},1e3)},getById:function(t){for(var e=this.tv.items,i=0;i<e.length;i++)if(e[i].data.id==t)return e[i].data;return null}}),MT.namespace("plugins"),MT.require("ui.TreeView"),MT.require("ui.List"),MT.ASSET_ADDED="ASSET_ADDED",MT.ASSET_SELECTED="ASSET_SELECTED",MT.ASSET_UNSELECTED="ASSET_UNSELECTED",MT.ASSET_UPDATED="ASSET_UPDATED",MT.ASSET_DELETED="ASSET_DELETED",MT.ASSET_FRAME_CHANGED="ASSET_FRAME_CHANGED",MT.ASSETS_RECEIVED="ASSETS_RECEIVED",MT.ASSETS_UPDATED="ASSETS_UPDATED",MT.extend("core.BasicPlugin").extend("core.Emitter")(MT.plugins.AssetManager=function(t){MT.core.Emitter.call(this),MT.core.BasicPlugin.call(this,"assets"),this.selector=new MT.core.Selector,this.project=t,this.active=null,this.knownFrames={},this.list={},this.__previewCache={},this.panels={},this.scale=0,this.pendingFrame=-1},{get activeFrame(){if(!this.active)return 0;var t=this.active.data.id;return void 0!=this.knownFrames[t]?this.knownFrames[t]:0},set activeFrame(t){if(this.active){var e=this.active.data.id;this.knownFrames[e]=t}},initUI:function(t){var e=this;this.ui=t,this.panel=t.createPanel("Assets"),this.panel.setFree(),this.panel.content.style.padding=0,this.panel.addButtons([{label:"New Folder",className:"new-folder",cb:function(){e.newFolder()}},{label:"Upload File",className:"upload-file",cb:function(){e.upload()}},{label:"Upload Folder",className:"upload-folder",cb:function(){e.uploadFolder()},check:function(){return window.navigator.userAgent.indexOf("WebKit")>-1?!0:void 0}},{label:"Delete Selected",className:"delete-selected",cb:function(){e.confirmDeleteSelected()}}]),this.panel.content.el.setAttribute("hint","Drop assets here to upload"),this.tv=new MT.ui.TreeView([],this.project.path),this.tv.sortable(this.ui.events),this.tv.tree.show(this.panel.content.el);var i=function(t,i){e.active!=i&&(e.active&&e.active.removeClass("selected"),e.active=i,e.pendingFrame>-1&&(e.activeFrame=e.pendingFrame,e.pendingFrame=-1),e.active.addClass("selected"),t.contents||e.setPreviewAssets(e.active.data))},s=function(){e.updateData()};this.tv.on("click",function(t,i){var s=!1;return e.ui.events.mouse.lastClick&&e.ui.events.mouse.lastClick.shiftKey&&(s=!0),s?void(e.selector.is(i)?(e.selector.remove(i),i.removeClass("selected.active")):(e.selector.add(i),i.addClass("selected"))):(e.selector.forEach(function(t){t.removeClass("active.selected")}),e.selector.clear(),e.active&&!s&&(e.active.removeClass("active.selected"),e.selector.remove(i)),e.selector.add(i),e.active=i,e.active.addClass("active.selected"),e.emit(MT.ASSET_SELECTED,e.active.data,e.activeFrame),void e.setPreviewAssets(t))}),this.tv.on("select",i);var o=new MT.ui.List([{label:"Make active",cb:function(){e.emit(MT.ASSET_FRAME_CHANGED,e.active.data,e.activeFrame)}},{label:"Download image",cb:function(){console.log(e.active),window.open(e.active.img.src)}},{label:"Delete",cb:function(){e.confirmDeleteAsset(e.active.data.id),o.hide()}}],this.ui,!0);o.width=250,this.tv.on("context",function(t,e){console.log("context"),i(e.data,e),o.x=t.pageX,o.y=t.pageY,o.show()}),this.tv.on("change",function(t,i){t&&i&&e.moveFile(t,i)}),this.tv.on("open",s),this.tv.on("close",s),this.preview=t.createPanel("assetPreview"),this.preview.setFree(),this.scale=1;var a=window.pce=this.preview.content;t.events.on(t.events.WHEEL,function(t){a.isParentTo(t.target)&&t.shiftKey&&(t.preventDefault(),t.stopPropagation(),e.scale+=.1*(t.wheelDelta/Math.abs(t.wheelDelta)),e.scale>2&&(e.scale=0),e.scale<.1&&(e.scale=.1),e.setPreviewAssets())}),this.project.on(MT.DROP,function(t,i){if(MT.core.Helper.isImage(i.path)){if(!t)return void e.createImage(i);var s=e.tv.getOwnItem(t.target);s&&s.data.contents&&(i.path=s.data.fullPath+i.path),e.createImage(i)}}),t.events.on(t.events.KEYDOWN,function(t){var i=t.which;i==MT.keys.ESC&&e.unselectAll()})},mkScaleOptions:function(){for(var t,e=[],i=100;i>0;i-=10)t={label:i,className:"",cb:this._mkZoomCB(i)},e.push(t);return e},_mkZoomCB:function(t){var e=this;return function(){e.scale=.01*t,e.preview.options.list.hide(),e.setPreviewAssets()}},unselectAll:function(){var t=this;this.selector.forEach(function(e){e.removeClass("active.selected"),t.emit(MT.ASSET_UNSELECTED,e)}),this.selector.clear(),this.preview.content.clear(),this.active&&(this.active.removeClass("active.selected"),t.emit(MT.ASSET_UNSELECTED,this.active),this.active=null)},_previewCache:null,setPreviewAssets:function(t){if(t.contents)return void this.preview.content.clear();var e=this.project.plugins.tools;if(e&&e.activeTool&&e.activeTool==e.tools.tiletool)return void e.tools.tiletool.updatePreview(t);if(void 0==t&&this.active&&(t=this.active.data),void 0!=t&&!t.contents){var i,s=this.project.plugins.mapeditor;i=void 0==this.panels[t.id]?[]:this.panels[t.id];var o;if(t.atlas){var a=s.atlasNames[t.id];if(!a)return;a.all_frames&&(o=this.createPreviewPanel("all_frames",i,t,a,!0),this.drawAtlasImage(o));for(var n in a)o=this.createPreviewPanel(n||"xxx",i,t,a,!0),this.drawAtlasImage(o)}else if(i.length>0)this.drawSpritesheet(i[0]),i.active=i[0],this.preview.content.clear();else{o=new MT.ui.Panel(t.name),i.push(o),o.fitIn(),o.addClass("borderless");var h=this.project.plugins.mapeditor.game.cache.getImage(t.id+"");if(!h)return;var r=document.createElement("canvas");r.width=h.width,r.height=h.height;var l=r.getContext("2d");o.data={asset:t,group:i,canvas:r,ctx:l,image:h},o.content.el.appendChild(o.data.canvas),this.drawSpritesheet(o),this.addSpriteEvents(o)}0!=i.length&&(i.active||(i.active=i[0]),i.active.hide(),i.active.show(this.preview.content.el),i.active.data.scrollLeft&&(i.active.content.el.scrollLeft=i.active.data.scrollLeft),i.active.data.scrollTop&&(i.active.content.el.scrollTop=i.active.data.scrollTop),this.panels[t.id]=i)}},createPreviewPanel:function(t,e,i,s,o){for(var a=null,n=0;n<e.length;n++)if(e[n].title==t)return a=e[n],a.data.frames=s[t],a;a=new MT.ui.Panel(t);var h=e[e.length-1];return e.push(a),a.fitIn(),a.addClass("borderless"),a.data={frames:s[t],asset:i,group:e,canvas:document.createElement("canvas"),ctx:null},a.data.ctx=a.data.canvas.getContext("2d"),h&&h.addJoint(a),o?this.addAtlasEvents(a):this.addSpriteEvents(a),a},drawAtlasImage:function(t){{var e=t.data.asset;-1!==e.atlas.split(".").pop().toLowerCase().indexOf("xml")}this.drawAtlasJSONImage(t),t.data.canvas.style.cssText="width: "+t.data.canvas.width*this.scale+"px"},drawAtlasJSONImage:function(t){var e=this.project.plugins.mapeditor,i=e.game,s=i.cache._images[t.data.asset.id],o=null;o=t.data.ctx;var a,n,h=s.frameData,r=s.data,l=0,c=0,d=0;t.data.rectangles=[];var u=t.data.group.active;if(u&&!u.data.frames){u.unjoin(),u.remove();var p=t.data.group.indexOf(u);t.data.group.splice(p,1)}if("all_frames"==t.title){var m=s.data;t.data.canvas.width=m.width,t.data.canvas.height=m.height,o.clearRect(0,0,m.width,m.height),o.drawImage(m,0,0),o.strokeStyle="rgba(0,0,0,0.5);";for(var f=0;f<h._frames.length;f++)a=h.getFrame(f),n=PIXI.TextureCache[a.uuid],t.data.rectangles.push(new Phaser.Rectangle(a.x,a.y,n.width,n.height)),this.activeFrame==f&&(o.fillStyle="rgba(0,0,0,0.5);",o.fillRect(a.x,a.y,n.width,n.height),(!u||!u.data.frames||f<u.data.frames.start||f>u.data.frames.end)&&(t.data.group.active=t)),o.strokeRect(a.x+.5,a.y+.5,n.width,n.height);return void t.content.el.appendChild(t.data.canvas)}for(var f=t.data.frames.start;f<t.data.frames.end;f++)a=h.getFrame(f),n=PIXI.TextureCache[a.uuid],c+=n.width,d<n.height&&(d=n.height);t.data.canvas.width!=c&&(t.data.canvas.width=c,t.data.canvas.height=d),o.clearRect(0,0,c,d);for(var f=t.data.frames.start;f<t.data.frames.end;f++){a=h.getFrame(f);{a.getRect()}n=PIXI.TextureCache[a.uuid],r=n.baseTexture.source;var v=0,g=0;n.trim&&(v=n.trim.x,g=n.trim.y),o.drawImage(r,a.x,a.y,n.width,n.height,l,0,n.width,n.height),t.data.rectangles.push(new Phaser.Rectangle(l,0,n.width,n.height)),this.activeFrame==f&&(o.fillStyle="rgba(0,0,0,0.5);",o.fillRect(l,0,n.width,d),(!u||f<u.data.frames.start||f>u.data.frames.end)&&(t.data.group.active=t)),l+=n.width,o.beginPath(),o.moveTo(l+.5,0),o.lineTo(l+.5,d),o.stroke()}t.content.el.appendChild(t.data.canvas)},drawSpritesheet:function(t){var e=this.project.plugins.mapeditor.game.cache.getImage(t.data.asset.id+""),i=t.data.ctx;if(!e){var s=this;return void window.setTimeout(function(){s.drawSpritesheet(t)},100)}var o=t.data.asset;i.canvas.width=e.width,i.canvas.height=e.height,i.clearRect(0,0,e.width,e.height),i.drawImage(e,0,0,e.width,e.height),i.beginPath();for(var a=o.frameWidth+o.margin;a<e.width;a+=o.frameWidth+o.spacing)i.moveTo(a+.5,o.margin),i.lineTo(a+.5,e.height);for(var a=o.frameHeight+o.margin;a<e.height;a+=o.frameHeight+o.spacing)i.moveTo(o.margin,a+.5),i.lineTo(e.width,a+.5);i.stroke();var n=o.margin+o.spacing*Math.floor(e.width/o.frameWidth-o.spacing),h=(e.width-n)/o.frameWidth;console.log("width",h),console.log("FRAME",this.activeFrame);var r=this.getTileX(this.activeFrame,h),l=this.getTileY(this.activeFrame,h);i.fillStyle="rgba(0,0,0,0.5)",i.fillRect(o.margin+o.frameWidth*r+r*o.spacing+.5,o.margin+o.frameHeight*l+l*o.spacing+.5,o.frameWidth+.5,o.frameHeight+.5)},getTileX:function(t,e){return t%e},getTileY:function(t,e){return t/e|0},addSpriteEvents:function(t){var e=this,i=t.data.canvas,s=!1,o=function(i){var s=e.getFrame(t.data.asset,i.offsetX,i.offsetY);if(s!=e.activeFrame||e.active!=t.data.asset){var o=t.data.asset,a=Math.floor(o.width/o.frameWidth*(o.height/o.frameHeight)-1);s>a||(t.data.scrollTop=t.content.el.scrollTop,t.data.scrollLeft=t.content.el.scrollLeft,e.activeFrame=s,e.emit(MT.ASSET_FRAME_CHANGED,e.active.data,e.activeFrame))}};i.onmousedown=function(t){s=!0,o(t)},i.onmousemove=function(t){s&&o(t)},this.ui.events.on(this.ui.events.MOUSEUP,function(t){s&&(s=!1,o(t))})},addAtlasEvents:function(t){var e=this,i=!1,s=function(i){for(var s=(t.data.frames.end-t.data.frames.start-1,t.data.canvas.width,i.offsetX/e.scale),o=i.offsetY/e.scale,a=t.data.frames.start,n=!1,h=0;h<t.data.rectangles.length;h++)if(t.data.rectangles[h].contains(s,o)){a+=h,n=!0;break}n&&(a!=e.activeFrame||e.active!=t.data.asset)&&(t.data.scrollTop=t.content.el.scrollTop,t.data.scrollLeft=t.content.el.scrollLeft,e.activeFrame=a,t.data.group.active=t,e.emit(MT.ASSET_FRAME_CHANGED,t.data.asset,a))};t.data.canvas.oncontextmenu=function(){return!1},t.data.canvas.onmousedown=function(t){t.preventDefault(),0==t.button&&(i=!0,s(t))},t.data.canvas.onmousemove=function(t){return 2==t.button?(this.parentNode.scrollTop-=e.ui.events.mouse.my,void(this.parentNode.scrollLeft-=e.ui.events.mouse.mx)):void(i&&s(t))},this.ui.events.on(this.ui.events.MOUSEUP,function(t){i&&0==t.button&&(i=!1,s(t))})},installUI:function(){var t=this,e=this.project.plugins.tools;e.on(MT.OBJECT_SELECTED,function(e){e&&(t.pendingFrame=e.frame,t.selectAssetById(e.data.assetId))}),e.on(MT.OBJECT_UNSELECTED,function(e){if(!e)return void t.unselectAll();var i=t.tv.getById(e.assetId);t.emit(MT.ASSET_UNSELECTED,i),t.active&&(t.active.removeClass("selected.active"),t.active=null,t.unselectAll()),t.selector.is(i)&&(i.removeClass("selected.active"),t.selector.remove(i))}),this.on(MT.ASSET_FRAME_CHANGED,function(i,s){e.activeTool==e.tools.select&&(t.project.map.selector.forEach(function(e){i?(e.data.assetId=i.id,e.data.__image=i.__image,e.frame=s,t.activeFrame=s):(delete e.data.assetId,delete e.data.__image,e.frame=0,t.activeFrame=0),t.project.plugins.objectmanager.update(),t.project.plugins.objectmanager.sync()}),t.setPreviewAssets(i))});var i=this.project.plugins.mapeditor,s=!1;this.tv.on("dragmove",function(t,o){return t.target!==i.game.canvas?void e.removeTmpObject():(s=!0,void e.tools.stamp.init(o.data))}),this.tv.on("dragend",function(t){if(0!=s){if(s=!1,t.target!==i.game.canvas)return void e.removeTmpObject();e.tools.stamp.mouseDown(t),e.removeTmpObject()}})},selectAssetById:function(t,e){var i=this.tv.getById(t);return this.tv.select(t),this.selector.add(i),e&&this.setPreviewAssets(i),i},selectActiveAsset:function(t){(void 0!=t||this.active)&&(this.emit(MT.ASSET_FRAME_CHANGED,this.active.data,this.activeFrame),this.setPreviewAssets(this.active.data))},updateImage:function(t,e){var i=this;this.project.plugins.mapeditor.cleanImage(t.id);var s=new Image;this.readFile(e.target.files[0],function(e){var o=Array.prototype.slice.call(new Uint8Array(e.result));s.onload=function(){t.width=s.width,t.height=s.height,t.updated=Date.now(),i.guessFrameWidth(t),i.emit(MT.ASSET_FRAME_CHANGED,t,i.activeFrame),i.active.data=t,i.send("updateImage",{asset:t,data:o})},s.src=i.toPng(e.result)})},addAtlas:function(t,e){var i=this,s=e.target.files[0],o=s.name.split(".").pop();if(-1===MT["const"].DATA.indexOf(o)){var a=new MT.ui.Popup("Incorrect format","Atlas loading canceled<br /><br />");return a.showClose(),void a.addButton("OK",function(){a.hide()})}this.readFile(s,function(e){i.send("addAtlas",{id:t.id,ext:o,data:Array.prototype.slice.call(new Uint8Array(e.result))})})},getFrame:function(t,e,i){var s=e-t.margin,o=i-t.margin;0>s&&(s=0),0>o&&(o=0);var a=Math.floor(s/(t.frameWidth+t.spacing)),n=Math.floor(o/(t.frameHeight+t.spacing)),h=Math.floor(t.width/t.frameWidth),r=a+h*n;return console.log(r,"frame"),r},update:function(){var t=this.tv.getData();this.active&&this.setPreviewAssets(this.active.data),this.emit(MT.ASSETS_UPDATED,t)},a_receiveFileList:function(t){this.buildAssetsTree(t),this.buildList(t),this.update(),this.updateNotifications(t)},buildList:function(t){for(var e=0;e<t.length;e++)t[e].contents?this.buildList(t[e].contents):this.list[t[e].id]=t[e]},handleDrop:function(t){var e=t.dataTransfer.files;this.handleFiles(e,t.dataTransfer)},handleFiles:function(t,e){for(var i=null,s=0;s<t.length;s++)e?(i=e.items[s].getAsEntry?e.items[s].getAsEntry():e.items[s].webkitGetAsEntry(),this.handleEntry(i)):this.handleFile(t.item(s))},handleFile:function(t){var e=t.webkitRelativePath||t.path||t.name;0==t.size?this.send("newFolder",e):this.uploadImage(t,e)},upload:function(){var t=this,e=document.createElement("input");e.type="file",e.onchange=function(){t.handleFiles(this.files)},e.click()},uploadFolder:function(){var t=this,e=document.createElement("input");e.type="file",e.setAttribute("webkitdirectory",""),e.setAttribute("directory",""),e.value="",e.onchange=function(){t.handleFiles(this.files)},e.click()},handleEntry:function(t){var e=this;if(t.isFile)t.file(function(i){e.uploadImage(i,t.fullPath)});else if(t.isDirectory){this.send("newFolder",t.fullPath);var i=t.createReader();i.readEntries(function(t){for(var i=0;i<t.length;i++)e.handleEntry(t[i])})}},updateData:function(){this.send("updateData",this.tv.getData())},buildAssetsTree:function(t){t.sort(function(t,e){var i=t.contents?1e3:0,s=e.contents?1e3:0,o=t.name>e.name?1:-1;return o+s-i}),this.tv.rootPath=this.project.path,this.tv.merge(t)},moveFile:function(t,e){this.send("moveFile",{a:t,b:e}),this.updateData()},newFolder:function(){for(var t=this.tv.getData(),e="new folder",i=e,s=0;s<t.length;s++)t[s].name==i&&(i=e+" "+s);t.unshift({name:i,contents:[]}),this.send("newFolder",i),this.tv.merge(t)},deleteSelected:function(){this.selector.forEach(function(t,e){this.deleteAsset(t.data.id,!e)},this)},deleteAsset:function(t,e){this.project.plugins.mapeditor.cleanImage(t),this.send("delete",t),this.emit(MT.ASSET_DELETED,t),e||this.ui.events.simulateKey(MT.keys.ESC)},confirmDeleteAsset:function(t){var e=this,i=new MT.ui.Popup("Delete Asset?","Do you really want to delete asset?");i.addButton("no",function(){i.hide()}),i.addButton("yes",function(){e.deleteAsset(t),i.hide()}),i.showClose()},confirmDeleteSelected:function(t){var e=this,i=new MT.ui.Popup("Delete all selected assets?","Do you really want to delete all selected assets?");i.addButton("no",function(){i.hide()}),i.addButton("yes",function(){e.deleteSelected(t),i.hide()}),i.showClose()},getById:function(t){for(var e=this.tv.items,i=0;i<e.length;i++)if(e[i].data.id==t)return e[i].data;return null},readFile:function(t,e){var i=new FileReader;i.onload=function(){e(i)},i.readAsArrayBuffer(t)},uploadImage:function(t,e){"/"!=e.substring(0,1)&&(e="/"+e);this.project.readFile(t,e)},notifications:[],createImage:function(t){var e=t.path,i=t.src,s=e.split("/").pop(),o=new Image,a=this,n=Array.prototype.slice.call(new Uint8Array(i));o.onload=function(){var t={data:n,id:MT.core.Helper.uuid(),name:s,path:e,fullPath:e,key:e,width:o.width,height:o.height,frameWidth:o.width,frameHeight:o.height,frameMax:-1,margin:0,spacing:0,anchorX:0,anchorY:0,fps:10,updated:Date.now(),atlas:""};a.guessFrameWidth(t),a.send("newImage",t),a.emit(MT.ASSET_ADDED,e);var i=a.project.plugins.notification.show(e,"Upload in progress...",999999);a.notifications[e]=i},o.src=a.toPng(i)},updateNotifications:function(t){for(var e=0;e<t.length;e++){if(this.notifications[t[e].key])return void this.notifications[t[e].key].hide();t[e].contents&&this.updateNotifications(t[e].contents)}},toPng:function(t){for(var e="",i=new Uint8Array(t),s=0;s<i.length;s++)e+=String.fromCharCode(i[s]);return"data:image/png;base64,"+btoa(e)},guessFrameWidth:function(t){var e=t.name.split(".");e.pop();var i=e.join(".").split("_").pop(),s=null;if(i){s=i.split("x");var o=parseInt(s[0],10),a=parseInt(s[1],10);o&&!isNaN(o)&&a&&!isNaN(a)&&(t.frameWidth=o,t.frameHeight=a)}}}),MT.namespace("ui"),MT.require("ui.Button"),MT.require("ui.PanelHead"),MT.extend("core.Emitter").extend("ui.DomElement")(MT.ui.Panel=function(t,e){""==t&&(t="&nbsp;"),MT.ui.DomElement.call(this),this.setAbsolute(),this.header=new MT.ui.PanelHead(this),this.mainTab=this.header.addTab(t),this.content=new MT.ui.DomElement,this.appendChild(this.content),this.content.show(this.el),this.content.addClass("ui-panel-content"),this._input=document.createElement("input"),this._input.setAttribute("readonly","readonly"),this._input.style.cssText="position: fixed; top: -99999px;",this.content.el.appendChild(this._input),t&&this.addHeader(),this.title=t,this.buttons=[],this.savedBox={x:0,y:0,width:0,height:0},this.isVisible=!1,this.joints=[this],this.addClass("ui-panel"),this.top=null,this.right=null,this.bottom=null,this.left=null,this.ui=e
},{isResizeable:!1,isMovable:!1,isDockable:!1,isJoinable:!1,acceptsPanels:!1,isPickable:!0,isCloaseable:!1,isRenamable:!1,set title(t){this.mainTab.title.innerHTML=t},get title(){return this.mainTab.title.innerHTML},get activeJoint(){for(var t=0;t<this.joints.length;t++)if(this.joints[t].isVisible)return this.joints[t]},startRename:function(){var t=this.mainTab,e=this;this.emit("renameStart"),this.input||(this.input=document.createElement("input"),this.input.className="ui-input ui-panel-rename"),this.input.style.left=t.calcOffsetX(document.body)+"px",this.input.style.top=t.calcOffsetY(document.body)-2+"px",this.input.style.width=t.width-10,this.input.value=this.title;var i=this.title;this.input.type="text",t.title.style.visibility="hidden",document.body.appendChild(this.input);var s=!0;this.input.onblur=function(){try{this.parentNode&&this.parentNode.removeChild(this)}catch(o){}var a=i,n=this.value;s&&""!=this.value&&a!==n&&(t.title.innerHTML=n,e.title=n,e.emit("rename",n,a)),t.title.style.visibility="visible"},this.input.addEventListener("keydown",function(t){t.stopPropagation()}),this.input.onkeyup=function(t){t.stopPropagation(),t.which==MT.keys.ESC&&(s=!1,this.blur()),t.which==MT.keys.ENTER&&this.blur()},this.input.focus();var o=this.title.split("."),a=0;a=1==o.length?o[0].length:-1;for(var n=0;n<o.length-1;n++)a+=o[n].length+1;this.input.setSelectionRange(0,a),this.inputEnabled=!0},setFree:function(){this.isMovable=!0,this.isDockable=!0,this.isJoinable=!0,this.isDockable=!0,this.isResizeable=!0,this.acceptsPanels=!0},focus:function(){this._input.focus()},addOptions:function(t){this.options={};var e=this.options.list=new MT.ui.List(t,this.ui,!0);e.addClass("settings-list");var i=this,s=this.options.button=new MT.ui.Button(null,"ui-options",null,function(t){t.stopPropagation(),e.isVisible?(e.hide(),s.removeClass("selected")):(e.show(i.header.el),s.addClass("selected"))});return s.show(this.header.el),e.on("hide",function(){s.removeClass("selected")}),this.header.addChild(this.options),e.style.left=0,e.style.right=0,this.options},addButtons:function(t){this.buttonsHolder||(this.buttonsHolder=document.createElement("div"),this.buttonsHolder.className="panel-buttonsHolder",this.content.el.appendChild(this.buttonsHolder));for(var e,i=0;i<t.length;i++)e=new MT.ui.Button(null,"panel-head-button "+t[i].className,null,t[i].cb),e.show(this.buttonsHolder),e.el.setAttribute("title",t[i].label)},removeBorder:function(){this.addClass("borderless")},showBorder:function(){this.removeClass("borderless")},activate:function(){this.show()},reset:function(t){this.dockPosition=t.dockPosition,this.isDocked=t.isDocked,this.x=t.x,this.y=t.y,this.width=t.width,this.height=t.height,this.top=null,this.bottom=null,this.joints.length>1&&(this.isVisible=!0,MT.ui.DomElement.show.call(this,this._parent)),this.joints=[this],this.header.tabs=[this.mainTab],this.header.setTabs(this.header.tabs),this.setClearX(t.x),this.setClearY(t.y),this.setClearWidth(t.width),this.setClearHeight(t.height)},setX:function(t){this.setClearX(t),this.top&&this.top.x!=t&&this.top.setX(t),this.bottom&&this.bottom.x!=t&&this.bottom.setX(t)},setClearX:function(t){for(var e=0;e<this.joints.length;e++)MT.ui.DomElement.setX.call(this.joints[e],t)},setWidth:function(t){this.setClearWidth(t),this.top&&this.top.width!=t&&this.top.setWidth(t),this.bottom&&this.bottom.width!=t&&this.bottom.setWidth(t)},setClearWidth:function(t){for(var e=0;e<this.joints.length;e++)MT.ui.DomElement.setWidth.call(this.joints[e],t),this.joints[e].emit("resize",this.width,this.height)},setY:function(t){this.top&&(this.top.height+=t-this.y),this.setClearY(t)},setClearY:function(t){for(var e=0;e<this.joints.length;e++)MT.ui.DomElement.setY.call(this.joints[e],t)},alingCenter:function(){this.x=.5*(window.innerWidth-this.width),this.y=.5*(window.innerHeight-this.height)},setHeight:function(t){this.dockPosition==MT.TOP&&this.bottom&&this.bottom.setClearY(this.bottom.y+(t-this.height)),this.setClearHeight(t),this.left&&this.left.height!=t&&this.left.setWidth(t),this.right&&this.right.width!=t&&this.right.setWidth(t)},setClearHeight:function(t){for(var e=0;e<this.joints.length;e++)MT.ui.DomElement.setHeight.call(this.joints[e],t),this.joints[e].emit("resize",this.width,this.height)},show:function(t,e){if(this.header.showTabs(),this.isVisible)return this;for(var i=0;i<this.joints.length;i++)this.joints[i].hide(!1);MT.ui.DomElement.show.call(this,t),this.setAll("_parent",this._parent),e!==!1&&this.emit("show"),this.content.fitIn();var s=this,o=function(){return s.header.el.offsetHeight?void(s.content.y=s.header.el.offsetHeight):void window.setTimeout(o,50)};return o(),this},addClass:function(t){for(var e=0;e<this.joints.length;e++)MT.ui.DomElement.addClass.call(this.joints[e],t)},removeClass:function(t){for(var e=0;e<this.joints.length;e++)MT.ui.DomElement.removeClass.call(this.joints[e],t)},setJoints:function(t,e){for(var i=0;i<this.joints.length;i++)this.joints[i][t]=e},setAll:function(t,e){this.setJoints(t,e)},setTop:function(t,e){this.setAll(t,e),this.top&&this.top.setTop(t,e)},setBottom:function(t,e){this.setAll(t,e),this.bottom&&this.bottom.setBottom(t,e)},setTopBottom:function(t,e){this.setTop(t,e),this.setBottom(t,e)},setLeftRight:function(){},unjoin:function(){if(1==this.joints.length)return void this.breakSideJoints();this.removeSideJoints();var t=this.joints;this.joints=[this];for(var e=0;e<t.length;e++)if(t[e]==this){t.splice(e,1);break}this.header.removeTab(this.mainTab),this.header.setTabs([this.mainTab]);for(var e=0;e<t.length;e++)if(t[e]!=this){t[e].show(),t[e].header.showTabs();break}},addJoint:function(t){if(!t||this==t)return void console.log("joining with self?");if(t._parent=this._parent,t.removeClass("animated"),this.removeClass("animated"),t.joints!=this.joints){for(var e=0;e<t.joints.length;e++)this.joints.push(t.joints[e]);if(t.setAll("joints",this.joints),this.header.tabs!=t.header.tabs)for(var i=t.header.tabs,s=!0,e=i.length-1;e>-1;e--){for(var o=0;o<this.header.tabs.length;o++)if(this.header.tabs[o]==i[e]){s=!1;break}s&&this.header.tabs.push(i[e])}for(var e=0;e<this.joints.length;e++)this.joints[e].header.tabs=this.header.tabs;this.setAll("top",this.top),this.setAll("bottom",this.bottom);var o=this.activeJoint;o&&o.show()}},_dockPosition:MT.NONE,set dockPosition(t){var e=this.getTopMost();e.setDockPosition(t)},setDockPosition:function(t){this.removeClassAll("docked-left"),this.removeClassAll("docked-right"),this.removeClassAll("docked-top"),this.removeClassAll("docked-bottom"),this.removeClassAll("docked-left-bottom"),this.removeClassAll("docked-left-top"),this.removeClassAll("docked-center"),this.setAll("_dockPosition",t),(t==MT.LEFT||t==MT.RIGHT)&&(this.top||this.addClassAll("docked-left-top"),this.bottom||this.addClassAll("docked-left-bottom"),t==MT.LEFT&&this.addClassAll("docked-left"),t==MT.RIGHT&&this.addClassAll("docked-right")),t==MT.TOP&&this.addClassAll("docked-top"),t==MT.BOTTOM&&this.addClassAll("docked-bottom"),t==MT.CENTER&&this.addClassAll("docked-center"),this.bottom&&this.bottom.setDockPosition(t)},getTopMost:function(){for(var t=this;t.top;)t=t.top;return t},getBottomMost:function(){for(var t=this;t.bottom;)t=t.bottom;return t},get dockPosition(){return this._dockPosition},addClassAll:function(t){for(var e=0;e<this.joints.length;e++)this.joints[e].addClass(t)},removeClassAll:function(t){for(var e=0;e<this.joints.length;e++)this.joints[e].removeClass(t)},joinBottom:function(t,e){t!=this.bottom&&(e||(this.setClearHeight(this.height-t.height),t.setClearWidth(this.width),t.setClearX(this.x),t.setClearY(this.y+this.height)),this.bottom&&(this.bottom.setAll("top",t),t.setAll("bottom",this.bottom)),this.setAll("bottom",t),t.setAll("top",this),t.setAll("top",t.top),t.setAll("bottom",t.bottom))},joinTop:function(t,e){if(t!=this.top){if(!e){this.setClearHeight(this.height-t.height),t.setClearWidth(this.width),t.setClearX(this.x);var i=this.y+this.height;t.setClearY(this.y),this.setClearY(i)}this.top&&(this.top.setAll("bottom",t),t.setAll("top",this.top)),this.setAll("top",t),t.setAll("bottom",this)}},removeSideJoints:function(){if(this.joints.length>1){for(var t=null,e=0;e<this.joints.length&&(t=this.joints[e],t==this);e++);return this.setAll("top",this.top),this.setAll("bottom",this.bottom),this.top&&this.top.setAll("bottom",t),this.bottom&&this.bottom.setAll("top",t),this.top=null,void(this.bottom=null)}this.top&&this.top.setAll("bottom",this.bottom),this.bottom&&this.bottom.setAll("top",this.top),this.top=null,this.bottom=null},_bottom:null,set bottom(t){if("object"!=typeof t)throw new Error("setting top nt non object",t);for(var e=this._bottom,i=0;e;){if(i++,i>10){console.log("recursivity warning");break}e=e._bottom}this._bottom=t},get bottom(){return this._bottom},_top:null,set top(t){if("object"!=typeof t)throw new Error("setting top nt non object",t);for(var e=this._top,i=0;e;){if(i++,i>10){console.log("recursivity warning");break}if(e==this||e==t&&e!=this._top)return console.log("recursivity warning"),void(this._top=t);e=e._top}this._top=t},get top(){return this._top},breakSideJoints:function(){var t=this.dockPosition;this.bottom?(this.top&&this.top.setAll("bottom",this.bottom),this.bottom.setAll("top",this.top),this.bottom.setClearHeight(this.bottom.height+this.height),this.bottom.setClearY(this.y),this.bottom.setDockPosition(t)):this.top&&(this.top.setAll("bottom",this.bottom),this.top.setClearHeight(this.top.height+this.height)),this.setAll("top",null),this.setAll("bottom",null),this.setAll("left",null),this.setAll("right",null)},_isDocked:!1,set isDocked(t){if(void 0==t)throw new Error("docek");this.setAll("_isDocked",t)},get isDocked(){return this._isDocked},removeJoint:function(t){for(var e=null,i=0;i<this.joints.length;i++)if(e=this.joints[i],e==t)return void this.joints.splice(i,1)},vsBox:function(t){return!(this.x+this.width<t.x||this.y+this.height<t.y||this.x>t.x+t.width||this.y>t.y+t.height)},vsPoint:function(t){return!(this.x+this.width<t.x||this.y+this.height<t.y||this.x>t.x||this.y>t.y)},mouseDown:!1,saveBox:function(t){if(this.isDocked)return void console.warn("saving docked panel");if(this.savedBox.width=this.width,this.savedBox.height=this.height,!t)for(var e=0;e<this.joints.length;e++)this.joints[e].saveBox(!0)},loadBox:function(){this.savedBox.width&&(this.width=this.savedBox.width),this.savedBox.height&&(this.height=this.savedBox.height)},getVisibleJoint:function(){for(var t=0;t<this.joints.length;t++)if(this.joints[t].isVisible)return this.joints[t];return console.log("smth is broken"),this.show(this._parent,!1),this},hide:function(t,e){return this.isVisible?(this.isVisible=!1,MT.ui.DomElement.hide.call(this),void 0!=e?this:(this.emit(t!==!1?"hide":"unselect"),this)):this},close:function(){this.unjoin(),this.hide(),this.emit("close")},addHeader:function(){this.appendChild(this.header),this.header.show(this.el)},removeHeader:function(){this.header.hide(),this.content.y=0},addButton:function(t,e,i,s){var o=null;return o=t&&"object"==typeof t?t:new MT.ui.Button(t,e,this.events,i,s),this.content.addChild(o),this.buttons.push(o),o.show(),o},alignButtons:function(){for(var t=0,e=null,i=0;i<this.buttons.length;i++)e=this.buttons[i],e.x=t,t+=e.width},addButtonV:function(t,e,i){for(var s=new MT.ui.Button(t,e,this.events,i),o=0,a=0;a<this.content.children.length;a++)o+=this.content.children[a].el.offsetHeight;return s.y+=o,this.content.addChild(s),s},getJointNames:function(){for(var t=[],e=0;e<this.joints.length;e++)t.push(this.joints[e].name);return t}}),MT.namespace("ui"),function(){if("undefined"!=typeof Event){var t=Event.prototype.stopPropagation;Event.prototype.stopPropagation=function(){this.isPropagationStopped=!0,t.call(this)}}}(),MT(MT.ui.Events=function(){return window.MT.events?(console.warn("events already initialized"),window.MT.events):(window.MT.events=this,this.events={mousemove:[],mouseup:[],mousedown:[],drop:[],dragend:[],drag:[],dragover:[],click:[],resize:[],wheel:[]},this._cbs=[],this.enable(),void(this.mouse={x:0,y:0,mx:0,my:0,down:!1,lastEvent:{x:0,y:0},lastClick:{x:0,y:0}}))},{MOUSEMOVE:"mousemove",MOUSEUP:"mouseup",MOUSEDOWN:"mousedown",RESIZE:"resize",KEYDOWN:"keydown",KEYUP:"keyup",DROP:"drop",WHEEL:"wheel",DBLCLICK:"dblclick",enable:function(){for(var t in this.events)this.addEvent(t)},disable:function(){for(var t in this.events)document.body.removeEventListener(this._cbs[t].type,this._cbs[t])},on:function(t,e,i){this.events[t]||(console.warn("new Event:",t),this.events[t]=[],this.addEvent(t));var s=this;return window.setTimeout(function(){i?s.events[t].unshift(e):s.events[t].push(e)},0),e},once:function(t,e,i){var s,o=this;s=function(i){e(i),o.off(t,s)},this.on(t,s,i)},addEvent:function(t){var e=this._mk_cb(t);this._cbs.push(e),window.addEventListener(t,e,!1)},off:function(t,e){var i=null;if(void 0===e)for(var s in this.events){i=this.events[s];for(var o=0;o<i.length;o++)i[o]==e&&(i[o]=i[i.length-1],i.length=i.length-1)}else{i=this.events[t];for(var o=0;o<i.length;o++)i[o]==e&&(i[o]=i[i.length-1],i.length=i.length-1)}},simulateKey:function(t){this.emit(this.KEYDOWN,{which:t,target:document.body})},emit:function(t,e){this.events[t]||console.warn("unknown event",t);for(var i=this.events[t],s=0;s<i.length&&!(e instanceof Event&&e.isPropagationStopped);s++)i[s](e)},_mk_mousemove:function(){var t=this,e=function(e){e.x=e.x||e.pageX,e.y=e.y||e.pageY,t.mouse.mx=e.pageX-t.mouse.x,t.mouse.my=e.pageY-t.mouse.y,(0!=t.mouse.mx||0!=t.mouse.my)&&(t.mouse.x=e.pageX,t.mouse.y=e.pageY,t.mouse.lastEvent=e,t.emit(t.MOUSEMOVE,e))};return e.type=t.MOUSEMOVE,e},_mk_mousedown:function(){var t=this,e=function(e){e.x=e.x||e.pageX,e.y=e.y||e.pageY,t.mouse.down=!0,t.mouse.lastClick=e,t.emit(t.MOUSEDOWN,e)};return e.type=t.MOUSEDOWN,e},_mk_mouseup:function(){var t=this,e=function(e){e.x=e.x||e.pageX,e.y=e.y||e.pageY,t.mouse.down=!1,t.mouse.lastClick=e,t.emit(t.MOUSEUP,e)};return e.type=t.MOUSEUP,e},_mk_cb:function(t){if(t==this.MOUSEMOVE)return this._mk_mousemove();if(t==this.MOUSEUP)return this._mk_mouseup();if(t==this.MOUSEDOWN)return this._mk_mousedown();var e=this,i=function(i){i=i||event,(t.indexOf("drop")>-1||t.indexOf("drag")>-1)&&i.preventDefault(),i.ctrlKey&&i.altKey&&console.log(i,t),e.emit(t,i)};return i.type=t,i},_mk_drop:function(t){t.preventDefault()}}),MT.namespace("plugins"),MT.requireFile("MT/misc/validation.js"),MT.require("ui.InputCollection"),MT.extend("core.BasicPlugin").extend("core.Emitter")(MT.plugins.Auth=function(t){MT.core.BasicPlugin.call(this,"Auth"),this.project=t,this.sessionCookie="MightyEditor",this.currency="$"},{_isLogged:!1,set isLogged(t){this._isLogged=t},get isLogged(){return this._isLogged},initSocket:function(t,e){this.socket||(MT.core.BasicPlugin.initSocket.call(this,t),this.onstart=e,this.checkSession())},signOut:function(){MT.core.Helper.setCookie(this.sessionCookie,""),this.send("logout"),window.location=window.location.toString().split("#")[0]},a_login:function(t){this.showLogin(!0);var e=this;this.onlogin=function(){e.execCmd(t)}},execCmd:function(t){return console.log("exec",t),this.hideLoading(),this.hideLogin(),"function"==typeof t?void t():void(this[t.domain]&&this[t.domain][t.action].apply(this[t.domain],t.arguments))},a_permissionChanged:function(){console.log("project permissions has changed")},standAlone:!1,showLogin:function(t){if(t)return this.standAlone=!0,document.body.appendChild(this.loginContainer),MT.ui.addClass(this.loginContainer,"standAlone"),MT.ui.addClass(document.body,"login"),void this.showLogo();if(this.hideLogo(),MT.ui.removeClass(this.loginContainer,"standAlone"),MT.ui.removeClass(document.body,"login"),this.loginContainer.parentNode==document.body)return document.body.removeChild(this.loginContainer),this.mainButton&&this.mainButton.removeClass("active"),void MT.core.Helper.clearSelection();document.body.appendChild(this.loginContainer);var e=this;this.ui.events.once("click",function(){e.hideLogin()}),this.mainButton.addClass("active")},hideLogin:function(){this.loginContainer.parentNode&&(this.loginContainer.parentNode.removeChild(this.loginContainer),this.mainbutton&&this.mainButton.removeClass("active"),MT.core.Helper.clearSelection())},showLogo:function(){this.hideLogo(),this.loginContainer.firstChild.insertBefore(this.logo,this.loginContainer.firstChild.firstChild)},hideLogo:function(){this.logo.parentNode&&this.logo.parentNode.removeChild(this.logo)},showProperties:function(){if(console.log("show properties"),this.propContainer||this.buildPropContainer(),this.propContainer.parentNode==document.body)return document.body.removeChild(this.propContainer),this.mainButton.removeClass("active"),void MT.core.Helper.clearSelection();var t=this;this.mainButton.addClass("active");var e=this.mouseUp=function(i){i&&MT.ui.hasParent(i.target,t.propContainer)||(t.propContainer.parentNode&&(t.propContainer.parentNode.removeChild(t.propContainer),t.mainButton.removeClass("active"),MT.core.Helper.clearSelection(),t.emit("hideProperties",t.propPanels.projects)),t.ui.events.off("mouseup",e))};this.ui.events.on("mouseup",e),document.body.appendChild(this.propContainer),this.logoutButton.el.parentNode&&this.logoutButton.el.parentNode.removeChild(this.logoutButton.el),this.propContainer.appendChild(this.logoutButton.el),this.emit("showProperties",this.propPanels.projects)},initUI:function(t){this.ui=t;var e=this,i="My Mighty";this.isLogged||(i="Sign In"),this.mainButton=this.project.panel.addButton(i,"ui-login",function(){e.isLogged?e.showProperties():e.showLogin()})},buildPropContainer:function(){var t=this;this.propContainer=document.createElement("div"),this.propContainer.panel=this.panel,this.propContainer.onclick=function(t){t.stopPropagation()},this.propContainer.className="ui-mysettings",this.propPanels={},this.propPanels.share=this.ui.createPanel("Share Project"),this.propPanels.share.hide(),this.propPanels.share.fitIn(),this.buildShareOptions(this.propPanels.share.content.el),this.propPanels.projects=this.ui.createPanel("My Projects"),this.propPanels.projects.fitIn();var e=this.project.makeProjectList(this.projects,function(e,i){t.deleteProject(e,i)});this.propPanels.projects.content.el.appendChild(e),this.propPanels.share.addJoint(this.propPanels.projects),this.propPanels.share.show(this.propContainer)},buildShareOptions:function(t){var e=this;this.send("getShareOptions",null,function(i){return console.log("share options",i),void 0==i?void e.buildCopyToAccessPermissions(t):(e.userId=i.userId,i?"goPro"==i.action?void e.buildGoPro(t):"pending"==i.action?void e.buildPending(t):(e.shareOptions=i,e.buildShareEmailOptions(t,e.shareOptions.emails),e.buildAllowCopy(t),void e.buildProjectLink(t)):void console.log("cannot get options",i))})},buildProjectLink:function(t){var e=document.createElement("fieldset"),i=document.createElement("legend");i.innerHTML="Share by link",e.appendChild(i);var s=document.createElement("span");s.appendChild(document.createTextNode(window.location)),s.className="selectable",s.onclick=function(t){MT.core.Helper.select(s),t.stopPropagation()};var o=document.createElement("div");o.className="help-text",o.appendChild(document.createTextNode("This option grants access to the project for everyone with the link")),e.appendChild(o);var a=document.createElement("input");a.setAttribute("type","checkbox"),a.className="project-link",e.appendChild(a),this.shareOptions.shareWithLink&&(a.setAttribute("checked","checked"),e.appendChild(s));var n=this;a.onchange=function(){console.log(this,this.checked),this.checked?(e.appendChild(s),MT.core.Helper.select(s)):s.parentNode&&e.removeChild(s),n.shareOptions.shareWithLink=this.checked?1:0,n.saveProjectShareOptions()},t.appendChild(e)},buildAllowCopy:function(t){var e=document.createElement("fieldset"),i=document.createElement("legend");i.innerHTML="Allow copy",e.appendChild(i);var s=document.createElement("span");s.appendChild(document.createTextNode(window.location.toString()+"-copy")),s.className="selectable",s.onclick=function(t){MT.core.Helper.select(s),t.stopPropagation()};var o=document.createElement("div");o.className="help-text",o.appendChild(document.createTextNode("This option allows to make a copy of your project without affecting your project. e.g. if you are creating tutorial")),e.appendChild(o);var a=document.createElement("input");a.setAttribute("type","checkbox"),a.className="project-link",e.appendChild(a),this.shareOptions.allowCopy&&(a.setAttribute("checked","checked"),e.appendChild(s));var n=this;a.onchange=function(){console.log(this,this.checked),this.checked?(e.appendChild(s),MT.core.Helper.select(s)):s.parentNode&&e.removeChild(s),n.shareOptions.allowCopy=this.checked?1:0,n.saveProjectShareOptions()},t.appendChild(e)},buildShareEmailOptions:function(t,e){var i=document.createElement("fieldset");i.onclick=function(t){t.preventDefault(),t.stopPropagation(),n.focus()};var s=document.createElement("legend");s.innerHTML="Share by email",i.appendChild(s);var o=document.createElement("div");o.className="help-text",o.appendChild(document.createTextNode("Enter list of email addresses - to allow access to your project")),i.appendChild(o);var a=document.createElement("span");this.buildEmailList(a,e),i.appendChild(a);var n=document.createElement("input");n.className="share-email-input",n.onmousedown=function(t){t.stopPropagation()};var h=this;n.onkeydown=function(t){if(t.which==MT.keys.ENTER||t.which==MT.keys.TAB){if(!n.value)return;h.addEmail(a,n.value),n.value="",t.preventDefault()}else t.which==MT.keys.ESC&&(n.value="")},i.appendChild(n),t.appendChild(i)},addEmail:function(t,e){this.shareOptions.emails.indexOf(e)>-1||(t.appendChild(this.buildEmail(e)),this.shareOptions.emails.push(e),this.saveProjectShareOptions())},removeEmail:function(t,e){t.parentNode&&t.parentNode.removeChild(t);var i=this.shareOptions.emails.indexOf(e);this.shareOptions.emails.splice(i,1),this.saveProjectShareOptions()},saveProjectShareOptions:function(){this.send("saveProjectShareOptions",this.shareOptions)},buildEmailList:function(t,e){for(;t.firstChild;)t.removeChild(t.firstChild);for(var i=0;i<e.length;i++)t.appendChild(this.buildEmail(e[i]))},buildEmail:function(t){var e=document.createElement("span"),i=document.createElement("span"),s=document.createElement("span"),o=this;e.appendChild(i),e.appendChild(s),e.className="email-entered",s.className="remove-button fa",i.appendChild(document.createTextNode(t)),s.innerHTML="&#xf00d;",s.onclick=function(){o.removeEmail(e,t)};var a=MT.misc.validation;return a.email(t)||(e.className+=" error"),e},buildPending:function(t){var e=document.createElement("div");e.className="goPro";var i=document.createElement("div");i.className="top";var s=document.createElement("div");s.className="title",s.appendChild(document.createTextNode("Pending approval"));var o=document.createElement("div");o.className="description",o.appendChild(document.createTextNode("We haven't received payment approval from paypal. Please wait.")),i.appendChild(s),i.appendChild(o),e.appendChild(i),t.appendChild(e)},buildCopyToAccessPermissions:function(t){var e=document.createElement("div");e.className="goPro";var i=document.createElement("div");i.className="top";var s=document.createElement("div");s.className="title",s.appendChild(document.createTextNode("This is not your project"));var o=document.createElement("div");o.className="description",o.innerHTML='This project belongs to another user - or has been created by an annonymous user. You can <a href="'+window.location.origin+"/#"+this.project.id+'-copy" />clone</a> this project to make your own copy of this project.',i.appendChild(s),i.appendChild(o),e.appendChild(i),t.appendChild(e)},buildGoPro:function(t){var e=document.createElement("div");e.className="goPro";var i=document.createElement("div");i.className="top";var s=document.createElement("div");s.className="title",s.appendChild(document.createTextNode("Get pro account"));var o=document.createElement("div");o.className="description",o.appendChild(document.createTextNode("To share projects privately and to change other project properties you should get a subscription. If you choose to subscribe you will get all kinds of awesome goodies."));var a=document.createElement("div");a.className="middle";var n=this.buildSide("Basic",["Game Hosting","Advanced Sharing","Never Expiring Projects"],5,"basic"),h=this.buildSide("Advanced",["All of the Basic","Support","Feature Request Priority"],20,"advanced");i.appendChild(s),i.appendChild(o),a.appendChild(n),a.appendChild(h),e.appendChild(i),e.appendChild(a),t.appendChild(e)},buildSide:function(t,e,i,s){var o=document.createElement("div");o.className="side "+s;var a=document.createElement("div");a.className="label",a.appendChild(document.createTextNode(t)),o.appendChild(a);for(var n,h=0;h<e.length;h++)n=document.createElement("div"),n.appendChild(document.createTextNode(e[h])),o.appendChild(n);var r=document.createElement("div");r.className="price",r.appendChild(document.createTextNode(i+this.currency)),o.appendChild(r);var l=document.createElement("div");return l.className="subscribe "+s,l.innerHTML=5==i?'<form action="https://www.paypal.com/cgi-bin/webscr" method="post" target="_top"><input type="hidden" name="cmd" value="_s-xclick"><input type="hidden" name="hosted_button_id" value="Y4PZXZMZFA8NQ"><input type="hidden" name="custom" value="'+this.userId+'"><input type="hidden" name="notify_url" value="'+document.location.origin+'/paypal"><input type="hidden" name="return" value="'+document.location.origin+"/return/paypal/"+this.userId+"/"+this.project.id+'"><input type="hidden" name="invoice_id" value="'+Date.now()+'"><input type="hidden" name="charset" value="utf-8"><input type="image" src="http://mightyfingers.com/wp-content/uploads/2014/12/button_paypal.png" border="0" name="submit" alt="PayPal - The safer, easier way to pay online!"></form>':'<form action="https://www.paypal.com/cgi-bin/webscr" method="post" target="_top"><input type="hidden" name="cmd" value="_s-xclick"><input type="hidden" name="hosted_button_id" value="Y433GXUFDCNNE"><input type="hidden" name="custom" value="'+this.userId+'"><input type="hidden" name="notify_url" value="'+document.location.origin+'/paypal"><input type="hidden" name="return" value="'+document.location.origin+"/return/paypal/"+this.userId+"/"+this.project.id+'"><input type="hidden" name="invoice_id" value="'+Date.now()+'"><input type="hidden" name="charset" value="utf-8"><input type="image" src="http://mightyfingers.com/wp-content/uploads/2014/12/button_paypal_2.png" border="0" name="submit" alt="PayPal - The safer, easier way to pay online!"></form>',o.appendChild(l),o},deleteProject:function(t,e){var i=this,s=new MT.ui.Popup("Delete Project?","Do you really want to delete project?");s.addButton("no",function(){s.hide(),e(!1)}),s.addButton("yes",function(){i.send("deleteProject",t),s.hide(),e(!0)}),s.showClose()},installUI:function(t){if(!this.panel){this.ui=t,this.loginContainer=document.createElement("div"),this.logo=document.createElement("div"),this.logo.className="login logo",this.loginContainer.onclick=function(t){t.stopPropagation()},this.loginContainer.className="ui-mysettings";var e=this,i=this.panel=this.ui.createPanel("Sign in");this.loginContainer.panel=this.panel,i.fitIn(),i.removeBorder(),i.hide(),i.content.style.overflow="hidden",i.content.style.perspective="1000",this.signUpEl=new MT.ui.DomElement("div"),this.signUpEl.addClass("signup"),i.content.el.appendChild(this.loginContainer),this.loginContainer.appendChild(this.signUpEl.el);var s=document.createElement("form");s.onsubmit=function(t){return t.preventDefault(),t.stopPropagation(),!1};var o={email:"email",password:"password",passwordR:"password"};this.signUpEl.el.appendChild(s);var a={};a.email=new MT.ui.Input(this.ui,{key:"email",type:"text"},o),a.email.show(s),a.email.input.id="email",a.email.input.name="email",a.password=new MT.ui.Input(this.ui,{key:"password",type:"password"},o),a.password.show(s),a.password.value.el.innerHTML="Password",a.passwordR=new MT.ui.Input(this.ui,{key:"passwordR",type:"password"},o),a.passwordR.value.el.innerHTML="Repeat Password",i.on("show",function(){a.email.enableInput()});var n=!1,h=!1,r=function(){return h?void e.resetPassword(a):void e.signIn(a,n)};this.loginButton=new MT.ui.Button("Sign in","login.mainbutton",null,r),this.loginButton.show(s),a.password.input.onkeydown=a.passwordR.input.onkeydown=function(t){t.which==MT.keys.ENTER&&r()};this.flipBack=function(t,i){e.signUpEl.removeClass("flipBack").addClass("flip"),window.setTimeout(function(){e.signUpEl.removeClass("flip").addClass("flipBack"),(!i||h)&&(h?(e.loginButton.text="Sign in",e.registerButton.text="Need an account?",a.email.el.parentNode.insertBefore(a.password.el,a.email.el.nextSibling),h=!1,n=!1):n?(a.passwordR.hide(),e.registerButton.text="Need an account?",e.loginButton.text="Sign in",n=!1):(a.password.el.parentNode.insertBefore(a.passwordR.el,a.password.el.nextSibling),e.registerButton.text="Back",e.loginButton.text="Register",n=!0),window.setTimeout(function(){e.signUpEl.removeClass("flipBack")},500))},250),a.email.value.removeClass("error"),a.password.value.removeClass("error")},this.registerButton=new MT.ui.Button("Need an account?","register",null,this.flipBack),this.registerButton.show(s),this.forgotPassButton=new MT.ui.Button("Forgot password?","resetPassword",null,function(){e.signUpEl.removeClass("flipBack").addClass("flip"),window.setTimeout(function(){e.signUpEl.removeClass("flip").addClass("flipBack"),h?(a.email.el.parentNode.insertBefore(a.password.el,a.email.el.nextSibling),e.loginButton.text="Sign in",h=!1):(a.password.hide(),a.passwordR.hide(),e.registerButton.text="Back",e.loginButton.text="Reset",h=!0),window.setTimeout(function(){e.signUpEl.removeClass("flipBack")},500)},250),a.email.value.removeClass("error"),a.password.value.removeClass("error")}),this.forgotPassButton.show(s),this.logoutButton=new MT.ui.Button("Sign out","login.mainbutton.logout",null,function(){e.signOut(a)}),this.errorMessage=document.createElement("div"),this.errorMessage.className="errorMessage",this.signUpEl.el.appendChild(this.errorMessage),this.social=new MT.ui.DomElement("div"),this.social.addClass("social");var e=this;this.send("getSocialConfig",null,function(t){e.config=t;for(var i in t)e[i+"Button"]=e.addSocialButton(t[i],e.social.el)}),this.fPass=ForgotPassword(this.signUpEl.el),this.loginContainer.appendChild(this.social.el)}},setError:function(t){this.errorMessage&&this.error(t)},addSocialButton:function(t,e){var i=this.buildUrl(t),s=this,o=new MT.ui.Button(t.label,"login."+t.name,null,function(){var e=t,o=e.width,a=e.height,n=.5*(window.innerWidth-o),h=.5*(window.innerHeight-a);window.auth=function(t){s.send("checkSession",t),window.auth=null,s.showLoading()};var r=window.open(i,"signIn","width="+o+", height="+a+", left="+n+", top="+h);r.focus()});return e.appendChild(o.el),o},buildUrl:function(t){var e=t.url+"?";for(var i in t.params)e+=i+"="+t.params[i]+"&";return e=e.substring(0,e.length-1)},hideContainer:function(){this.loginContainer&&this.loginContainer.parentNode&&this.loginContainer.parentNode.removeChild(this.loginContainer)},showLoading:function(){window.showLoading()},hideLoading:function(){window.hideLoading()},show:function(t,e){t.addJoint(this.panel),e&&loginPanel.show()},showMainScreen:function(){this.loginContainer.parentNode||(this.standAlone?document.body.appendChild(this.loginContainer):this.panel.content.el.appendChild(this.loginContainer))},error:function(t){var e=this.errorMessage.parentNode;this.errorMessage.setAttribute("data-msg",t),this.errorMessage.className="errorMessage",e.removeChild(this.errorMessage),e.appendChild(this.errorMessage);var i=this;window.setTimeout(function(){i.errorMessage.className+=" active"},1e3)},signIn:function(t,e){var i=t.email.getValue(),s=t.password.getValue(),o=t.passwordR.getValue();t.email.value.removeClass("error"),t.password.value.removeClass("error");var a=MT.misc.validation,n=!1;if(a.email(i)||(t.email.value.addClass("error"),t.email.value.el.setAttribute("data-error","check email"),n=!0,t.email.validateFirstTime||(t.email.validateFirstTime=!0,t.email.on("change",function(e){a.email(e)?t.email.value.removeClass("error"):t.email.value.addClass("error")
}))),a.password(s)||(t.password.value.addClass("error"),t.password.value.el.setAttribute("data-error","at least one number and at least six characters"),n=!0,t.password.validateFirstTime||(t.password.validateFirstTime=!0,t.password.on("change",function(e){a.password(e)?t.password.value.removeClass("error"):t.password.value.addClass("error")}))),e&&s!==o&&(t.passwordR.value.addClass("error"),t.passwordR.value.el.setAttribute("data-error","passwords don't match"),n=!0),!n){this.errorMessage.className="errorMessage",this.showLoading(),s=MT.core.Helper.sha256(s);var h=this;this.send("register",{email:i,password:s,signup:e},function(t){h.hideLoading(),t||(h.showMainScreen(),h.error("Sign in failed!")),console.log(t?"register success":"register failed")})}},resetPassword:function(t){var e=this,i=t.email.getValue(),s=MT.misc.validation;return s.email(i)?void this.send("resetPassword",i,function(t){e.hideLoading(),t?(e.showMainScreen(),e.error("Unknown email address")):(e.error("Instructions has sent to the provided email!"),window.setTimeout(function(){e.flipBack(null,!0)},2e3))}):(t.email.value.addClass("error"),t.email.value.el.setAttribute("data-error","check email"),void(t.email.validateFirstTime||(t.email.validateFirstTime=!0,t.email.on("change",function(e){s.email(e)?t.email.value.removeClass("error"):t.email.value.addClass("error")}))))},checkSession:function(){var t=MT.core.Helper.getCookie(this.sessionCookie);return t?void this.send("checkSession",t):(this.onstart&&(this.onstart(),this.onstart=null),void this.send("checkSession",t))},a_sessionId:function(t){console.log("received session ID",t),MT.core.Helper.setCookie(this.sessionCookie,t),this.onlogin&&(this.onlogin(),this.onlogin=null)},a_needLogin:function(t){this.isLogged&&this.project.a_goToHome(),this.onstart?(this.onstart(),this.onstart=null):(this.showLogin(!0),t&&this.setError(t))},a_loggedIn:function(t){var e=this.projects=t.projects;if(this.userLevel=t.level,this.userId=t.userId,this.isLogged=!0,!this.project.isReady)return this.onstart&&(this.onstart(),this.onstart=null),void(this.standAlone=!1);if(console.log("LoggedIn: projects",e),this.onstart&&(this.onstart(),this.onstart=null),this.panel){if(this.hideLoading(),this.hideContainer(),this.panel.title="My Projects",this.panel.show(),e&&e.length>0){var i=this,s=this.project.makeProjectList(e,function(t,e){i.deleteProject(t,e)});s.className+=" myprojects",this.panel.content.el.appendChild(s),this.project.id||this.panel.show()}this.isLogged&&0==this.userLevel&&(this.subscribe=this.ui.createPanel("Go Pro"),this.subscribe.mainTab.addClass("goprotab"),this.subscribe.mainTab,this.subscribe.hide(),this.subscribe.fitIn(),this.subscribe.removeBorder(),this.panel.addJoint(this.subscribe),this.subscribe.show(),this.buildGoPro(this.subscribe.content.el)),this.panel.content.el.appendChild(this.logoutButton.el)}}});var ForgotPassword=function(){};ForgotPassword.prototype={},MT.namespace("plugins"),MT.require("plugins.MapEditor"),MT.require("ui.Keyframes"),MT.require("ui.MovieLayer"),MT.require("ui.FrameControl"),MT.FRAME_SELECTED="FRAME_SELECTED",MT.extend("core.Emitter")(MT.plugins.MovieMaker=function(t){this.project=t,MT.core.BasicPlugin.call(this,"movie"),this.activeFrame=0,this.startFrame=0,this.scale=1,this.keys=["x","y","angle","anchorX","anchorY","scaleX","scaleY","alpha","frame","assetId"],this.roundKeys=[],this.inputs={}},{_frameSize:5,get frameSize(){return this._frameSize*this.scale},initUI:function(t){this.ui=t,this.panel=this.ui.createPanel("timeline"),this.panel.addClass("timeline"),this.panel.setFree(),this.panel.content.el.style.overflow="hidden",this.el=this.panel.content;var e=this;this.panel.addOptions([{label:"Add movie",className:"",cb:function(){e.addMovie(),e.panel.options.list.hide()}}]),this.panel.options.list.width=150,this.panel.options.list.style.left="auto",this.panel.on("show",function(){e.hide(),e.setActive(e.data)}),this.settings=this.ui.createPanel("Easing"),this.settings.setFree(),this.location=new MT.ui.DomElement("div"),this.location.addClass("ui-movie-location"),this.location.el.innerHTML=""},genEasings:function(t,e,i){i=i||[];var s=e;for(var o in t)""!=e&&(s=e+"."),"object"!=typeof t[o]?i.push({label:s+o,value:s+o}):this.genEasings(t[o],s+o,i);return i},addInput:function(t,e,i){var s=this.settings.content.el;if(this.inputs[t])return this.inputs[t].setObject(e.easings),void s.appendChild(this.inputs[t].el);var o=new MT.ui.Input(this.ui,{key:t,options:i,type:"select"},e.easings);this.inputs[t]=o,s.appendChild(o.el)},showFrameSettings:function(t){t.easings||(t.easings={});var e=this.genEasings(Phaser.Easing,"",[{label:"NONE",value:"none"}]);for(var i in t)"easings"!=i&&this.addInput(i,t,e)},hideFrameSettings:function(){for(var t=this.settings.content.el;t.firstChild;)t.removeChild(t.firstChild)},installUI:function(){var t=this,e=this.ui.events;this.layers=[],this.tools=this.project.plugins.tools,this.om=this.project.plugins.objectmanager,this.map=this.project.plugins.mapeditor,this.tools.on(MT.OBJECT_SELECTED,function(e){t.selectObject(e.data)}),this.tools.on(MT.OBJECT_UNSELECTED,function(e){t.items&&t.items[e.id]&&(t.newMovieButton||(t.show(e),t.keyframes.unselect(e.id)))}),this.tools.on(MT.OBJECTS_UPDATED,function(){t.saveActiveFrame(),t.data||t.createMainMovie()}),this.om.on(MT.OBJECT_UPDATED,function(e){e.data.autoframe&&t.addFrame()}),e.on(e.KEYDOWN,function(e){return e.which==MT.keys.ESC?(t.clear(),void t.createMainMovie()):void 0}),e.on(e.WHEEL,function(e){if(e.target!==t.frameControl.sepHolder){for(var i=!1,s=e.target.parentNode;s;){if(s==t.panel.el){i=!0;break}s=s.parentNode}if(!i)return;return void(e.wheelDelta>0?t.keyframes.tv.tree.el.scrollTop-=30:t.keyframes.tv.tree.el.scrollTop+=30)}e.wheelDelta>0?t.scale+=.1:t.scale-=.1,t.scale<.01&&(t.scale=.01),t.changeFrame()}),this.addPanels(),this.slider=new MT.ui.DomElement("div"),this.slider.addClass("ui-movie-slider"),this.slider.setAbsolute(),this.movieLength=new MT.ui.DomElement("div"),this.movieLength.addClass("ui-movie-slider ui-movie-length"),this.movieLength.setAbsolute(),this.movieLengthTip=new MT.ui.DomElement("div"),this.movieLengthTip.addClass("ui-movie-slider ui-movie-length tip"),this.movieLengthTip.setAbsolute();var i=!1;this.movieLengthTip.el.onmousedown=function(e){i=!0,t.tipH.reset(t.movieLength.x),e.preventDefault(),e.stopPropagation()},this.tipH=new MT.ui.SliderHelper(0,0,1/0),e.on("mousemove",function(){if(i){t.tipH.change(e.mouse.mx);var s=t.keyframes.getMovie().info;s.lastFrame=Math.floor(t.calcFrame(t.tipH)),s.lastFrame<0&&(s.lastFrame=0),t.changeFrame(),t.map.sync()}}),e.on("mouseup",function(){i=!1}),this.sidebar=new MT.ui.DomElement("div"),this.sidebar.addClass("ui-movie-sidebar"),this.sidebar.setAbsolute(),this.frameControl=new MT.ui.FrameControl(this),this.frameControl.on("change",function(e){t.startFrame=Math.floor(e/t.frameSize),t.changeFrame()}),this.buttons={saveKeyFrame:new MT.ui.Button("","ui-movie-saveKeyFrame",null,function(e){t.addFrame(!0),e.preventDefault(),e.stopPropagation()})},this.buttons.saveKeyFrame.show(this.sidebar.el),this.keyframes=this.keyframesSub=new MT.ui.Keyframes(this,60),this.keyframesSub.on("select",function(e){t.forwardObjectSelect(e)}),this.keyframesMain=new MT.ui.MovieLayer(this,60),this.keyframesMain.on("select",function(e){t.forwardObjectSelect(e)}),this.clear(),this.om=this.project.plugins.objectmanager,this.map.on("update",function(){t.keyframes==t.keyframesMain&&t.createMainMovie()}),this.ui.on(e.RESIZE,function(){t.redrawAll()})},ignoreSelect:!1,forwardObjectSelect:function(t){if(t.objectId)return this.selectObject(t),this.ignoreSelect=!0,this.om.emit(MT.OBJECT_SELECTED,this.map.getById(t.objectId)),void(this.ignoreSelect=!1);var e=t.id;if(e){var i=this.om.getById(e);i&&this.om.emit(MT.OBJECT_SELECTED,i)}},redrawAll:function(){this.hasMovies()&&(this.keyframes.updateFrames(),this.frameControl.build())},show:function(t){this.keyframes.show(),t&&this.keyframes.setActiveObject(t.id),this.showHelpers(),this.keyframes.showFrames()},hide:function(){this.keyframesMain.hide(),this.keyframesSub.hide(),this.Keyframes=this.keyframesSub,this.hideHelpers(),this.newMovieButton&&this.newMovieButton.hide()},showHelpers:function(){this.slider.show(this.rightPanel.content.el),this.movieLength.show(this.rightPanel.content.el),this.movieLengthTip.show(this.rightPanel.content.el),this.sidebar.show(this.rightPanel.content.el),this.sidebar.width=this.frameOffset,this.frameControl.build(),this.frameControl.el.show(this.rightPanel.content.el),this.panel.content.el.appendChild(this.location.el)},hideHelpers:function(){this.keyframes.hide(),this.slider.hide(),this.movieLength.hide(),this.movieLengthTip.hide(),this.frameControl.hide(),this.sidebar.hide(),this.location.hide()},clear:function(){this.keyframes=this.keyframesSub,this.keyframes.tv.merge([]),this.items={},this.hide()},addPanels:function(){this.panel.content.style.paddingTop="19px",this.leftPanel=this.ui.createPanel("me-layers"),this.rightPanel=this.ui.createPanel("me-frames"),this.leftPanel.addClass("borderless"),this.leftPanel.hide().show(this.el.el),this.leftPanel.fitIn(),this.leftPanel.width=270,this.leftPanel.style.setProperty("border-right","none 1px #000"),this.leftPanel.isResizeable=!0,this.leftPanel.removeHeader(),this.leftPanel.removeClass("animated"),this.rightPanel.addClass("borderless"),this.rightPanel.hide().show(this.el.el),this.rightPanel.fitIn(),this.rightPanel.style.left="270px",this.rightPanel.style.top="19px",this.rightPanel.style.width="auto",this.rightPanel.removeHeader(),this.rightPanel.removeClass("animated"),this.leftPanel.el.style.position="relative",this.leftPanel.content.el.style.position="relative",this.leftPanel.content.el.style["min-height"]="100%",this.leftPanel.content.style.overflow="visible",this.rightPanel.content.style.overflow="visible";var t,e=null,i=!1,s=0;this.rightPanel._input.onkeyup=function(t){t.which==MT.keys.DELETE&&(o.removeFrame(e),t.preventDefault(),t.stopPropagation()),t.which==MT.keys.SPACE&&(o.addFrame(),t.preventDefault(),t.stopPropagation()),t.which==MT.keys.RIGHT&&(o.changeFrame(o.activeFrame+1),t.preventDefault(),t.stopPropagation()),t.which==MT.keys.LEFT&&(o.changeFrame(o.activeFrame-1),t.preventDefault(),t.stopPropagation()),t.ctrlKey&&(t.which==MT.keys.C&&o.copyFrame(e),t.which==MT.keys.X&&o.cutFrame(e),t.which==MT.keys.V&&o.pasteFrame())},this.ui.events.on(this.ui.events.KEYUP,function(t){t.ctrlKey&&t.which==MT.keys.SPACE&&(o.addFrame(),t.preventDefault(),t.stopPropagation())});var o=this,a=this.sliderHelper=new MT.ui.SliderHelper(0,0,1/0),n=o.leftPanel.width;this.leftPanel.on("resize",function(t){return n>t?void(o.leftPanel.width=n):void(o.rightPanel.style.left=t+"px")}),this.selectedFrame=null;var h;this.rightPanel.content.el.onmousedown=function(n){if(n.target.autoframe)return n.target.autoframe.autoframe=!n.target.autoframe.autoframe,void(n.target.autoframe.autoframe?n.target.ctrl.addClass("active"):n.target.ctrl.removeClass("active"));n.target.frameInfo?(t=n.target.parentNode,e=n.target.frameInfo,s=1,o.selectedFrame=e.frames[e.index],o.showFrameSettings(o.selectedFrame)):(s=0,e=null,t=n.target,o.selectedFrame=null,o.hideFrameSettings()),t.data&&o.forwardObjectSelect(t.data);var r=n.offsetX;n.target!=o.rightPanel.content.el&&(r+=n.target.offsetLeft),a.reset(r);var l=o.calcFrame(a);l>-1&&(i=!0,o.changeFrame(l)),h=o.activeFrame,o.redrawAll()},this.rightPanel.content.el.onmouseup=function(){i=!1},this.ui.events.on("mousemove",function(){i&&(a.change(o.ui.events.mouse.mx),o.changeFrame((a-o.frameOffset)/o.frameSize+o.startFrame),1==s&&e&&(console.log(o.activeFrame,h),o.moveFrame(o.selectedFrame,e,o.selectedFrame.keyframe-(h-o.activeFrame))&&(h=o.activeFrame)))}),this.ui.events.on("mouseup",function(){i=!1})},showNewMovie:function(){this.hide(),this.newMovieButton=new MT.ui.DomElement("div"),this.newMovieButton.addClass("ui-new-movie-wrapper");var t=this;this.newMovieButton.button=new MT.ui.Button("New Movie","ui-new-movie style2",null,function(){t.addMovie()}),this.newMovieButton.button.show(this.newMovieButton.el),this.newMovieButton.show(this.panel.content.el)},selectObject:function(t){if(!this.ignoreSelect){if(this.items&&this.items[t.id])return void(this.hasMovies()?this.show(t):(this.hide(),this.showNewMovie()));this.hide(),this.keyframes=this.keyframesSub,this.setActive(t),this.location.el.innerHTML=t.name;var e=this.keyframes.panels[this.keyframes.activeMovie];e&&(e.x=this.location.width)}},addMovie:function(t,e){if(t&&e)return void this.__addMovie(t,e);if(this.data){for(var e="NewMovie",i=e,s=1;this.data.movies[e];)e=i+s,s++;this._addMovie(e),this.om.sync()}},_addMovie:function(t,e){for(var i in this.items)e=this.items[i],this.__addMovie(e,t);this.keyframes=this.keyframesSub,this.setActive(this.data),this.showHelpers()},__addMovie:function(t,e){t.movies||(t.movies={}),t.movies[e]||(t.movies[e]={frames:[],info:{fps:60}})},items:null,setActive:function(t){return this.newMovieButton&&this.newMovieButton.hide(),this.items={},this.data=t,this.data?(this.data.movies||(this.data.movies={}),this.hasMovies()?(this.collectItems(),this.keyframes.setData(this.data),this.show(this.data),void this.changeFrame(this.activeFrame?this.activeFrame:0)):(this.hide(),this.showNewMovie(),void this.collectItems())):(this.keyframes.setData(null),void this.hideHelpers())},hasMovies:function(){if(!this.data)return!1;var t=Object.keys(this.data.movies).length;return!(0==t&&1!=this.state||1==t&&void 0!=this.data.movies[this.mainName]&&this.keyframes!=this.keyframesMain)},collectItems:function(){this._collectItems(this.data)},_collectItems:function(t){if(this.items[t.id]=t,t.contents)for(var e=0;e<t.contents.length;e++)this._collectItems(t.contents[e])},frameOffset:40,calcFrame:function(t){var e=(t-this.frameOffset)/this.frameSize+this.startFrame;return e},calcFrameLoc:function(t){return t*this.frameSize+.5*(this.frameSize-this.slider.width)+this.frameOffset-this.startFrame*this.frameSize},changeFrame:function(t){void 0==t&&(t=this.activeFrame);var e=(this.sliderHelper,Math.floor(t));0>e&&(e=0);var i=this.calcFrameLoc(e);this.slider.style.visibility=i<this.frameOffset?"hidden":"visible",this.slider.x=i;var s=this.keyframes.getMovie();s&&(i=this.calcFrameLoc(s.info.lastFrame),i<this.frameOffset?(this.movieLength.style.visibility="hidden",this.movieLengthTip.style.visibility="hidden"):(this.movieLength.style.visibility="visible",this.movieLengthTip.style.visibility="visible"),void 0==s.info.lastFrame&&(s.info.lastFrame=60),this.movieLength.x=this.calcFrameLoc(s.info.lastFrame),this.movieLengthTip.x=this.movieLength.x,this.keyframes.changeFrame(e),this.activeFrame=e,this.redrawAll())},addFrame:function(t){this.keyframes.saveActiveFrame(null,t)},moveFrame:function(t,e,i){if(void 0==i?i=this.activeFrame:(i=Math.round(i),0>i&&(i=0)),t.keyframe==i)return!1;var s;if(t.length)for(var o=0;o<e.frames.length;o++)if(s=e.frames[o],s!=t&&s.keyframe<i&&s.keyframe+s.length>i)return;return t.keyframe=i,this.sortFrames(e.frames),this.changeFrame(),!0},frameBuffer:null,framesToCopy:null,cutFrame:function(t){t?(this.copyFrame(t),t.frames.splice(t.index,1),this.framesToCopy=null):this.collectFramesToCopy(!0),this.changeFrame()},copyFrame:function(t){t?(this.frameBuffer=t,this.framesToCopy=null):this.collectFramesToCopy()},collectFramesToCopy:function(t){this.framesToCopy=[];var e,i;for(var s in this.items){i=this.items[s].movies[this.keyframes.activeMovie],e=i.frames;for(var o=0;o<e.length;o++)e[o].keyframe==this.activeFrame&&(this.framesToCopy.push({frame:e[o],data:i}),t&&(e.splice(o,1),o--))}},pasteFrame:function(){var t,e;if(this.framesToCopy){for(var i=0;i<this.framesToCopy.length;i++)e=this.framesToCopy[i],t=JSON.parse(JSON.stringify(e.frame)),t.keyframe=this.activeFrame,e.data.frames.push(t),this.sortFrames(e.data.frames);return void this.changeFrame()}if(this.frameBuffer){var s=this.frameBuffer.frames;t=JSON.parse(JSON.stringify(s[this.frameBuffer.index])),t.keyframe=this.activeFrame,s.push(t),this.sortFrames(s),this.changeFrame()}},sortFrames:function(t){t.sort(function(t,e){return t.keyframe-e.keyframe})},removeFrame:function(t){t&&(t.frames.splice(t.index,1),this.changeFrame(),this.om.sync())},saveActiveFrame:function(){this.keyframes.saveActiveFrame(!0)},buildKeyFrames:function(){},getById:function(t){var e=this.project.plugins.mapeditor.getById(t);return e?e.data:void 0},collect:function(t,e,i){var s,o,a=t.id;s=this.map.getById(t.objectId?t.objectId:a);var n=i||{};if(!s)return n;o=s.data;for(var h,r=0;r<this.keys.length;r++)h=this.keys[r],void 0!=o[h]&&(n[h]=o[h]);return n.keyframe=e,n},updateScene:function(){var t=this.data.kf[this.activeFrame];t?this.updateObjects(t):this.interpolate()},loadState:function(t,e,i){i=i||0;var s=this.project.plugins.mapeditor.getById(t);s&&s.update(e)},interpolate:function(t,e,i,s){var o=(s-e.keyframe)/(i.keyframe-e.keyframe),a=this.project.plugins.mapeditor.getById(t);if(a){var n=this.buildTmpVals(o,e,i);a.update(n)}},buildTmpVals:function(t,e,i){if(!i)return e;for(var s,o={},a=0;a<this.keys.length;a++)s=this.keys[a],o[s]="frame"!=s&&"assetId"!=s?this.getInt(t,e[s],i[s],i.easings?i.easings[s]:null):e[s];for(var a=0;a<this.roundKeys.length;a++)s=this.roundKeys[a],o[s]=Math.floor(this.getInt(t,e[s],i[s]));return o},getInt:function(t,e,i,s){if(isNaN(e))return i;if(isNaN(i))return e;var o=t;return s&&(o=this.resolve(s,t)),(1-o)*e+o*i},resolve:function(t,e){if("NONE"==t)return 0;for(var i=t.split("."),s=Phaser.Easing,o=0;o<i.length&&s;o++)s=s[i[o]];return s?s(e):e},mainMovie:null,mainName:"__main",createMainMovie:function(){this.keyframes.hide(),this.keyframes=this.keyframesMain,this.location.el.innerHTML="Main Timeline",this.mainMovie={name:this.mainName,id:0,contents:[],movies:{}};var t=this.map.settings.movieInfo;this.mainMovie.movies[this.mainName]={frames:[],info:t};var e=this.om.getData();this.collectMovies(e,this.mainMovie.contents,0),this.setActive(this.mainMovie)},collectMovies:function(t,e,i){for(var s,o,a,n,h=this.mainName,r=0;r<t.length;r++){t[r].movies||(t[r].movies={}),s=t[r].movies,s[h]||this.__addMovie(t[r],h),o={},o.id=++i,o.objectId=t[r].id,o.movies=t[r].movies,o.name=t[r].name,o.isClosed=!0;var l=o.movies[h];l.subdata||(l.subdata=[]),a=l.subdata,o.contents=a;t:for(var c=0;c<a.length;c++){for(var d in s)if(a[c].name==d)continue t;a.splice(c,1)}t:for(var d in s)if(d!=h){o.isClosed=!1;for(var c=0;c<a.length;c++)if(a[c].name==d){n=a[c],n.info=s[d].info;continue t}n={},n[h]={frames:[],info:s[d].info},a.push({id:Math.random(),objectId:t[r].id,name:d,movies:n,submovie:!0})}e.push(o)}}}),MT.namespace("plugins"),MT.require("misc.tooltips"),MT(MT.plugins.Notification=function(t){this.project=t;var e=this;this.Notification=function(){this.el=new MT.ui.DomElement,this.el.addClass("ui-notification"),this.el.el.innerHTML="Testing...."},this.Notification.prototype.hide=function(){e.hide(this)},this.Notification.prototype.show=function(t){this.el.show(t)},this.notifications=[]},{initUI:function(t){this.ui=t,this.parent=this.ui.centerBottomRightBox;var e=this.project.plugins,i=this;e.assetmanager.on(MT.ASSETS_UPDATED,function(t){i.enabled=!0,t.length<=1&&i.showIntro()})},installUI:function(){},show:function(t,e,i){var s=new this.Notification;s.el.el.onclick=function(){s.hide()},s.el.el.innerHTML='<p class="label">'+t+"</p><p>"+e+"</p>",s.show(this.parent),window.setTimeout(function(){s.el.style.opacity=1},100);var o=this.notifications.push(s);return this.align(s,o-1),isFinite(i)&&window.setTimeout(function(){s.hide()},i),s},showToolTips:function(t,e,i){this.project.plugins;if(this.enabled){var s=MT.misc.tooltips[t.tooltip];if(s){var o;o=i?s.errors[e]:s.tips[e],this.show(s.title,o,3e3)}}},showIntro:function(){},hide:function(t){var e=this;t.el.style.opacity=0,window.setTimeout(function(){e.hideNow(t)},300)},hideNow:function(t){var e=this.notifications.indexOf(t),t=this.notifications.splice(e,1)[0];t&&t.el.hide();for(var i=0;i<this.notifications.length;i++)this.align(this.notifications[i],i)},align:function(t,e){var i=e;e>3&&(i=Math.floor(3+3/e)),t.el.style.bottom=20*i+"px",t.el.style.width=320-10*i+"px",t.el.style.zIndex=999-e}}),MT.namespace("plugins"),MT.require("misc.tooltips"),MT(MT.plugins.TooltipManager=function(){},{initUI:function(t){this.ui=t,this.el=new MT.ui.DomElement("div"),this.el.setAbsolute(),this.el.style.zIndex=1001,this.el.addClass("ui-tooltip")},installUI:function(){var t,e,i,s=this,o=this.ui.events,a=null;o.on(o.MOUSEMOVE,function(o){if(o.target!==a){if(a=o.target,t=o.target.getAttribute("data-tooltip"),!t)return void s.el.hide();e=MT.misc.tooltips[t],i=o.target.getBoundingClientRect(),s.el.show(document.body),s.el.el.innerHTML='<div class="ui-tooltip-label">'+e.title+'</div><div class="ui-tooltip-description">'+e.desc,s.el.x=i.left+i.width,s.el.y=i.top+.5*(i.height-s.el.height)}})}}),MT.namespace("plugins"),MT.require("ui.TableView"),MT(MT.plugins.UserData=function(t){this.project=t,this.table=new MT.ui.TableView(null,["key","value"])},{initUI:function(t){this.ui=t,this.panel=t.createPanel("userData"),this.panel.setFree()},installUI:function(){var t=this.project.plugins,e=t.tools,i=this;this.activeObject=null;var s=function(t){t&&(t.userData||(t.userData={}),i.table.setData(t.userData),i.table.show(i.panel.content.el),i.activeObject=t)};e.on(MT.ASSET_FRAME_CHANGED,function(){}),e.on(MT.OBJECT_SELECTED,function(t){s(t.data),i.type="object"}),t.assetmanager.on(MT.ASSETS_UPDATED,function(){"asset"==i.type&&s(t.assetmanager.getById(i.activeObject.id))});var o=function(){i.table.hide()};e.on(MT.OBJECT_UNSELECTED,o),this.ui.joinPanels(this.project.plugins.settings.panel,this.panel),this.project.plugins.settings.panel.show()}}),MT.namespace("plugins"),MT.extend("core.BasicPlugin")(MT.plugins.Physics=function(t){this.project=t,this.activeObject=null},{initUI:function(t){this.ui=t,this.panel=t.createPanel("physics"),this.panel.setFree(),this.empty=new MT.ui.Input(t,{type:"bool",key:"enable"},{enable:0});var e=this;this.empty.on("change",function(t){t?e.buildPropTree():e.addEmptyInput(),i.sync()});var i=this.project.plugins.objectmanager,s=function(t){e.change(t),e.buildPropTree(),i.sync()},o={};this.inputs={immovable:new MT.ui.Input(t,{key:"immovable",type:"bool"},o),allowGravity:new MT.ui.Input(t,{key:"allow",type:"bool"},o),gravityX:new MT.ui.Input(t,{key:"x",type:"number"},o),gravityY:new MT.ui.Input(t,{key:"y",type:"number"},o),bounceX:new MT.ui.Input(t,{key:"x",type:"number",min:0,step:.1},o),bounceY:new MT.ui.Input(t,{key:"y",type:"number",min:0,step:.1},o),allowRotation:new MT.ui.Input(t,{key:"allowRotation",type:"bool"},o),maxAngular:new MT.ui.Input(t,{key:"maxAngular",type:"number"},o),width:new MT.ui.Input(t,{key:"width",type:"number"},o),height:new MT.ui.Input(t,{key:"height",type:"number"},o),offsetX:new MT.ui.Input(t,{key:"offsetX",type:"number"},o),offsetY:new MT.ui.Input(t,{key:"offsetY",type:"number"},o),mass:new MT.ui.Input(t,{key:"mass",type:"number"},o),collideWorldBounds:new MT.ui.Input(t,{key:"collideWorldBounds",type:"number"},o),maxVelocity:new MT.ui.Input(t,{key:"maxVelocity",type:"number"},o)};for(var a in this.inputs)this.inputs[a].on("change",s);this.createFieldset("gravity"),this.createFieldset("size"),this.createFieldset("rotation")},getTemplate:function(t){return void 0==t?{enable:0}:{enable:1,immovable:1,bounce:{x:1,y:1},gravity:{allow:1,x:0,y:0},size:{width:-1,height:-1,offsetX:0,offsetY:0},rotation:{allowRotation:0,maxAngular:0},maxVelocity:0,mass:1,collideWorldBounds:0}},addEmptyInput:function(){this.clear(),this.empty.show(this.panel.content.el)},change:function(){},_gravityBreak:null,get gravityBreak(){return this._gravityBreak||(this._gravityBreak=document.createElement("br")),this._gravityBreak},buildPropTree:function(){if(this.clear(),this.activeObject.physics.enable){void 0==this.activeObject.physics.immovable&&(this.activeObject.physics=this.getTemplate(!0));var t,e=this.activeObject,i=e.physics;this.empty.setObject(i),this.empty.show(this.panel.content.el),this.inputs.immovable.setObject(i),this.inputs.immovable.show(this.panel.content.el),t=this.addFieldset("size"),this.inputs.width.setObject(i.size),this.inputs.width.show(t),this.inputs.height.setObject(i.size),this.inputs.height.show(t),this.inputs.offsetX.setObject(i.size),this.inputs.offsetX.show(t),this.inputs.offsetY.setObject(i.size),this.inputs.offsetY.show(t),i.immovable||(t=this.addFieldset("bounce"),"object"!=typeof i.bounce&&(i.bounce={x:1,y:1}),this.inputs.bounceX.setObject(i.bounce),this.inputs.bounceX.show(t),this.inputs.bounceY.setObject(i.bounce),this.inputs.bounceY.show(t),t=this.addFieldset("gravity"),void 0==i.gravity.allow&&(i.gravity.allow=1),this.inputs.allowGravity.setObject(i.gravity),this.inputs.allowGravity.show(t),i.gravity.allow?(t.appendChild(this.gravityBreak),this.inputs.gravityX.setObject(i.gravity),this.inputs.gravityX.show(t),this.inputs.gravityY.setObject(i.gravity),this.inputs.gravityY.show(t)):this.gravityBreak.parentNode&&this.gravityBreak.parentNode.removeChild(this.gravityBreak),t=this.addFieldset("rotation"),this.inputs.allowRotation.setObject(i.rotation),this.inputs.allowRotation.show(t),this.inputs.maxAngular.setObject(i.rotation),this.inputs.maxAngular.show(t),this.inputs.maxVelocity.setObject(i),this.inputs.maxVelocity.show(this.panel.content.el),this.inputs.mass.setObject(i),this.inputs.mass.show(this.panel.content.el),void 0==i.collideWorldBounds&&(i.collideWorldBounds=0),this.inputs.collideWorldBounds.setObject(i),this.inputs.collideWorldBounds.show(this.panel.content.el))}},sets:{},addFieldset:function(t){if(this.sets[t])return this.panel.content.el.appendChild(this.sets[t]),this.sets[t];var e=this.createFieldset(t);return this.panel.content.el.appendChild(e),e},createFieldset:function(t){if(!this.sets[t]){var e=document.createElement("fieldset"),i=document.createElement("legend");return e.appendChild(i),i.innerHTML=t,this.sets[t]=e,e}},clear:function(){this.empty.hide();for(var t in this.inputs)this.inputs[t].hide();for(var t in this.sets)this.sets[t].parentNode&&this.sets[t].parentNode.removeChild(this.sets[t])},installUI:function(){var t=this.project.plugins,e=t.tools,i=this,s=this.project.plugins.mapeditor,o=function(t){return s.updateScene(s.settings),t?(i.activeObject=t,void(t.physics?t.physics.enable?i.buildPropTree(t.physics):(t.physics.enable=0,i.empty.setObject(t.physics),i.addEmptyInput()):(t.physics=i.getTemplate(),i.empty.setObject(t.physics),i.addEmptyInput()))):void(i.activeObject=null)};this.ui.events.on("keyup",function(t){t.which==MT.keys.ESC&&i.clear()}),s.on("select",function(){o(s.settings)}),e.on(MT.ASSET_FRAME_CHANGED,o),e.on(MT.OBJECT_SELECTED,function(t){o(t.data)}),e.on(MT.OBJECT_UNSELECTED,function(){i.clear()}),this.ui.joinPanels(this.project.plugins.settings.panel,this.panel),this.project.plugins.settings.panel.show()}}),MT.namespace("plugins"),MT.extend("core.BasicPlugin")(MT.plugins.GamePreview=function(t){this.project=t},{initUI:function(t){},installUI:function(){return},addButtons:function(){},removeButtons:function(){}}),MT.namespace("plugins"),function(){var t="js/cm",e=function(t){var e=document.createElement("link");e.setAttribute("rel","stylesheet"),e.setAttribute("type","text/css"),e.setAttribute("href",t),document.head.appendChild(e)};return window.release?void MT.requireFile(t+"/lib/codemirror-full.js",function(){t+="/addon",MT.requireFile(t+"/scroll/scrollpastend.min.js"),MT.requireFile("js/jshint.min.js"),e("css/codemirror.css"),e(t+"/hint/show-hint.css"),e(t+"/fold/foldgutter.css"),e(t+"/dialog/dialog.css"),e("css/cm-tweaks.css")}):void MT.requireFile(t+"/lib/codemirror.js",function(){t+="/addon",MT.requireFile(t+"/comment/comment.js"),MT.requireFile(t+"/dialog/dialog.js"),MT.requireFile(t+"/edit/matchbrackets.js"),MT.requireFile(t+"/fold/brace-fold.js"),MT.requireFile(t+"/fold/foldgutter.js"),MT.requireFile(t+"/fold/foldcode.js"),MT.requireFile(t+"/fold/xml-fold.js"),MT.requireFile(t+"/hint/show-hint.js"),MT.requireFile(t+"/hint/anyword-hint.js"),MT.requireFile(t+"/hint/show-hint.js"),MT.requireFile(t+"/hint/javascript-hint.js"),MT.requireFile(t+"/scroll/scrollpastend.js"),MT.requireFile(t+"/search/search.js"),MT.requireFile(t+"/search/goto-line.js"),MT.requireFile(t+"/search/searchcursor.js"),MT.requireFile(t+"/search/match-highlighter.js"),MT.requireFile(t+"/selection/active-line.js"),MT.requireFile("js/jshint.js"),e("css/codemirror.css"),e(t+"/hint/show-hint.css"),e(t+"/fold/foldgutter.css"),e(t+"/dialog/dialog.css"),e("css/cm-tweaks.css");var i=/[\w$]+/,s=500;CodeMirror.registerHelper("hint","javascript",function(t,e){for(var o=e&&e.word||i,a=e&&e.range||s,n=t.getCursor(),h=t.getLine(n.line),r=n.ch,l=r;l<h.length&&o.test(h.charAt(l));)++l;for(;r&&o.test(h.charAt(r-1));)--r;for(var c=r!=l&&h.slice(r,l),d=[],u={},p=new RegExp(o.source,"g"),m=-1;1>=m;m+=2)for(var f=n.line,v=Math.min(Math.max(f+m*a,t.firstLine()),t.lastLine())+m;f!=v;f+=m)for(var g,b=t.getLine(f);g=p.exec(b);)(f!=n.line||g[0]!==c)&&(c&&0!=g[0].lastIndexOf(c,0)||Object.prototype.hasOwnProperty.call(u,g[0])||(u[g[0]]=!0,d.push(g[0])));return{list:d,from:CodeMirror.Pos(n.line,r),to:CodeMirror.Pos(n.line,l)}})})}(),MT.extend("core.BasicPlugin")(MT.plugins.SourceEditor=function(t){MT.core.BasicPlugin.call(this,"source"),this.project=t,this.documents={}},{initUI:function(t){this.ui=t,this.panel=this.ui.createPanel("SourceEditor"),this.el=this.panel.content},installUI:function(){this.ui.joinPanels(this.project.plugins.mapeditor.panel,this.panel),this.project.plugins.mapeditor.panel.show(),this.addPanels(),this.addTreeView(),this.addEditor();var t=this,e=t.project.plugins.assetmanager.preview,i=t.project.plugins.moviemaker.panel,s=t.project.plugins.tools,o=this.project.plugins.mapmanager.panel,a=this.project.plugins.undoredo;this.buttonPanel=new MT.ui.DomElement,this.buttonPanel.addClass("ui-panel-content"),this.buttons={newFile:new MT.ui.Button("","ui-button.tool.ui-new-file",null,function(){t.newFile()}),newFolder:new MT.ui.Button("","ui-button.tool.ui-new-folder",null,function(){t.newFolder()}),save:new MT.ui.Button("","ui-button.tool.ui-save-file",null,function(){t.save()}),deleteFile:new MT.ui.Button("","ui-button.tool.ui-delete-file",null,function(){t.deleteFile()})};for(var n in this.buttons)this.buttons[n].show(this.buttonPanel.el);this.panel.on("show",function(){t.ui.loadLayout(null,1),t.panel.show(t.panel._parent,!1),s.panel.content.hide(),o.hide(),e.hide(),i.hide(),a.disable(),MT.events.simulateKey(MT.keys.ESC),t.addButtons(s.panel),t.leftPanel.width=parseInt(t.leftPanel.style.width)}),this.panel.on("unselect",function(){s.panel.content.show(),o.show(),e.show(),i.show(),a.enable(),window.getSelection().removeAllRanges(),t.removeButtons(),t.ui.loadLayout(null,0)}),this.project.on(MT.DROP,function(e,i){if(MT.core.Helper.isSource(i.path)){console.dir(e.target);var s=t.tv.getOwnItem(e.target);s&&s.data.contents&&(i.path=s.data.fullPath+i.path),t.uploadFile(i)}}),this.project.on("updateData",function(e){t.panel.el.style.fontSize=e.sourceEditor.fontSize+"px"})},initSocket:function(t){MT.core.BasicPlugin.initSocket.call(this,t),this.getFiles()},getFiles:function(){this.send("getFiles")},a_receiveFiles:function(t){this.tv.merge(t);this.tv.getData()},uploadFile:function(t){t.src;t.src=Array.prototype.slice.call(new Uint8Array(t.src)),this.send("uploadFile",t)},save:function(t){if(t=t||this.activePanel){var e=t.data;e.src!=e.doc.getValue()&&(e.src=e.doc.getValue(),this.checkChanges(),this.send("save",{path:t.data.data.fullPath,src:this.editor.getValue()}))}},restore:function(t){if(t=t||this.activePanel){var e=t.data;e.src!=e.doc.getValue()&&e.doc.setValue(e.src)}},deleteFile:function(){var t=new MT.ui.Popup("Delete file?","Are you sure you want to delete file?"),e=this;t.addButton("no",function(){t.hide()}),t.addButton("yes",function(){e._deleteFile(),t.hide()}),t.showClose()},_deleteFile:function(){return this.activeTreeItem?(this.send("delete",this.activeTreeItem.data),void(!this.activeTreeItem.data.contents&&this.activePanel&&this.activePanel.close())):void(this.activePanel&&(this.send("delete",this.activePanel.data.data),this.activePanel.close()))
},newFile:function(){this.send("newFile")},a_newFile:function(t){var e=this.tv.getById(t),i=this.loadDocument(e.data,!1);i.data.needFocus=!1,this.tv.enableRename(e)},newFolder:function(){this.send("newFolder")},a_newFolder:function(t){var e=this.tv.getById(t);this.tv.enableRename(e)},rename:function(t,e){this.send("rename",{o:t,n:e})},loadDocument:function(t,e){var i=this,s=this.documents[t.fullPath];if(void 0==s&&(s=new MT.ui.Panel(t.name),s.data={data:t,needFocus:!0,opened:0},s.mainTab.el.setAttribute("title",t.fullPath),this.documents[t.fullPath]=s,s.on("show",function(){var t;i.activePanel&&(t=i.tv.getById(i.activePanel.data.data.id),t&&t.removeClass("selected")),i.activePanel=s,t=i.tv.getById(s.data.data.id),t&&t.addClass("selected"),s.data.doc&&i.loadDoc(s,e)}),s.on("close",function(){i.checkChangesAndAskSave(s),i.activePanel==s&&(el=i.tv.getById(i.activePanel.data.data.id),el&&el.removeClass("selected"))}),s.isCloseable=!0),s.fitIn(),s.addClass("borderless"),this.activePanel?this.activePanel.addJoint(s):(s.show(this.rightPanel.content.el),this.activePanel=s),s.show(),MT.core.Helper.isAudio(t.name)){if(s.audio)return;var o=document.createElement("audio"),a=document.createElement("source");a.setAttribute("src",i.project.path+"/src"+t.fullPath),a.setAttribute("type","audio/"+MT.core.Helper.getExt(t.fullPath)),o.appendChild(a),o.setAttribute("controls","controls"),s.content.el.appendChild(o),s.audio=o,o.onended=function(){o.load()}}else{if(Date.now()-s.data.opened<5e3)return;s.data.opened=Date.now(),this.send("getContent",t)}return s},a_fileContent:function(t){var e=t.name.split(".").pop(),i=this.guessMode(e),s=this;this.loadMode(i,function(){var e=s.documents[t.fullPath].data.doc;s.documents[t.fullPath].data.src=t.src,e||(e=CodeMirror.Doc(t.src,i,0),s.documents[t.fullPath].data.doc=e),s.editor.swapDoc(e),s.documents[t.fullPath].show(),s.loadDoc(s.documents[t.fullPath])})},loadDoc:function(t){this.editorElement.parentNode&&this.editorElement.parentNode.removeChild(this.editorElement),t.content.el.appendChild(this.editorElement),this.editor.swapDoc(t.data.doc);var e=this,i=this.editor.getScrollInfo();this.editor.scrollTo(i.left+1,i.top),this.editor.scrollTo(i.left,i.top),window.setTimeout(function(){t.data.needFocus!==!1&&e.editor.focus()},300),this.updateHints()},addButtons:function(t){this.buttonPanel.show(t.el)},removeButtons:function(){this.buttonPanel.hide()},addPanels:function(){this.leftPanel=this.ui.createPanel("file-list-holder"),this.rightPanel=this.ui.createPanel("source-editor"),this.leftPanel.addClass("borderless"),this.leftPanel.hide().show(this.el.el),this.leftPanel.fitIn(),this.leftPanel.width=200,this.leftPanel.style.setProperty("border-right","solid 1px #000"),this.leftPanel.isResizeable=!0,this.leftPanel.removeHeader();var t=this;this.leftPanel.on("resize",function(e){t.rightPanel.style.left=e+"px"}),this.rightPanel.addClass("borderless"),this.rightPanel.hide().show(this.el.el),this.rightPanel.fitIn(),this.rightPanel.style.left="200px",this.rightPanel.style.width="auto",this.rightPanel.removeHeader(),this.rightPanel.content.style.overflow="hidden"},activeTreeItem:null,addTreeView:function(){this.tv=new MT.ui.TreeView([],{root:this.project.path}),this.tv.tree.show(this.leftPanel.content.el);var t=this,e=function(e,i){t.activeTreeItem&&t.activeTreeItem.removeClass("selected"),t.activeTreeItem=i,i.addClass("selected"),e.contents||t.loadDocument(e)};this.tv.on("click",e),this.tv.on("renameStart",function(){t.activePanel&&(t.activePanel.data.needFocus=!1)}),this.tv.on("change",function(i,s){if(!i||!s)return void t.saveData();var o=t.documents[i]||t.documents[s];if(!o)return void t.rename(i,s);o.data.needFocus=!0;var a=s.split("/").pop();t.documents[s]=o,delete t.documents[i],o.mainTab.el.setAttribute("title",s),o.mainTab.title.innerHTML=a;var n=t.guessMode(a.split(".").pop());t.loadMode(n,function(){var i=t.tv.getById(o.data.data.id);o.data.needFocus=!0,e(o.data.data,i),o.data.doc&&o.data.doc.getEditor().setOption("mode",n)}),t.rename(i,s)});var i=function(e){t.send("updateFolder",{id:e.data.id,isClosed:e.data.isClosed})};this.tv.on("open",function(t){i(t)}),this.tv.on("close",function(t){i(t)}),this.tv.sortable(this.ui.events)},saveData:function(){this.send("update",this.tv.getData())},moveLine:function(t,e){var i=t.state.activeLines[0];if(void 0!=i){var s=t.getCursor(),o=t.getLine(s.line),a=t.getLine(s.line+e);t.replaceRange(a,{ch:0,line:s.line},{ch:o.length,line:s.line}),s.line=s.line+e,t.replaceRange(o,{ch:0,line:s.line},{ch:a.length,line:s.line}),t.setSelection(s),t.indentLine(s.line)}},copyLine:function(t,e){var i=t.state.activeLines[0];if(void 0!=i){var s=t.getCursor(),o=s.ch;s.ch=i.text.length,t.setCursor(s),t.replaceSelection("\r\n"+i.text),s.line=s.line+e,s.ch=o,t.setSelection(s)}},addEditor:function(){var t=this,e={indentUnit:4,extraKeys:{"Ctrl-S":function(){t.save()},"Cmd-S":function(){t.save()},"Ctrl-/":"toggleComment","Cmd-/":"toggleComment","Ctrl-Space":function(){t.showHints()},"Cmd-Space":function(){t.showHints()},"Alt-Up":function(e){t.moveLine(e,-1)},"Alt-Down":function(e){t.moveLine(e,1)},"Ctrl-Alt-Up":function(e){t.copyLine(e,0)},"Ctrl-Alt-Down":function(e){t.copyLine(e,1)},"Ctrl-+":function(){alert()},"Cmd-Alt-Up":function(e){t.copyLine(e,0)},"Cmd-Alt-Down":function(e){t.copyLine(e,1)},"Cmd-+":function(){alert()},"Ctrl-L":"gotoLine","Cmd-L":"gotoLine"},gutters:["CodeMirror-linenumbers","CodeMirror-foldgutter","CodeMirror-jslint"],highlightSelectionMatches:{showToken:/\w/},onCursorActivity:function(){editor.matchHighlight("CodeMirror-matchhighlight")},tabMode:"shift",indentWithTabs:!0,lineNumbers:!0,foldGutter:!0,styleActiveLine:!0,matchBrackets:!0,autofocus:!0,dragDrop:!0,showTabs:!0,undoDepth:500,scrollPastEnd:!0,historyEventDelay:200,tabSize:4,cursorBlinkRate:530};this.editorElement=null;var t=this;this.editor=CodeMirror(function(e){t.editorElement=e},e),this.editor.on("change",function(){t.checkChanges()}),this.editor.on("keyup",function(t,e){if(e.altKey&&(e.which==MT.keys.UP||e.which==MT.keys.DOWN)){{t.state.activeLines[0],t.getCursor()}return e.preventDefault(),!1}})},showHints:function(){this.editor.execCommand("autocomplete")},updateHints:function(){var t=this;this.editor.operation(function(){if(t.editor.clearGutter("CodeMirror-jslint"),"javascript"==t.editor.options.mode.name){var e={browser:!0,globalstrict:!0,strict:"implied",undef:!0,unused:!0,loopfunc:!0,predef:{Phaser:!1,mt:!1,console:!1},laxcomma:!1};t.lastWorker&&t.lastWorker.terminate();var i=new Worker("js/jshint-worker.js");t.lastWorker=i,i.onmessage=function(e){console.log("jshint:",e.data[0].length);for(var i=e.data[0],s=0;s<i.length;++s){var o=i[s];if(o){var a=document.createElement("a");a.errorTxt=o.reason;var n=a.appendChild(document.createElement("span"));n.innerHTML="!",n.className="lint-error-icon";var h=a.appendChild(document.createElement("span"));h.className="lint-error-text",h.appendChild(document.createTextNode(o.reason)),a.className="lint-error",t.editor.setGutterMarker(o.line-1,"CodeMirror-jslint",a)}}},i.postMessage([t.editor.getValue(),e])}})},delay:0,checkChanges:function(){if(this.activePanel){if(!this.delay){var t=this;this.delay=window.setTimeout(function(){t.updateHints(),t.delay=0},100)}var e=this.activePanel.data;this.activePanel.mainTab.title.innerHTML=e.src!=e.doc.getValue()?e.data.name+"*":e.data.name}},checkChangesAndAskSave:function(t){var e=t.data;if(e.doc&&e.src!==e.doc.getValue()){var i=this,s=new MT.ui.Popup("File changed","File has been changed, do you want to save changes?");s.addButton("no",function(){i.restore(t),s.hide()}),s.addButton("yes",function(){i.save(t),s.hide()}),s.showClose()}},guessMode:function(t){var e={};return"js"==t&&(e.name="javascript",e.hint="javascript"),"html"==t&&(e.name="htmlmixed",e.hint="html",e.scriptTypes=[{matches:/\/x-handlebars-template|\/x-mustache/i,mode:null},{matches:/(text|application)\/(x-)?vb(a|script)/i,mode:"vbscript"}]),"css"==t&&(e.name="css",e.hint="css"),"json"==t&&(e.name="javascript"),e},_loadedModes:{},loadMode:function(t,e){if(!t||!t.name)return void e();if(this._loadedModes[t.name])e();else{var i=function(){"htmlmixed"==t.name?MT.requireFile("js/cm/mode/xml/xml.js",function(){MT.requireFile("js/cm/mode/"+t.name+"/"+t.name+".js",e)}):MT.requireFile("js/cm/mode/"+t.name+"/"+t.name+".js",e)};t.hint?MT.requireFile("js/cm/addon/hint/"+t.hint+"-hint.js",i):i()}}}),MT.namespace("plugins"),MT.extend("core.BasicPlugin")(MT.plugins.MapManager=function(t){MT.core.BasicPlugin.call(this,"MapManager"),this.project=t},{installUI:function(t){var e=this;this.panel=this.ui.createPanel("Map Manager"),this.panel.isDockable=!0,this.panel.isJoinable=!1,this.panel.isResizeable=!1,this.panel.removeHeader(),this.panel.height=25,t.dockToBottom(this.panel),this.locateObject=this.panel.addButton("","map-locate",function(){e.locate()}),this.map=this.project.plugins.mapeditor,this.locateObject.width="auto",this.zoom=new MT.ui.Dropdown({list:[200,150,100,90,80,70,60,50],button:{"class":"text-size",width:"auto"},listStyle:{width:70},value:100},t),this.zoom.button.el.setAttribute("data-text","%"),this.zoom.on("change",function(t){e.setZoom(t)}),this.zoom.on("show",function(){e.zoom.button.el.setAttribute("data-text","")}),this.zoom.on("hide",function(){e.zoom.button.el.setAttribute("data-text","%")}),this.panel.addButton(this.zoom.button),this.panel.addClass("map-manager-panel"),this.panel.alignButtons(),this.panel.style.marginLeft=0,this.ui.events.on("wheel",function(t){t.target==e.map.game.canvas&&(t.wheelDelta>0?e.incZoom(t.offsetX,t.offsetY):e.decZoom(t.offsetX,t.offsetY))})},setZoom:function(t){this._setZoom(.01*t)},_setZoom:function(t,e,i){var s=this.map.game.camera;this.map.resize();var o=s.x/s.scale.x+s.view.halfWidth,a=s.y/s.scale.y+s.view.halfHeight;if(void 0!==e)var n=e/s.scale.x+s.x/s.scale.x,h=i/s.scale.y+s.y/s.scale.y,r=e/t+s.x/t,l=i/t+s.y/t,c=(r-n)*t,d=(l-h)*t;s.scale.setTo(t,t),this.map.resize(),void 0!==e?(s.x-=c,s.y-=d):this.locateXY(o,a),this.zoom.list.isVisible||(this.zoom.button.text=(100*t).toFixed(0)),this.map.settings.cameraX=s.x,this.map.settings.cameraY=s.y,this.project.plugins.settings.updateScene(this.map.settings);var u=this;window.setTimeout(function(){u.map.update()},10)},locate:function(){this.map.game.camera;if(!this.map.activeObject||this.map.activeObject.object)return this.map.game.camera.x=0,void(this.map.game.camera.y=0);var t=this.map.activeObject.object;this.locateXY(t.x+t.width*(.5-t.anchor.x),t.y+t.height*(.5-t.anchor.y))},locateXY:function(t,e){var i=this.map.game.camera;i.x=(t-i.view.halfWidth)*i.scale.x,i.y=(e-i.view.halfHeight)*i.scale.y},incZoom:function(t,e){var i=this.map.scale.x;i>3||this._setZoom(i+.1,t,e)},decZoom:function(t,e){var i=this.map.scale.x;.3>i||this._setZoom(i-.1,t,e)}}),MT.namespace("plugins"),MT.extend("core.BasicPlugin")(MT.plugins.FontManager=function(t){MT.core.BasicPlugin.call(this,"Analytics"),this.project=t},{loadFont:function(t,e){var i=t.replace(/ /gi,"+"),s=document.createElement("link");s.setAttribute("rel","stylesheet"),s.setAttribute("type","text/css"),s.onload=function(){var i=document.createElement("span");i.style.fontFamily=t,i.innerHTML="ignore",i.style.visibility="hidden",document.body.appendChild(i),window.setTimeout(function(){document.body.removeChild(i)},5e3),e(t)},s.href="//fonts.googleapis.com/css?family="+i,document.head.appendChild(s)}}),MT.namespace("plugins"),MT.extend("core.BasicPlugin")(MT.plugins.HelpAndSupport=function(t){MT.core.BasicPlugin.call(this,"HelpAndSupport"),this.project=t},{initUI:function(t){var e=this;this.list=new MT.ui.List([{label:"About",className:"",cb:function(){e.openHomePage()}},{label:"Video Tutorial",className:"",cb:function(){e.openVideo()}},{label:"on HTML5 Game Devs Forum",className:"",cb:function(){e.openForum()}},{label:"google fonts",className:"",cb:function(){e.openFonts()}},{label:"Leshy SpriteSheet Tool",className:"",cb:function(){e.openLink("http://www.leshylabs.com/apps/sstool/")}},{label:"Found a bug? Report on github",className:"",cb:function(){e.openLink("https://github.com/TheMightyFingers/mightyeditor/issues/new")}}],t,!0);var i=this.project.panel.addButton("Help and Support",null,function(t){t.stopPropagation(),e.list.show(document.body),e.list.y=i.el.offsetHeight,e.list.x=i.el.offsetLeft-5,e.list.el.style.bottom="initial"});e.list.width=300},openForum:function(){var t=window.open("about:blank","_newTab");t.opener=null,t.location.href="http://www.html5gamedevs.com/topic/6303-game-editor-on-phaser/"},openHomePage:function(){var t=window.open("about:blank","_newTab");t.opener=null,t.location.href="http://mightyfingers.com/editor-features/"},openVideo:function(){var t=window.open("about:blank","_newTab");t.opener=null,t.location.href="https://www.youtube.com/watch?v=gzGHMRx3yz0"},openFonts:function(){var t=window.open("about:blank","_newTab");t.opener=null,t.location.href="https://www.google.com/fonts"},openLink:function(t){var e=window.open("about:blank","_newTab");e.opener=null,e.location.href=t}}),MT.namespace("ui"),MT.extend("ui.DomElement")(MT.ui.Fieldset=function(t){MT.ui.DomElement.call(this,"fieldset"),this.title=t},{get title(){return this.title.innerHTML},legend:null,set title(t){this.legend||(this.legend=document.createElement("legend"),this.el.appendChild(this.legend)),(void 0!==t||""!=t)&&(this.legend.innerHTML=t)}}),MT.namespace("ui"),MT.extend("core.Emitter").extend("ui.DomElement")(MT.ui.Popup=function(t,e){MT.ui.DomElement.call(this),this.addClass("ui-popup"),this.head=document.createElement("div"),this.head.className="ui-popup-head",this.content=document.createElement("div"),this.content.className="ui-popup-content",this.el.appendChild(this.head),this.el.appendChild(this.content),this.head.innerHTML=t,this.content.innerHTML=e,this.bg=document.createElement("div"),this.bg.className="ui-wrapper",this.bg.style.zIndex=9999,this.bg.onmousedown=this.bg.onmouseup=this.bg.onmousemove=function(t){return t.preventDefault(),t.stopPropagation(),!1},this.style.zIndex=1e4,this.y=.3*window.innerHeight,this.style.bottom="auto",this.addClass("ui-popup-with-head"),this.show()},{showClose:function(){if(!this.close){this.close=document.createElement("div"),this.close.className="ui-popup-close",this.head.appendChild(this.close);var t=this;this.close.onclick=function(){t.hide(!0)}}},addButton:function(t,e){this.buttonBar||(this.buttonBar=document.createElement("div"),this.el.appendChild(this.buttonBar),this.buttonBar.className="ui-button-bar"),this.buttons=this.buttons||{};var i=this.buttons[t]=document.createElement("div");i.className="ui-popup-button",i.innerHTML=t,i.onclick=function(t){e(t),t.stopPropagation()},this.buttonBar.appendChild(i),this.addClass("ui-has-buttons")},removeHeader:function(){this.head.parentNode&&(this.head.parentNode.removeChild(this.head),this.removeClass("ui-popup-with-head"))},hide:function(t){this.bg.parentNode&&this.bg.parentNode.removeChild(this.bg),this.el.parentNode&&this.el.parentNode.removeChild(this.el),this.emit("close",t)},show:function(){this.emit("show"),document.body.appendChild(this.bg),document.body.appendChild(this.el)}}),MT.namespace("core"),MT.keys=MT.core.keys={ESC:27,ENTER:13,UP:38,LEFT:37,RIGHT:39,DOWN:40,DELETE:46,TAB:9,SPACE:32};for(var i=65;91>i;i++)MT.keys[String.fromCharCode(i)]=i;MT["const"]={IMAGES:"image/*",DATA:"application/json|application/xml",AUDIO:"mp3, ogg, wav"},MT.namespace("plugins"),MT.plugins.list=1,MT.require("plugins.AssetManager"),MT.require("plugins.ObjectManager"),MT.require("plugins.MapEditor"),MT.require("plugins.Settings"),MT.require("plugins.Export"),MT.require("plugins.Tools"),MT.require("plugins.UndoRedo"),MT.require("plugins.DataLink"),MT.require("plugins.Analytics"),MT.namespace(""),MT.extend("core.Emitter")(MT.Socket=function(t,e){this.binary=!1,this.url=t?t:"ws://"+window.location.host,e!==!1&&this.connect(),this.callbacks={},this._toSend=[],this.sendObject={channel:"",action:"",data:null,__cb:null}},{delay:0,connect:function(t){t&&(this.url=t);var e=this;this.ws=new WebSocket(this.url),console.log("connecting...."),this.ws.binaryType="arraybuffer",this.ws.onopen=function(){console.log("connected"),e.emit("core","open")},this.ws.onmessage=function(t){var i;i=e.binary?UTF8ArrToStr(t.data):t.data;var s=JSON.parse(i);return"___"===s.action?(MT.Socket.__callbacks[s.__cb](s.data),void delete MT.Socket.__callbacks[s.__cb]):void e.emit(s.channel,s.action,s.data)},this.ws.onerror=function(t){console.error(t)},this.ws.onclose=function(){console.log("WS close"),e.emit("core","close"),window.setTimeout(function(){e.connect()},1e3)}},send:function(t,e,i,s){if(this.ws.readyState==this.ws.OPEN){this.sendObject.channel=t,this.sendObject.action=e,this.sendObject.data=i,this.sendObject.__cb=void 0,s&&(this.sendObject.__cb=MT.Socket.genCallback(s));var o=JSON.stringify(this.sendObject);return void this.ws.send(this.binary?strToUTF8Arr(o):o)}if(this._toSend.push([t,e,i]),0===this.delay){var a=this;this.delay=window.setTimeout(function(){a.sendDelayed()},100)}},sendDelayed:function(){if(this.ws.readyState!==this.ws.OPEN){var t=this;return void(this.delay=window.setTimeout(function(){t.sendDelayed()},100))}for(var e=0;e<this._toSend.length;e++)this.send.apply(this,this._toSend[e])},emit:function(t,e,i){if(!this.callbacks[t])return void console.warn("received unhandled data",t,i);for(var s=this.callbacks[t],o=0;o<s.length;o++)s[o](e,i)},genCallback:function(t){var e=MT.Socket;return e.nextCB++,e.__callbacks[e.nextCB]=t,e.nextCB}}),MT.Socket.TYPE={open:"open",close:"close",message:"message",error:"error"},MT.Socket.__callbacks={},MT.Socket.nextCB=0,MT.namespace("ui"),MT.require("ui.Events"),MT.require("ui.Panel"),MT.LEFT=1,MT.RIGHT=2,MT.TOP=3,MT.BOTTOM=4,MT.CENTER=5,MT.NONE=0,MT.ui.addClass=function(t,e){if("object"!=typeof e){for(var i=t.className.split(" "),s=0;s<i.length;s++)if(i[s]==e)return;i.push(e),t.className=i.join(" ")}else for(var s=0;s<e.length;s++)this.addClass(t,e[s])},MT.ui.removeClass=function(t,e){if("object"!=typeof e){for(var i=t.className.split(" "),s=0;s<i.length;s++)i[s]==e&&i.splice(s,1);t.className=i.join(" ")}else for(var s=0;s<e.length;s++)this.removeClass(t,e[s])},MT.ui.hasParent=function(t,e){for(var i=t;i.parentNode;){if(i==e)return!0;i=i.parentNode}return!1},MT.extend("core.Emitter")(MT.ui.Controller=function(){this.events=new MT.ui.Events,window.oncontextmenu=function(t){t.preventDefault()},this.panels=[],this.oldPrefix="ui-",this.keyPrefix="uin-",this.resetOldLayout(),this._centerPanels=[],this.additionalBorder=4,this.helper=new MT.ui.DomElement,this.helper.addClass("ui-main-helper"),this.helper.setAbsolute(),this.helper.style.zIndex=99999,this.box={x:0,y:0,width:window.innerWidth,height:window.innerHeight},this.centerBottomRightBox=document.createElement("div"),document.body.appendChild(this.centerBottomRightBox),this.centerBottomRightBox.style.position="absolute",this.snapPx=20;var t=this,e=!1,i=null,s=!1,o=null;this.oldScreenSize.width=window.innerWidth,this.oldScreenSize.height=window.innerHeight;var a="transitionend";window.navigator.userAgent.indexOf("Chrome")>1&&(a="webkitTransitionEnd");var n=function(e){t.update();var i=e.propertyName;("width"==i||"height"==i)&&t.refresh(),this.removeEventListener(a,n),window.setTimeout(function(){document.addEventListener(a,n,!1)},1)};document.addEventListener(a,n,!1),this.events.on(this.events.RESIZE,function(e){t.reloadSize(e)}),this.events.on(this.events.MOUSEMOVE,function(a){if(!e){var n=a.target.panel||t.pickPanel(a);return n?(o=n,s=t.checkResize(n,a),a.target.panel||s||a.altKey?void(i=n):void(i=null)):(t.resetResizeCursor(),void(i=null))}if(i)return s?void t.resizePanel(i,a):void(t.tryUnjoin(i,a)&&t.movePanel(i,a))}),this.events.on(this.events.DBLCLICK,function(){console.log("rename"),i&&i.isRenamable&&i.startRename()});var h=null;this.events.on(this.events.MOUSEDOWN,function(s){return 0!=s.button?void(1==s.button&&s.target.data&&s.target.data.panel&&s.target.data.panel.isCloseable&&s.target.data.panel.close()):(e=!0,i?(s.target.data&&s.target.data.panel?(s.target.data.panel!==h&&(h=s.target.data.panel),i.isVisible||i.show(null),i.isNeedUnjoin=!0):i.isNeedUnjoin=!1,i.removeClass("animated"),t.updateZ(i),void window.setTimeout(function(){i.focus()},0)):void(o&&!o.isDocked&&(t.updateZ(o),window.setTimeout(function(){o.focus()},0))))}),this.events.on(this.events.MOUSEUP,function(s){e=!1,i&&(s.stopPropagation(),i.addClass("animated"),i.isNeedUnjoin=!0,i.mdown=!1,i.toJoinWith&&(t.joinPanels(i.toJoinWith,i),i.setAll("toJoinWith",null),i.isDockNeeded=!1),t.hideDockHelper(i),i.ox=0,i.oy=0,t.sortPanels(),t.update(),t.saveLayout())},!0);var r=window.setInterval(function(){t.emit(t.events.RESIZE)},200);window.setTimeout(function(){window.clearInterval(r)},2e3),this.colorPicker=new MT.ui.ColorPicker(this),this.colorPicker.hide()},{resetOldLayout:function(){for(var t,e=0;e<localStorage.length;e++)t=localStorage.key(e),t.substring(0,this.oldPrefix.length)==this.oldPrefix&&localStorage.removeItem(t)},saveSlot:0,toResize:{TOP:!1,RIGHT:!1,BOTTOM:!1,LEFT:!1},zIndex:1,refresh:function(){this.emit(this.events.RESIZE)},setCenter:function(t){this._centerPanels.length>0&&this._centerPanels.join(t),this._centerPanels.push(t),t.isDocked=!0,t.isPickable=!1,t.dockPosition=MT.CENTER,this.sortPanels(),this.updateCenter()},p:{},createPanel:function(t,e,i){t||console.error("bad name");var s=new MT.ui.Panel(t,this);Object.defineProperty(this.p,t,{get:function(){return s},enumerable:!0}),this.panels.push(s),s.width=e||250,s.height=i||400,s.x=this.box.x,s.y=this.box.y,s.show(),s.name=t,s.style.zIndex=1;var o=this;return s.on("hide",function(){o.beforeHide(s)}),s.on("show",function(){o.beforeShow(s)}),s.addClass("animated"),s},beforeHide:function(t){return t.cache={dockPosition:t.dockPosition,isDocked:t.isDocked,width:t.width,height:t.height},t.isDocked?(this.undock(t),void this.update()):void t.saveBox()},beforeShow:function(t){t.cache&&t.cache.isDocked&&(t.width=t.cache.width,t.height=t.cache.height,this.helper.dockPosition=t.cache.dockPosition,this.helper.isDocked=!0,this.helper.dockPosition==MT.TOP&&this.showDockHelperTop(t),this.helper.dockPosition==MT.LEFT&&this.showDockHelperLeft(t),this.helper.dockPosition==MT.RIGHT&&this.showDockHelperRight(t),this.helper.dockPosition==MT.BOTTOM&&this.showDockHelperBottom(t),this.dockToHelper(t),this.helper.hide())},sortPanels:function(){this.panels.sort(function(t,e){return t.style.zIndex-e.style.zIndex})},updateZ:function(t){this.sortPanels();for(var e=null,i=this.panels.length-1;i>0;i--)e=this.panels[i],e.isDocked?e.style.zIndex!=i&&(e.style.zIndex=i):e.style.zIndex!=i+10&&e.style.zIndex<1e3&&(e.style.zIndex=i+10);this.zIndex=this.panels.length,t&&(t.isDocked?t.style.zIndex=this.zIndex+1:t.style.zIndex<1e3&&(t.style.zIndex=this.zIndex+10))},removePanel:function(t){this.disableMoveable(t);for(var e=0;e<this.panels.length;e++)if(this.panels[e]==t)return this.panels.splice(e,1);return null},checkResize:function(t,e){if(!t.isResizeable)return this.setResizeCursor(!0),!1;if(!MT.ui.hasParent(e.target,t.el))return this.setResizeCursor(!0),!1;var i=0,s=0,o=t.getStyle(),a=e.x-t.x,n=e.y-t.y,h=!1;return a/t.width<.5?(s=parseInt(o.borderLeftWidth),s&&a<s+this.additionalBorder&&(this.toResize.LEFT=!0,h=!0)):(s=parseInt(o.borderRightWidth),s&&t.width-a<s+this.additionalBorder&&(this.toResize.RIGHT=!0,h=!0)),n/t.height<.5?(i=parseInt(o.borderTopWidth),i&&n<i+this.additionalBorder&&(this.toResize.TOP=!0,h=!0)):(i=parseInt(o.borderBottomWidth),i&&t.height-n<i+this.additionalBorder&&(this.toResize.BOTTOM=!0,h=!0)),this.setResizeCursor(!h),h},setResizeCursor:function(t){if(t)return void this.resetResizeCursor();var e="";this.toResize.TOP&&(e+="n"),this.toResize.BOTTOM&&(e+="s"),this.toResize.RIGHT&&(e+="e"),this.toResize.LEFT&&(e+="w"),document.body.style.setProperty("cursor",e+"-resize","important")},resetResizeCursor:function(){this.toResize.TOP=!1,this.toResize.RIGHT=!1,this.toResize.BOTTOM=!1,this.toResize.LEFT=!1,document.body.style.removeProperty("cursor","auto","important")},resizePanel:function(t){var e=this.events.mouse.mx,i=this.events.mouse.my;this.toResize.RIGHT&&(t.width+=e,t.dockPosition==MT.LEFT&&this.resizeSidePanelsFromLeft(t,e)),this.toResize.BOTTOM&&(t.height+=i,t.dockPosition==MT.TOP&&this.resizeSidePanelsFromTop(t,i)),this.toResize.LEFT&&(t.x+=e,t.width=t.width-e,t.dockPosition==MT.RIGHT&&this.resizeSidePanelsFromRight(t,e)),this.toResize.TOP&&(t.y+=i,t.height-=i,t.dockPosition==MT.BOTTOM&&this.resizeSidePanelsFromBottom(t,i)),t.isDocked&&this.moveDocks()},resizeSidePanelsFromLeft:function(t,e){for(var i=null,s=0;s<this.panels.length;s++)i=this.panels[s],i.setTopBottom("justUpdated",!1);for(var s=0;s<this.panels.length;s++)if(i=this.panels[s],!i.justUpdated&&(i.dockPosition==MT.TOP||i.dockPosition==MT.BOTTOM)){if(t.x>=i.x)continue;i.x=i.x+e,i.width=i.width-e,i.setTopBottom("justUpdated",!0)}},resizeSidePanelsFromRight:function(t,e){for(var i=null,s=0;s<this.panels.length;s++)i=this.panels[s],i.setTopBottom("justUpdated",!1);for(var s=0;s<this.panels.length;s++)if(i=this.panels[s],!i.justUpdated&&(i.dockPosition==MT.TOP||i.dockPosition==MT.BOTTOM)){if(t.x+t.width<=i.x+i.width)continue;i.width=i.width+e,i.setTopBottom("justUpdated",!0)}},resizeSidePanelsFromTop:function(t,e){for(var i=null,s=0;s<this.panels.length;s++)i=this.panels[s],i.setAll("justUpdated",!1);for(var s=0;s<this.panels.length;s++)i=this.panels[s],i.justUpdated||(i.dockPosition==MT.LEFT||i.dockPosition==MT.RIGHT)&&(i.top||t.y>=i.y||(i.y=i.y+e,i.height=i.height-e,i.setAll("justUpdated",!0)))},resizeSidePanelsFromBottom:function(t,e){for(var i=null,s=0;s<this.panels.length;s++)i=this.panels[s],i.setAll("justUpdated",!1);for(var s=0;s<this.panels.length;s++)i=this.panels[s],i.justUpdated||(i.dockPosition==MT.LEFT||i.dockPosition==MT.RIGHT)&&(i.bottom||i.y+i.height>=t.y+t.height||i.bottom||(i.setClearHeight(i.height+e),i.setAll("justUpdated",!0)))},dockToLeft:function(t){return t.isDockable?(t.isDocked?this.undock(t):t.saveBox(),t.x=this.box.x,t.y=this.box.y,t.setAll("height",this.box.height),t.dockPosition=MT.LEFT,t.isDocked=!0,void this.moveDocksLeft()):void console.error("trying to dock undockable panel")},dockToRight:function(t){return t.isDockable?(t.isDocked?this.undock(t):t.saveBox(),t.x=this.box.width-t.width,t.y=this.box.y,t.setAll("height",this.box.height),t.dockPosition=MT.RIGHT,t.isDocked=!0,void this.moveDocksRight()):void console.error("trying to dock undockable panel")},dockToTop:function(t){return t.isDockable?(t.isDocked?this.undock(t):t.saveBox(),t.y=this.box.y,t.x=this.box.x,t.width=this.box.width,this.box.y+=t.height,this.box.height-=t.height,t.dockPosition=MT.TOP,t.isDocked=!0,void this.moveDocksTop()):void console.error("trying to dock undockable panel")},dockToBottom:function(t){return t.isDockable?(t.isDocked?this.undock(t):t.saveBox(),t.x=this.box.x,t.y=this.box.height-t.height,t.width=this.box.width,this.box.height-=t.height,t.dockPosition=MT.BOTTOM,t.isDocked=!0,void this.moveDocksBottom()):void console.error("trying to dock undockable panel")},update:function(){this.updateZ()},moveDocks:function(){this.moveDocksLeft(),this.moveDocksRight(),this.moveDocksTop(),this.moveDocksBottom(),this.updateCenter()},moveDocksLeft:function(){var t=this.panels.slice(0);t.sort(function(t,e){return t.x-e.x});var e=null;this.box.x=0;for(var i=0;i<t.length;i++)e=t[i],e.setTopBottom("justUpdated",!1);for(var i=0;i<t.length;i++)e=t[i],e.dockPosition==MT.LEFT&&e.isVisible&&(e.justUpdated||(e.x=this.box.x,this.box.x+=e.width,this.box.width-=e.width,e.setTopBottom("justUpdated",!0)))},moveDocksRight:function(){var t=this.panels.slice(0);t.sort(function(t,e){return-(t.x+t.width)+(e.x+e.width)});for(var e=0;e<t.length;e++)i=t[e],i.setTopBottom("justUpdated",!1);var i=null;this.box.width=window.innerWidth;for(var e=0;e<t.length;e++)i=t[e],i.isDocked&&i.dockPosition==MT.RIGHT&&i.isVisible&&(i.justUpdated||(i.x=this.box.width-i.width,this.box.width-=i.width,i.setTopBottom("justUpdated",!0)))},moveDocksTop:function(){var t=this.panels.slice(0);t.sort(function(t,e){return t.y-e.y});var e=null;this.box.y=0;for(var i=0;i<t.length;i++)e=t[i],e.setLeftRight("justUpdated",!1);for(var i=0;i<t.length;i++)e=t[i],e.isDocked&&e.dockPosition==MT.TOP&&e.isVisible&&(e.justUpdated||(e.y=this.box.y,this.box.y+=e.height,e.setLeftRight("justUpdated",!0)))},moveDocksBottom:function(){var t=this.panels.slice(0);t.sort(function(t,e){return e.y+e.height-(t.y+t.height)});for(var e=0;e<t.length;e++)i=t[e],i.setTopBottom("justUpdated",!1);var i=null;this.box.height=window.innerHeight;for(var e=0;e<t.length;e++)i=t[e],i.dockPosition==MT.BOTTOM&&i.isDocked&&i.isVisible&&(i.justUpdated||(i.y=this.box.height-i.height,this.box.height-=i.height,i.setLeftRight("justUpdated",!0)))},updateCenter:function(t){if(0!=this._centerPanels.length){var e=this._centerPanels[0];(e.x!=this.box.x||e.y!=this.box.y||e.width!=this.box.width-this.box.x||e.height!=this.box.height-this.box.y)&&(e.x=this.box.x,e.y=this.box.y,e.width=this.box.width-this.box.x,e.height=this.box.height-this.box.y,t||this.emit(this.events.RESIZE)),this.centerBottomRightBox.style.left=e.x+e.width,this.centerBottomRightBox.style.top=e.y+e.height,this.centerBottomRightBox.style.zIndex=1001,this.centerBottomRightBox.style.backgroundColor="inherit"}},tryUnjoin:function(t){if(1===t.joints.length)return!0;if(!t.isJoinable)return!0;if(!t.isNeedUnjoin)return!0;var e=this.events.mouse.mx,i=this.events.mouse.my;return t.ox+=e,t.oy+=i,Math.abs(t.ox)<this.snapPx&&Math.abs(t.oy)<this.snapPx?!1:(t.unjoin(),t.isNeedUnjoin=!1,t.isDocked||(t.x+=t.ox,t.y+=t.oy,t.ox=0,t.oy=0),t.isDocked=!1,t.dockPosition=MT.NONE,t.loadBox(),!0)},movePanel:function(t,e){if(t.isMovable){var i=!0,s=this.vsPanels(e,t);if(s&&s.acceptsPanels){var o=(e.x-s.x)/s.width,a=(e.y-s.y)/s.height;this.showHelperOverPanel(s,o,a),i=!1}var n=this.events.mouse.mx,h=this.events.mouse.my;if(t.isDocked){if(t.ox+=n,t.oy+=h,Math.abs(t.ox)<this.snapPx&&Math.abs(t.oy)<this.snapPx)return;this.undock(t),t.x+=t.ox,t.y+=t.oy,t.ox=0,t.oy=0}t.x+=n,t.y+=h,i&&(Math.abs(e.x-this.box.x)<this.snapPx&&!s?(this.showDockHelperLeft(t),i=!1):Math.abs(e.x-this.box.width)<this.snapPx&&!s?(this.showDockHelperRight(t),i=!1):Math.abs(e.y-this.box.y)<this.snapPx&&!s?(this.showDockHelperTop(t),i=!1):Math.abs(e.y-this.box.height)<this.snapPx&&!s?(this.showDockHelperBottom(t),i=!1):t.isDockNeeded=!1),i&&this.helper.hide()}},showDockHelperLeft:function(t){this.helper.show(),this.helper.width=t.width,this.helper.height=this.box.height-this.box.y,this.helper.x=this.box.x,this.helper.y=this.box.y,this.helper.dockPosition=MT.LEFT,t.isDockNeeded=!0,this.helper.toJoinWith=null},showDockHelperRight:function(t){this.helper.show(),this.helper.width=t.width,this.helper.height=this.box.height-this.box.y,this.helper.x=this.box.width-t.width,this.helper.y=this.box.y,this.helper.dockPosition=MT.RIGHT,t.isDockNeeded=!0,this.helper.toJoinWith=null},showDockHelperTop:function(t){this.helper.show(),this.helper.width=this.box.width-this.box.x,this.helper.height=t.height,this.helper.x=this.box.x,this.helper.y=this.box.y,this.helper.dockPosition=MT.TOP,t.isDockNeeded=!0,this.helper.toJoinWith=null},showDockHelperBottom:function(t){this.helper.show(),this.helper.width=this.box.width-this.box.x,this.helper.height=t.height,this.helper.x=this.box.x,this.helper.y=this.box.height-t.height,this.helper.dockPosition=MT.BOTTOM,t.isDockNeeded=!0,this.helper.toJoinWith=null},showHelperOverPanel:function(t,e,i){t.acceptsPanels&&(this.helper.width=t.width,this.helper.x=t.x,this.helper.toJoinWith=t,t.isDocked?.3>i?(this.helper.y=t.y,this.helper.height=.5*t.height,this.helper.joinPosition=MT.TOP):i>.7?(this.helper.height=.5*t.height,this.helper.y=t.y+t.height-this.helper.height,this.helper.joinPosition=MT.BOTTOM):(this.helper.y=t.y,this.helper.height=t.height,this.helper.joinPosition=MT.CENTER):(this.helper.y=t.y,this.helper.height=t.height,this.helper.joinPosition=MT.CENTER),this.helper.show())
},hideDockHelper:function(t){if(this.helper.isVisible){if(this.helper.toJoinWith){t.saveBox(),t.height=this.helper.height;var e=this.helper.toJoinWith;return this.helper.joinPosition==MT.CENTER&&this.joinPanels(e,t),this.helper.joinPosition==MT.BOTTOM&&(e.joinBottom(t),e.isDocked&&(t.dockPosition=e.dockPosition,t.isDocked=!0)),this.helper.joinPosition==MT.TOP&&(e.joinTop(t),e.isDocked&&(t.dockPosition=e.dockPosition,t.isDocked=!0)),this.helper.toJoinWith=null,void this.helper.hide()}t&&t.isDockNeeded&&!t.isDocked&&this.dockToHelper(t),this.helper.hide()}},joinPanels:function(t,e){e.inheritSize(t),t.addJoint(e),t.removeClass("active"),e.removeClass("active"),t.hide(!1),t.isDocked&&this.dockToHelper(e,t),e.header.setActiveIndex(0),e.header.showTabs(),e.isDockNeeded=!1,e.isVisible=!1,e.show()},vsPanels:function(t,e){for(var i=null,s=this.panels.length-1;s>-1;s--)if(i=this.panels[s],i!=e&&i.isVisible&&i.isPickable&&i.vsPoint(t))return i;return null},pickPanel:function(t){for(var e=null,i=this.panels.length-1;i>-1;i--)if(e=this.panels[i],e.isVisible&&e.isPickable&&e.vsPoint(t))return e;return null},dockToHelper:function(t,e){t.isDocked||(e=e||this.helper,e.isDocked||t.saveBox(),t.inheritSize(e),t.setAll("isDocked",!0),t.setAll("isDockNeeded",!1),t.style.zIndex=0,t.dockPosition=e.dockPosition,this.moveDocks())},undock:function(t){if(t.isDocked){var e=null;t.isDocked=!1;var i=!0;(t.top||t.bottom)&&(i=!1);var s=t.getTopMost();if(s==t&&(s=t.bottom),t.breakSideJoints(),i){if(t.dockPosition==MT.LEFT)for(var o=0;o<this.panels.length;o++)e=this.panels[o],(e.dockPosition==MT.BOTTOM||e.dockPosition==MT.TOP)&&t.x+t.width==e.x&&(e.x-=t.width,e.width+=t.width);if(t.dockPosition==MT.RIGHT)for(var o=0;o<this.panels.length;o++)e=this.panels[o],(e.dockPosition==MT.BOTTOM||e.dockPosition==MT.TOP)&&t.x==e.x+e.width&&(e.width+=t.width);if(t.dockPosition==MT.TOP)for(var o=0;o<this.panels.length;o++)e=this.panels[o],(e.dockPosition==MT.LEFT||e.dockPosition==MT.RIGHT)&&t.y+t.height==e.y&&(e.y-=t.height,e.height+=t.height);if(t.dockPosition==MT.BOTTOM)for(var o=0;o<this.panels.length;o++)e=this.panels[o],(e.dockPosition==MT.LEFT||e.dockPosition==MT.RIGHT)&&t.y==e.y+e.height&&(e.height+=t.height)}t.loadBox(),t.dockPosition=MT.NONE,(t.x>this.events.mouse.x||t.x+t.width<this.events.mouse.x)&&(t.x=this.events.mouse.x-.3*t.width),this.moveDocks()}},loadLayout:function(t,e){void 0!=e&&(this.saveSlot=e),console.log("loading from slot",this.saveSlot);var i=this.resetLayout(this.saveSlot,!0);return this._loadLayout(i,!0),(t=t||JSON.parse(localStorage.getItem(this.keyPrefix+this.saveSlot)))?(this._loadLayout(t,!0),this._loadLayout(t,!0),this._loadLayout(t,!0),this.updateZ(),void this.reloadSize()):void this.resetLayout(this.saveSlot)},_loadLayout:function(t,e){this._centerPanels.length=0;var i=null,s=null;this.box=t.__box,this.oldScreenSize.width=t.__oldScreenSize.width,this.oldScreenSize.height=t.__oldScreenSize.height;var o=[];if(e)for(var a=0;a<this.panels.length;a++)this.panels[a].hasClass("animated")&&(o.push(this.panels[a]),this.panels[a].removeClass("animated"));var n=[];for(var a in t)i=t[a],i.name=a,s=this.getByName(a),s&&(s.reset(i),n.push({p:s,o:i}));for(var h=!1,r=null,a=0;a<n.length;a++)if(s=n[a].p,i=n[a].o,s.savedBox=i.savedBox,i.isVisible){h=!1;for(var l=0;l<i.joints.length;l++)r=this.getByName(i.joints[l]),r&&(r!=s?h?s.addJoint(r):r.addJoint(s):h=!0)}else s.hide(!1,!0);for(var a=0;a<n.length;a++){s=n[a].p,i=n[a].o;var c=this.getByName(i.bottom);c&&(c.isVisible||(c=c.getVisibleJoint())),c&&s.joinBottom(c,!0),c=this.getByName(i.top),c&&(c.isVisible||(c=c.getVisibleJoint())),c&&s.joinTop(c,!0),s.isVisible&&s.header.showTabs(),s.dockPosition=i.dockPosition,i.dockPosition==MT.CENTER&&this.setCenter(s)}for(var a=0;a<o.length;a++)o[a].addClass("animated")},resetLayout:function(t,e){var i={__box:{x:40,y:29,width:804,height:382,name:"__box"},__oldScreenSize:{width:1075,height:674},SourceEditor:{x:40,y:29,width:764,height:353,dockPosition:5,isVisible:!1,savedBox:{x:0,y:0,width:0,height:0},isDocked:!0},physics:{x:804,y:451.125,width:271,height:222.875,dockPosition:2,isVisible:!1,savedBox:{x:0,y:0,width:0,height:0},isDocked:!0},Assets:{x:804,y:29,width:271,height:186.25,dockPosition:2,isVisible:!0,savedBox:{x:0,y:0,width:250,height:400},isDocked:!0,joints:["Assets"],top:null,bottom:"Objects"},"Map editor":{x:40,y:29,width:764,height:353,dockPosition:5,isVisible:!0,savedBox:{x:0,y:0,width:0,height:0},isDocked:!0,joints:["Map editor","SourceEditor"],top:null,bottom:null},toolbox:{x:0,y:29,width:40,height:645,dockPosition:1,isVisible:!0,savedBox:{x:0,y:0,width:40,height:400},isDocked:!0,joints:["toolbox"],top:null,bottom:null},Project:{x:0,y:0,width:1075,height:29,dockPosition:3,isVisible:!0,savedBox:{x:0,y:0,width:250,height:29},isDocked:!0,joints:["Project"],top:null,bottom:null},userData:{x:804,y:451.125,width:271,height:222.875,dockPosition:2,isVisible:!1,savedBox:{x:0,y:0,width:0,height:0},isDocked:!0},timeline:{x:40,y:382,width:764,height:266,dockPosition:4,isVisible:!1,savedBox:{x:0,y:0,width:250,height:400},isDocked:!0},Easing:{x:804,y:451.125,width:271,height:222.875,dockPosition:2,isVisible:!1,savedBox:{x:0,y:0,width:0,height:0},isDocked:!0},"Map Manager":{x:40,y:648,width:764,height:26,dockPosition:4,isVisible:!0,savedBox:{x:0,y:0,width:250,height:26},isDocked:!0,joints:["Map Manager"],top:null,bottom:null},Objects:{x:804,y:215.25,width:271,height:235.875,dockPosition:2,isVisible:!0,savedBox:{x:0,y:0,width:250,height:400},isDocked:!0,joints:["Objects"],top:"Assets",bottom:"Settings"},Settings:{x:804,y:451.125,width:271,height:222.875,dockPosition:2,isVisible:!0,savedBox:{x:0,y:0,width:250,height:400},isDocked:!0,joints:["Settings","physics","userData","Easing"],top:"Objects",bottom:null},assetPreview:{x:40,y:382,width:764,height:266,dockPosition:4,isVisible:!0,savedBox:{x:0,y:0,width:250,height:400},isDocked:!0,joints:["assetPreview","timeline"],top:null,bottom:null},color:{x:656,y:411,width:305,height:200,dockPosition:0,isVisible:!1,savedBox:{x:0,y:0,width:305,height:200},isDocked:!1},Text:{x:40,y:29,width:764,height:30,dockPosition:0,isVisible:!1,savedBox:{x:0,y:0,width:944,height:30},isDocked:!1}};if(1==e)return i;var s=JSON.stringify(i);if(void 0!=t)localStorage.setItem(this.keyPrefix+t,s);else for(var o,a=0;a<localStorage.length;a++)o=localStorage.key(a),o.substring(0,this.keyPrefix.length)==this.keyPrefix&&localStorage.setItem(o,s);return this.loadLayout(i),i},saveLayout:function(t){if(this.refresh(),void 0!=t&&(this.saveSlot=t),this.isSaveAllowed){for(var e={__box:this.box,__oldScreenSize:this.oldScreenSize},i=null,s=0;s<this.panels.length;s++)i=this.panels[s],i._parent==document.body&&(e[i.name]={x:i.x,y:i.y,width:i.width,height:i.height,dockPosition:i.dockPosition,isVisible:i.isVisible,savedBox:i.savedBox,isDocked:i.isDocked},i.isVisible&&(e[i.name].joints=i.getJointNames(),e[i.name].top=i.top?i.top.name:null,e[i.name].bottom=i.bottom?i.bottom.name:null));var o=JSON.stringify(e);localStorage.setItem(this.keyPrefix+this.saveSlot,o)}},getSavedLayout:function(){console.log("toLoad = ",localStorage.getItem(this.keyPrefix+this.saveSlot))},oldScreenSize:{width:0,height:0},reloadSize:function(){var t=window.innerWidth-this.oldScreenSize.width,e=window.innerHeight-this.oldScreenSize.height;this.oldScreenSize.width=window.innerWidth,this.oldScreenSize.height=window.innerHeight,this.box.width+=t,this.box.height+=e;for(var i=null,s=0;s<this.panels.length;s++)i=this.panels[s],i.setTopBottom("justUpdated",!1);for(var s=0;s<this.panels.length;s++)if(i=this.panels[s],!i.justUpdated){if(i.dockPosition==MT.LEFT||i.dockPosition==MT.RIGHT){if(i.bottom)continue;i.height+=e}i.dockPosition==MT.BOTTOM&&(i.y+=e),(i.dockPosition==MT.TOP||i.dockPosition==MT.BOTTOM)&&(i.width+=t),i.dockPosition==MT.RIGHT&&(i.x+=t),i.setAll("justUpdated",!0),i.setTopBottom("justUpdated",!0)}this.moveDocks()},getByName:function(t){for(var e=0;e<this.panels.length;e++)if(this.panels[e].name==t)return this.panels[e];return null}}),MT.namespace("core"),MT.require("plugins.list"),MT.require("core.keys"),MT.require("ui.Popup"),MT.require("ui.Fieldset"),MT.require("plugins.HelpAndSupport"),MT.require("plugins.FontManager"),MT.require("plugins.MapManager"),MT.require("plugins.SourceEditor"),MT.require("plugins.GamePreview"),MT.require("plugins.Physics"),MT.require("plugins.UserData"),MT.require("plugins.TooltipManager"),MT.require("plugins.Notification"),MT.require("plugins.MovieMaker"),MT.require("plugins.Auth"),MT.DROP="drop",MT.extend("core.BasicPlugin").extend("core.Emitter")(MT.core.Project=function(t,e){MT.core.BasicPlugin.call(this,"Project"),this.isReady=!1,this.data={backgroundColor:"#666666",sourceEditor:{fontSize:12}},this.defaultData=JSON.stringify(this.data),window.pp=this,this.plugins={},this.pluginsEnabled=["AssetManager","ObjectManager","MapEditor","Tools","Settings","Export","UndoRedo","Analytics","HelpAndSupport","FontManager","MapManager","SourceEditor","GamePreview","Physics","UserData","TooltipManager","Notification","MovieMaker","Auth"];for(var i=0,s="";i<this.pluginsEnabled.length;i++)s=this.pluginsEnabled[i],this.plugins[s.toLowerCase()]=new MT.plugins[s](this);this.am=this.plugins.assetmanager,this.om=this.plugins.objectmanager,this.map=this.plugins.mapeditor,this.ui=t,this.sub="",this.prefix="p","us."==window.location.hostname.substring(0,3)&&(this.sub="us",this.prefix="u"),this.initSocket(e),this.ui.events.on("hashchange",function(){console.log("hash changed","reload?"),window.location.reload()})},{a_maintenance:function(t){var e=t.seconds,i="System will go down for maintenance in ",s="<p>All your current work in progress has been saved.</p><p>Please wait. Editor will reload automatically.</p>";"new"==t.type&&(i="System is being maintained. Will be back in ",s="<p>Please wait. Editor will reload automatically.</p>");var o=new MT.ui.Popup("Maintenance",i+'<span style="color: red">'+e+"</span> seconds."+s),a=window.setInterval(function(){return e--,0>e?void window.clearInterval(a):void(o.content.innerHTML=i+'<span style="color: red">'+e+"</span> seconds."+s)},1e3)},a_purchaseComplete:function(){var t=new MT.ui.Popup("Payment received","Thank you for supporting MightyEditor!<br />Now you can change project access options.<br />If you don't own the current project (e.g. you have created it without being logged in) you have to make a copy of this project.<br /><br />Reload MightyEditor to make your subscription effective.");t.showClose(),t.addButton("Reload Now",function(){window.location.reload()}),t.addButton("Later",function(){t.hide(!0)})},a_message:function(t){throw new Error(t)},a_selectProject:function(t){this.id=t.id,window.location.hash=t.id,this.path="data/projects/"+t.id,this.a_getProjectInfo(t),this.initUI(this.ui),this.initPlugins(),this.setUpData(),localStorage.setItem(t.id,JSON.stringify(t)),this.copyPopup&&(this.copyPopup.hide(),this.copyPopup=null)},setUpData:function(){document.body.style.backgroundColor=this.data.backgroundColor,this.emit("updateData",this.data)},a_newProject:function(){this.newProject()},a_needUpdate:function(){var t=this,e=new MT.ui.Popup("Update Project","");e.removeHeader(),e.el.style.width="50%",e.el.style.height="40%",e.el.style["min-height"]="200px",e.el.style.top="20%";var i=new MT.ui.Panel("Update Project");i.hide().show(e.content).fitIn(),i.removeBorder();var s=document.createElement("div");s.innerHTML="Enter project title",s.style.margin="20px 10px",i.content.el.appendChild(s);var o={title:"New Game",namespace:"NewGame"},a=new MT.ui.Input(this.ui,{key:"title",type:"text"},o),n=new MT.ui.Input(this.ui,{key:"namespace",type:"text"},o);a.show(i.content.el),n.show(i.content.el),a.enableInput(),a.on("change",function(t){n.setValue(t.replace(/\W/g,""))}),e.addButton("Update",function(){t.send("updateProject",o),e.hide()})},a_getProjectInfo:function(t){for(var e in t)this.data[e]=t[e]},a_goToHome:function(){window.location=window.location.toString().split("#").shift()},copyPopup:null,a_copyInProgress:function(){var t="<p>Please wait. Editor will load a project automatically.</p>",e=new MT.ui.Popup("Copy in progress",t);e.showClose(),this.copyPopup=e},reload:function(){window.location.reload()},newProject:function(){this.plugins.analytics.installUI(this.ui);var t=this,e=new MT.ui.Popup("Welcome to MightyEditor","");e.y=.45*(window.innerHeight-510),e.bg.style.backgroundColor="rgba(10,10,10,0.3)",e.addClass("starting-popup");var i=document.createElement("div");i.className="logo",e.content.appendChild(i);var t=this,s=new MT.ui.Button("Create New Project","new-project",null,function(){t.newProjectNext(),e.off(),e.hide()}),o=new MT.ui.Button("About MightyEditor","docs",null,function(){var t=window.open("about:blank","_newTab");t.opener=null,t.location.href="http://mightyfingers.com/editor-features/"});s.show(e.content),o.show(e.content);var a=this.ui.createPanel("RecentProjects");a.hide(),a.fitIn(),a.removeBorder(),this.plugins.auth.installUI(this.ui),this.plugins.auth.show(a);var n=document.createElement("div");e.content.appendChild(n),n.innerHTML='<span class="label">Recent Projects</span>',n.className="project-list",a.show(n);var h=this.getLocalProjects(),r=this.makeProjectList(h);0==h.length&&""!=this.sub&&(r.innerHTML='<p>If you can\'t see you recent projects - try to click <a href="http://mightyeditor.mightyfingers.com/#no-redirect">here</a></p>'),a.content.el.appendChild(r),e.on("close",function(){t.newProjectNext()})},getLocalProjects:function(){for(var t=[],e=0;e<localStorage.length;e++)key=localStorage.key(e),key.substring(0,this.prefix.length)==this.prefix&&(tmp=JSON.parse(localStorage.getItem(key)),t.push(tmp.id?tmp:{id:key,title:key}));return t},makeProjectList:function(t,e,i){var s=document.createElement("div");s.className="list-content";for(var o,a=0;a<t.length;a++)o=document.createElement("div"),o.className="projectItem",o.innerHTML=t[a].title+" ("+t[a].id+') <span class="remove"></span>',o.project=t[a].id,s.appendChild(o);var n=function(t){localStorage.removeItem(t.target.parentNode.project),t.target.parentNode.parentNode.removeChild(t.target.parentNode)};return s.onclick=function(t){return"remove"==t.target.className?void(e?e(t.target.parentNode.project,function(e){e&&n(t)}):n(t)):void(t.target.project&&(i&&i(t.target.parentNode.project,function(e){e&&n(t)}),t.preventDefault(),window.location.hash=t.target.project))},s},newProjectNext:function(){var t=this,e=new MT.ui.Popup("New Project","");e.removeHeader(),e.el.style.width="50%",e.el.style.height="40%",e.el.style["min-height"]="200px",e.el.style.top="20%";var i=new MT.ui.Panel("New Project");i.hide().show(e.content).fitIn(),i.removeBorder();var s=document.createElement("div");s.innerHTML="Enter project title",s.style.margin="20px 10px",i.content.el.appendChild(s);var o={title:"New Game",namespace:"NewGame"},a=new MT.ui.Input(this.ui,{key:"title",type:"text"},o),n=new MT.ui.Input(this.ui,{key:"namespace",type:"text"},o);a.show(i.content.el),n.show(i.content.el),a.enableInput(),a.on("change",function(t){n.setValue(t.replace(/\W/g,""))}),e.addButton("Create",function(){t.send("newProject",o),e.hide()})},loadProject:function(t){this.send("loadProject",t)},initUI:function(t){var e=this;this.ui=t,this.panel=t.createPanel("Project"),this.panel.height=29,this.panel.removeHeader(),this.panel.isDockable=!0,this.panel.addClass("top"),t.dockToTop(this.panel),this.createSettings(),this.panel.addButton(null,"logo",function(){}),this.list=new MT.ui.List([{label:"Home",className:"",cb:function(){window.location=window.location.toString().split("#")[0]}},{label:"Clone (eu)",className:"",cb:function(){e.clone()}},{label:"Clone (us)",className:"",cb:function(){e.clone(!0)}}],t,!0);this.button=this.panel.addButton("Project",null,function(t){t.stopPropagation(),e.showList()})},clone:function(t){if(""==this.sub&&!t)return void(window.location=window.location.toString()+"-copy");if("us"==this.sub&&t)return void(window.location=window.location.toString()+"-copy");if(""==this.sub&&t){var e=window.location.toString()+"-copy";return e=e.replace("://","://us."),void(window.location=e)}if("us"==this.sub&&!t){var e=window.location.toString()+"-copy";return e=e.replace("://us.","://"),void(window.location=e)}},createSettings:function(){var t=this;this.setInputs={label:new MT.ui.Input(this.ui,{key:"title",type:"text"},this.data),bgColor:new MT.ui.Input(this.ui,{key:"backgroundColor",type:"color"},this.data),srcEdFontSize:new MT.ui.Input(this.ui,{key:"fontSize",type:"number"},this.data.sourceEditor)},this.setInputs.bgColor.on("change",function(t){document.body.style.backgroundColor=t}),this.setInputs.srcEdFontSize.on("change",function(){t.setUpData()}),this.setFields={project:new MT.ui.Fieldset("Project"),ui:new MT.ui.Fieldset("UI"),sourceEditor:new MT.ui.Fieldset("SourceEditor")},this.setPanel=new MT.ui.Panel("Personalise"),this.setPanel.removeBorder(),this.setPanel.fitIn(),MT.ui.addClass(this.setPanel.el,"editor-settings"),this.setPanel.on("show",function(){console.log("pop show"),lastData=JSON.stringify(t.data)}),this.setButtons={resetLayout:new MT.ui.Button("Reset Layout","",null,function(){t.ui.resetLayout()}),reset:new MT.ui.Button("Reset","",null,function(){MT.core.Helper.updateObject(t.data,JSON.parse(t.defaultData)),t.send("saveProjectInfo",t.data),t.emit("updateData",t.data),t.setUpData()}),cancel:new MT.ui.Button("Cancel","",null,function(){t.data=JSON.parse(lastData),t.setInputs.bgColor.setValue(t.data.backgroundColor),t.setInputs.srcEdFontSize.setValue(t.data.sourceEditor.fontSize),t.setUpData()})},this.setInputs.label.show(this.setFields.project.el),this.setInputs.bgColor.show(this.setFields.ui.el),this.setButtons.resetLayout.show(this.setFields.ui.el),this.setInputs.srcEdFontSize.show(this.setFields.sourceEditor.el);for(var e in this.setFields)this.setPanel.content.el.appendChild(this.setFields[e].el),this.setFields[e].addClass("full");this.setPanel.content.el.appendChild(this.setButtons.reset.el);var t=this;this.plugins.auth.on("showProperties",function(e){e.addJoint(t.setPanel),lastData=JSON.stringify(t.data)}),this.plugins.auth.on("hideProperties",function(){t.send("saveProjectInfo",t.data),t.emit("updateData",t.data),t.setUpData()})},showList:function(){this.list.width=150,this.list.y=this.button.el.offsetHeight,this.list.x=this.button.el.offsetLeft-5,this.list.el.style.bottom="initial",this.list.show(document.body)},initPlugins:function(){for(var t in this.plugins)this.plugins[t].initSocket&&this.plugins[t].initSocket(this.socket);for(var t in this.plugins)this.plugins[t].initUI(this.ui);for(var t in this.plugins)this.plugins[t].installUI&&this.plugins[t].installUI(this.ui);var e=this,i=null,s="ui-dragover";this.ui.events.on("dragover",function(t){i&&MT.ui.removeClass(i,s),MT.ui.addClass(t.target,s),i=t.target});var o=function(){i&&(MT.ui.removeClass(i,s),i=null)};this.ui.events.on("dragend",o),this.ui.events.on("dragleave",o),this.ui.events.on(this.ui.events.DROP,function(t){e.handleDrop(t),o()}),this.ui.loadLayout(),this.ui.isSaveAllowed=!0,this.isReady=!0},handleDrop:function(t){var e=t.dataTransfer.files;this.handleFiles(e,t.dataTransfer,t)},handleFiles:function(t,e,i){for(var s=0;s<t.length;s++)e?(entry=e.items[s].getAsEntry?e.items[s].getAsEntry():e.items[s].webkitGetAsEntry(),this.handleEntry(entry,i)):this.handleFile(t.item(s),i)},handleEntry:function(t,e){var i=this;if(t.isFile)t.file(function(s){i.readFile(s,t.fullPath,e)});else if(t.isDirectory){this.send("newFolder",t.fullPath);var s=t.createReader();s.readEntries(function(t){for(var s=0;s<t.length;s++)i.handleEntry(t[s],e)})}},handleFile:function(){},readFile:function(t,e,i){var s=this,o=new FileReader;o.onload=function(){s.emit(MT.DROP,i,{src:o.result,path:e})},o.readAsArrayBuffer(t)},isAction:function(t){if(0===t.indexOf("need-login"))if(this.plugins.auth.isLogged){var e=t.substring("need-login-".length);e?window.location.href=e:window.close()}else{var i=this;window.setTimeout(function(){i.plugins.auth.a_login(function(){window.close()})},0)}},initSocket:function(t){MT.core.BasicPlugin.initSocket.call(this,t);var e=this,i=window.location.hash.substring(1),s=!(""==i||"no-redirect"==i);this.plugins.auth.initSocket(t,function(){e.isAction(i)||s&&e.loadProject(i)}),s||(e.newProject(),this.isReady=!0),this.plugins.auth.installUI(this.ui),this.plugins.auth.standAlone=!0}}),function(t){"use strict";function e(){var e=new MT.Socket,i=!1;e.on("core",function(s){if("open"==s){if(i)return void t.location.reload();t.hideLoading(),new MT.core.Project(new MT.ui.Controller,e)}"close"==s&&(document.body.innerHTML="",i=!0)})}function i(){MT.require("core.Project"),MT.require("ui.Controller"),MT.require("Socket"),MT.onReady(e),t.showLoading&&t.showLoading()}t.MT=createClass("MT");var s="tools.mightyfingers.com:8080";if(t.release&&(s="mightyeditor.mightyfingers.com"),"undefined"!=typeof document){var o=document.createElement("div");o.className="loading",t.showLoading=function(){document.body.className="login",document.body.appendChild(o)},t.hideLoading=function(){document.body.className="",o.parentNode&&o.parentNode.removeChild(o)}}if(t&&t.location){if(t.location.hash.indexOf("-")>0)return void i();if(t.location.host==s)if(""==t.location.hash||"u"==t.location.hash.substring(1,2)){var a=function(e,s){if(202!=s.status&&200!=s.status)return void i();var o=JSON.parse(e);"NA"==o.continent_code?t.location.host="us."+t.location.host:i()};MT.loader.get("/geoip",a)}else i();else"p"==t.location.hash.substring(1,2)&&"us."==t.location.host.substring(0,3)?t.location.host=t.location.host.substring(3):i()}else i()}(window);
//# sourceMappingURL=MT.min.js.map